{% extends "base.html" %}

{% block title %}AI Anahtar Kelime Y√∂netimi{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/twitter-style.css') }}">
{% endblock %}

{% block content %}
<!-- AI Keywords Container with Scrollbar -->
<div class="ai-keywords-container">
    <!-- AI Keywords Header - Twitter Tarzƒ± -->
    <div class="ai-keywords-header">
    <h1 class="ai-keywords-title">
        <i class="fas fa-brain"></i>
        AI Anahtar Kelime Y√∂netimi
    </h1>
</div>

<div class="ai-keywords-content">
    <p style="color: var(--twitter-text-secondary); margin-bottom: 20px; font-size: 14px;">
        Geli≈ümi≈ü yapay zeka haber arama sistemi i√ßin anahtar kelimeleri y√∂netin
    </p>

    <!-- ƒ∞statistikler -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-number">{{ stats.total_categories }}</div>
            <div class="stat-label">Toplam Kategori</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ stats.enabled_categories }}</div>
            <div class="stat-label">Aktif Kategori</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ stats.total_default_keywords + stats.total_user_keywords }}</div>
            <div class="stat-label">Toplam Keyword</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ stats.total_user_keywords }}</div>
            <div class="stat-label">Kullanƒ±cƒ± Keyword</div>
        </div>
    </div>

    <!-- Genel Ayarlar -->
    <div class="ai-keywords-card">
        <div class="ai-keywords-card-header">
            <h3 class="ai-keywords-card-title">
                <i class="fas fa-gear"></i>
                Genel Ayarlar
            </h3>
        </div>
        <div class="ai-keywords-card-body">
            <div class="settings-grid">
                <!-- Toggle Enabled -->
                <div class="form-group">
                    <label for="aiKeywordsEnabled" class="form-label">AI Keyword Aramasƒ±</label>
                    <input id="aiKeywordsEnabled" type="checkbox" class="form-checkbox" {{ 'checked' if config.settings.enabled else '' }} onchange="updateGeneralSetting('enabled', this.checked)">
                </div>
                <!-- Search Time Range -->
                <div class="form-group">
                    <label for="searchTimeRange" class="form-label">Arama Zaman Aralƒ±ƒüƒ± (Saat)</label>
                    <input id="searchTimeRange" type="number" min="1" max="168" value="{{ config.settings.search_time_range_hours }}" class="form-control" onchange="updateGeneralSetting('search_time_range_hours', parseInt(this.value))">
                </div>
                <!-- Max Articles -->
                <div class="form-group">
                    <label for="maxArticles" class="form-label">Maksimum Makale Sayƒ±sƒ±</label>
                    <input id="maxArticles" type="number" min="1" max="50" value="{{ config.settings.max_articles_per_search }}" class="form-control" onchange="updateGeneralSetting('max_articles_per_search', parseInt(this.value))">
                </div>
                <!-- Search Depth -->
                <div class="form-group">
                    <label for="searchDepth" class="form-label">Arama Derinliƒüi</label>
                    <select id="searchDepth" class="form-control" onchange="updateGeneralSetting('search_depth', this.value)">
                        <option value="basic" {{ 'selected' if config.settings.search_depth == 'basic' else '' }}>Temel Arama</option>
                        <option value="deep" {{ 'selected' if config.settings.search_depth == 'deep' else '' }}>Derin Arama</option>
                        <option value="comprehensive" {{ 'selected' if config.settings.search_depth == 'comprehensive' else '' }}>Kapsamlƒ± Arama</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <!-- Kategoriler -->
    <div class="categories-grid">
        {% for category_name, category_data in config.keyword_categories.items() %}
        <div id="category-{{ category_name }}" class="category-card">
            <!-- Header -->
            <div class="category-card-header {{ 'category-disabled' if not category_data.enabled else 'category-enabled' }}">
                <div class="category-name">
                    {% if category_name == 'ai_models' %}ü§ñ AI Modelleri
                    {% elif category_name == 'ai_tools' %}üõ†Ô∏è AI Ara√ßlarƒ±
                    {% elif category_name == 'ai_companies' %}üè¢ AI ≈ûirketleri
                    {% elif category_name == 'ai_technologies' %}‚ö° AI Teknolojileri
                    {% elif category_name == 'ai_applications' %}üì± AI Uygulamalarƒ±
                    {% else %}{{ category_name.title() }}
                    {% endif %}
                </div>
                <span class="priority-badge">{{ category_data.priority.upper() }}</span>
            </div>

            <!-- Body -->
            <div class="category-card-body">
                <p class="category-stats">Varsayƒ±lan: {{ category_data.default_keywords|length }} ‚Ä¢ Kullanƒ±cƒ±: {{ category_data.user_keywords|length }}</p>

                <!-- Default Keywords -->
                <div class="keywords-section">
                    <div class="keywords-title">Varsayƒ±lan Anahtar Kelimeler</div>
                    <div class="keywords-container">
                        {% for keyword in category_data.default_keywords %}
                        <span class="keyword-tag {{ 'keyword-inactive' if keyword in category_data.excluded_keywords else 'keyword-default' }}" onclick="toggleKeywordInCard('{{ category_name }}', '{{ keyword }}')" title="{{ 'Pasif - Tƒ±kla aktifle≈ütir' if keyword in category_data.excluded_keywords else 'Aktif - Tƒ±kla pasifle≈ütir' }}">
                            {{ keyword }}
                        </span>
                        {% endfor %}
                    </div>
                </div>

                <!-- User Keywords -->
                {% if category_data.user_keywords %}
                <div class="keywords-section">
                    <div class="keywords-title">
                        <span>Kullanƒ±cƒ± Anahtar Kelimeleri</span>
                        <button class="delete-all-btn" onclick="showDeleteUserKeywords('{{ category_name }}')">
                            <i class="fas fa-trash"></i>
                            <span>T√ºm√ºn√º Sil</span>
                        </button>
                    </div>
                    <div class="keywords-container">
                        {% for keyword in category_data.user_keywords %}
                        <span class="keyword-tag keyword-user {{ 'keyword-inactive' if keyword in category_data.excluded_keywords else 'keyword-active' }}" onclick="toggleKeywordInCard('{{ category_name }}', '{{ keyword }}')" title="{{ 'Pasif - Tƒ±kla aktifle≈ütir' if keyword in category_data.excluded_keywords else 'Aktif - Tƒ±kla pasifle≈ütir' }}">
                            {{ keyword }}
                            <button class="remove-keyword-btn" onclick="event.stopPropagation(); removeUserKeyword('{{ category_name }}', '{{ keyword }}')" title="Bu kelimeyi sil">
                                <i class="fas fa-times"></i>
                            </button>
                        </span>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                <!-- Add Keyword Form -->
                <form class="add-keyword-form" onsubmit="addUserKeyword('{{ category_name }}');return false;">
                    <input id="newKeyword-{{ category_name }}" type="text" placeholder="Yeni anahtar kelime, virg√ºlle ayƒ±rabilirsiniz" class="form-control" />
                    <button type="submit" class="btn btn-primary">Ekle</button>
                </form>
            </div>

            <!-- Footer Buttons -->
            <div class="category-card-footer">
                <button class="btn btn-secondary" onclick="toggleCategory('{{ category_name }}')">{{ 'Aktif' if category_data.enabled else 'Pasif' }}</button>
                <button class="btn btn-warning" onclick="changePriority('{{ category_name }}')">√ñncelik Deƒüi≈ütir</button>
                <button class="btn btn-danger" onclick="resetCategory('{{ category_name }}')">Sƒ±fƒ±rla</button>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Aktif Anahtar Kelimeler √ñnizleme -->
    <div class="ai-keywords-card" id="activeKeywordsContainer">
        <div class="ai-keywords-card-header">
            <h3 class="ai-keywords-card-title">
                <i class="fas fa-eye"></i>
                Aktif Anahtar Kelimeler
            </h3>
        </div>
        <div class="ai-keywords-card-body">
            <div class="active-keywords-container">
                {% for keyword in active_keywords %}
                <span class="keyword-tag keyword-active" onclick="toggleKeyword('{{ keyword }}')" title="Tƒ±kla ‚Üí hari√ß tut / geri al">{{ keyword }}</span>
                {% endfor %}
            </div>
            <small class="keywords-count">Toplam {{ active_keywords|length }} anahtar kelime aktif</small>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<style>
.alert-modern {
  position: fixed;
  top: 1rem;
  left: 50%;
  transform: translateX(-50%);
  padding: 0.75rem 1.25rem;
  border-radius: 0.5rem;
  box-shadow: 0 4px 10px rgba(0,0,0,0.05);
  display: flex;
  align-items: center;
  gap: 0.5rem;
  font-weight: 500;
  z-index: 100;
  transition: opacity 0.3s ease;
}
.alert-success {
  background: #dcfce7;
  color: #166534;
}
.alert-error {
  background: #fee2e2;
  color: #991b1b;
}
</style>
<script>
function showLoading() {
    document.getElementById('loadingOverlay').style.display = 'flex';
}

function hideLoading() {
    document.getElementById('loadingOverlay').style.display = 'none';
}

function showAlert(message, type = 'success') {
    const alertClass = type === 'error' ? 'alert-error' : 'alert-success';
    const alertIcon = type === 'error' ? '‚ùå' : '‚úÖ';
    const alertHtml = `
        <div class="alert-modern ${alertClass}" id="tempAlert">
            <span>${alertIcon}</span>
            ${message}
        </div>
    `;
    const existingAlert = document.getElementById('tempAlert');
    if (existingAlert) existingAlert.remove();
    document.body.insertAdjacentHTML('afterbegin', alertHtml);
    window.scrollTo({top: 0, behavior: 'smooth'});
    setTimeout(() => {
        const alert = document.getElementById('tempAlert');
        if (alert) {
            alert.style.opacity = '0';
            setTimeout(() => alert.remove(), 300);
        }
    }, 4000);
}

function updateGeneralSetting(key, value) {
    showLoading();
    
    const settings = {};
    settings[key] = value;
    
    fetch('/api/ai_keywords/save_settings', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ settings: settings })
    })
    .then(response => response.json())
    .then(data => {
        hideLoading();
        if (data.success) {
            showAlert(data.message);
        } else {
            showAlert(data.error, 'error');
        }
    })
    .catch(error => {
        hideLoading();
        showAlert('Ayar g√ºncelleme hatasƒ±: ' + error, 'error');
    });
}

function toggleCategory(categoryName) {
    showLoading();
    
    fetch('/api/ai_keywords/update', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            category: categoryName,
            action: 'toggle_enabled'
        })
    })
    .then(response => response.json())
    .then(data => {
        hideLoading();
        if (data.success) {
            showAlert(data.message);
            setTimeout(() => location.reload(), 1000);
        } else {
            showAlert(data.error, 'error');
        }
    })
    .catch(error => {
        hideLoading();
        showAlert('Kategori g√ºncelleme hatasƒ±: ' + error, 'error');
    });
}

function changePriority(categoryName) {
    const priorities = ['high', 'medium', 'low'];
    const currentPriority = document.querySelector(`#category-${categoryName} .priority-badge`).textContent.toLowerCase();
    const currentIndex = priorities.indexOf(currentPriority);
    const newPriority = priorities[(currentIndex + 1) % priorities.length];
    
    showLoading();
    
    fetch('/api/ai_keywords/update', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            category: categoryName,
            action: 'set_priority',
            keyword: newPriority
        })
    })
    .then(response => response.json())
    .then(data => {
        hideLoading();
        if (data.success) {
            showAlert(data.message);
            setTimeout(() => location.reload(), 1000);
        } else {
            showAlert(data.error, 'error');
        }
    })
    .catch(error => {
        hideLoading();
        showAlert('√ñncelik g√ºncelleme hatasƒ±: ' + error, 'error');
    });
}

function resetCategory(categoryName) {
    if (!confirm(`${categoryName} kategorisini varsayƒ±lan ayarlara sƒ±fƒ±rlamak istediƒüinizden emin misiniz?`)) {
        return;
    }
    
    showLoading();
    
    fetch('/api/ai_keywords/reset_category', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            category: categoryName
        })
    })
    .then(response => response.json())
    .then(data => {
        hideLoading();
        if (data.success) {
            showAlert(data.message);
            setTimeout(() => location.reload(), 1000);
        } else {
            showAlert(data.error, 'error');
        }
    })
    .catch(error => {
        hideLoading();
        showAlert('Sƒ±fƒ±rlama hatasƒ±: ' + error, 'error');
    });
}

function addUserKeyword(categoryName) {
    const input = document.getElementById(`newKeyword-${categoryName}`);
    const keywords = input.value.trim();
    
    if (!keywords) {
        showAlert('L√ºtfen anahtar kelime girin', 'error');
        return;
    }
    
    // Virg√ºlle ayrƒ±lmƒ±≈ü keywordleri i≈üle
    const keywordList = keywords.split(',').map(k => k.trim()).filter(k => k);
    
    if (keywordList.length === 0) {
        showAlert('Ge√ßerli anahtar kelime bulunamadƒ±', 'error');
        return;
    }
    
    showLoading();
    
    // Her keyword i√ßin ayrƒ± istek g√∂nder
    const promises = keywordList.map(keyword => 
        fetch('/api/ai_keywords/update', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                category: categoryName,
                action: 'add_user_keyword',
                keyword: keyword
            })
        }).then(response => response.json())
    );
    
    Promise.all(promises)
    .then(results => {
        hideLoading();
        const successful = results.filter(r => r.success).length;
        const failed = results.filter(r => !r.success).length;
        
        if (successful > 0) {
            showAlert(`${successful} anahtar kelime ba≈üarƒ±yla eklendi${failed > 0 ? `, ${failed} ba≈üarƒ±sƒ±z` : ''}`);
            input.value = '';
            setTimeout(() => location.reload(), 1000);
        } else {
            showAlert('Anahtar kelime ekleme ba≈üarƒ±sƒ±z', 'error');
        }
    })
    .catch(error => {
        hideLoading();
        showAlert('Anahtar kelime ekleme hatasƒ±: ' + error, 'error');
    });
}

function removeUserKeyword(categoryName, keyword) {
    if (!confirm(`"${keyword}" anahtar kelimesini kaldƒ±rmak istediƒüinizden emin misiniz?`)) {
        return;
    }
    
    showLoading();
    
    fetch('/api/ai_keywords/update', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            category: categoryName,
            action: 'remove_user_keyword',
            keyword: keyword
        })
    })
    .then(response => response.json())
    .then(data => {
        hideLoading();
        if (data.success) {
            showAlert(data.message);
            
            // Keyword etiketini sayfadan kaldƒ±r
            removeKeywordFromUI(categoryName, keyword);
            
            // Aktif keyword listesini g√ºncelle
            if (data.active_keywords) {
                updateActiveKeywordsList(data.active_keywords);
            }
            
            // ƒ∞statistikleri g√ºncelle
            if (data.stats) {
                updateStatsDisplay(data.stats);
            }
        } else {
            showAlert(data.error, 'error');
        }
    })
    .catch(error => {
        hideLoading();
        showAlert('Anahtar kelime kaldƒ±rma hatasƒ±: ' + error, 'error');
    });
}

function removeKeywordFromUI(categoryName, keyword) {
    const categoryCard = document.getElementById(`category-${categoryName}`);
    if (!categoryCard) return;
    
    // Keyword etiketini bul ve kaldƒ±r
    const keywordSpans = categoryCard.querySelectorAll('span[onclick*="toggleKeywordInCard"]');
    keywordSpans.forEach(span => {
        const spanText = span.textContent.trim().replace('√ó', '').trim();
        if (spanText === keyword) {
            span.remove();
        }
    });
}

function addToExcluded(categoryName, keyword) {
    if (!confirm(`"${keyword}" anahtar kelimesini hari√ß tutmak istediƒüinizden emin misiniz?`)) {
        return;
    }
    
    showLoading();
    
    fetch('/api/ai_keywords/update', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            category: categoryName,
            action: 'add_excluded_keyword',
            keyword: keyword
        })
    })
    .then(response => response.json())
    .then(data => {
        hideLoading();
        if (data.success) {
            showAlert(data.message);
            setTimeout(() => location.reload(), 1000);
        } else {
            showAlert(data.error, 'error');
        }
    })
    .catch(error => {
        hideLoading();
        showAlert('Hari√ß tutma hatasƒ±: ' + error, 'error');
    });
}

function removeFromExcluded(categoryName, keyword) {
    showLoading();
    
    fetch('/api/ai_keywords/update', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            category: categoryName,
            action: 'remove_excluded_keyword',
            keyword: keyword
        })
    })
    .then(response => response.json())
    .then(data => {
        hideLoading();
        if (data.success) {
            showAlert(data.message);
            setTimeout(() => location.reload(), 1000);
        } else {
            showAlert(data.error, 'error');
        }
    })
    .catch(error => {
        hideLoading();
        showAlert('Hari√ß tutmayƒ± kaldƒ±rma hatasƒ±: ' + error, 'error');
    });
}

function testAIKeywords() {
    showLoading();
    document.getElementById('testResults').style.display = 'none';
    
    fetch('/api/ai_keywords/test_search')
    .then(response => response.json())
    .then(data => {
        hideLoading();
        
        const testContent = document.getElementById('testContent');
        
        if (data.success) {
            let html = `
                <div class="alert alert-success">
                    ‚úÖ Test ba≈üarƒ±lƒ±! ${data.articles_found} makale bulundu.
                </div>
            `;
            
            if (data.articles && data.articles.length > 0) {
                html += '<h6>üì∞ Bulunan Makaleler (ƒ∞lk 5):</h6><ul>';
                data.articles.forEach(article => {
                    html += `
                        <li>
                            <strong>${article.title}</strong><br>
                            <small class="text-muted">${article.url}</small><br>
                            <small class="text-info">Keywords: ${article.matching_keywords ? article.matching_keywords.join(', ') : 'N/A'}</small>
                        </li>
                    `;
                });
                html += '</ul>';
            }
            
            testContent.innerHTML = html;
            showAlert('AI Keywords test ba≈üarƒ±yla tamamlandƒ±!');
        } else {
            testContent.innerHTML = `
                <div class="alert alert-danger">
                    ‚ùå Test ba≈üarƒ±sƒ±z: ${data.error}
                </div>
            `;
            showAlert('Test ba≈üarƒ±sƒ±z: ' + data.error, 'error');
        }
        
        document.getElementById('testResults').style.display = 'block';
    })
    .catch(error => {
        hideLoading();
        showAlert('Test hatasƒ±: ' + error, 'error');
    });
}

function refreshStats() {
    showLoading();
    
    fetch('/api/ai_keywords/stats')
    .then(response => response.json())
    .then(data => {
        hideLoading();
        if (data.success) {
            showAlert('ƒ∞statistikler g√ºncellendi');
            setTimeout(() => location.reload(), 1000);
        } else {
            showAlert('ƒ∞statistik g√ºncelleme hatasƒ±: ' + data.error, 'error');
        }
    })
    .catch(error => {
        hideLoading();
        showAlert('ƒ∞statistik yenileme hatasƒ±: ' + error, 'error');
    });
}

function toggleKeyword(keyword){
    showLoading();
    fetch('/api/ai_keywords/toggle_keyword',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({keyword:keyword})
    }).then(r=>r.json()).then(d=>{
        hideLoading();
        if(d.success){
            // Mesaj g√∂sterme - sadece renk deƒüi≈üimi yeterli
            // Aktif keyword listesini g√ºncelle
            updateActiveKeywordsList(d.active_keywords || []);
            // ƒ∞statistikleri g√ºncelle
            if (d.stats) {
                updateStatsDisplay(d.stats);
            }
        }else{
            showAlert(d.error,'error');
        }
    }).catch(e=>{hideLoading();showAlert('Anahtar kelime deƒüi≈ütirme hatasƒ±: '+e,'error');});
}

function toggleKeywordInCard(categoryName, keyword) {
    console.log('toggleKeywordInCard called:', categoryName, keyword);
    showLoading();
    
    fetch('/api/ai_keywords/toggle_keyword', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            category: categoryName,
            keyword: keyword
        })
    })
    .then(response => response.json())
    .then(data => {
        console.log('API Response:', data);
        hideLoading();
        if (data.success) {
            // Mesaj g√∂sterme - sadece renk deƒüi≈üimi yeterli
            
            // Tƒ±klanan etiketi g√∂rsel olarak g√ºncelle (sayfa yenilemeden)
            updateKeywordVisualState(categoryName, keyword, data.is_active);
            
            // Aktif keyword listesini g√ºncelle
            updateActiveKeywordsList(data.active_keywords || []);
            
            // ƒ∞statistikleri g√ºncelle
            if (data.stats) {
                updateStatsDisplay(data.stats);
            }
        } else {
            showAlert(data.error, 'error');
        }
    })
    .catch(error => {
        console.error('API Error:', error);
        hideLoading();
        showAlert('Anahtar kelime kontrol hatasƒ±: ' + error, 'error');
    });
}

function updateKeywordVisualState(categoryName, keyword, isActive) {
    // Kategori kartƒ±ndaki keyword etiketini bul ve rengini g√ºncelle
    const categoryCard = document.getElementById(`category-${categoryName}`);
    if (!categoryCard) return;
    
    // T√ºm keyword etiketlerini bul
    const keywordSpans = categoryCard.querySelectorAll('span[onclick*="toggleKeywordInCard"]');
    
    keywordSpans.forEach(span => {
        // Span i√ßindeki text'i al (X butonunu √ßƒ±kar)
        const spanText = span.textContent.trim().replace('√ó', '').trim();
        
        if (spanText === keyword) {
            // Renk sƒ±nƒ±flarƒ±nƒ± temizle
            span.classList.remove('keyword-default', 'keyword-inactive', 'keyword-user', 'keyword-active');
            
            // Kullanƒ±cƒ± kelimesi mi varsayƒ±lan kelime mi?
            const isUserKeyword = span.closest('.keywords-section').previousElementSibling?.textContent.includes('Kullanƒ±cƒ±');
            
            if (isActive) {
                // Aktif g√∂r√ºn√ºm
                if (isUserKeyword) {
                    // Kullanƒ±cƒ± kelimesi
                    span.classList.add('keyword-user', 'keyword-active');
                } else {
                    // Varsayƒ±lan kelime
                    span.classList.add('keyword-default', 'keyword-active');
                }
                span.title = 'Aktif - Tƒ±kla pasifle≈ütir';
            } else {
                // Pasif g√∂r√ºn√ºm
                if (isUserKeyword) {
                    // Kullanƒ±cƒ± kelimesi
                    span.classList.add('keyword-user', 'keyword-inactive');
                } else {
                    // Varsayƒ±lan kelime
                    span.classList.add('keyword-default', 'keyword-inactive');
                }
                span.title = 'Pasif - Tƒ±kla aktifle≈ütir';
            }
        }
    });
}

function updateActiveKeywordsList(activeKeywords) {
    const container = document.querySelector('#activeKeywordsContainer .active-keywords-container');
    if (container) {
        container.innerHTML = '';
        
        // T√ºm aktif kelimeleri g√∂ster (sƒ±nƒ±r yok)
        activeKeywords.forEach(keyword => {
            const span = document.createElement('span');
            span.className = 'keyword-tag keyword-active';
            span.onclick = () => toggleKeyword(keyword);
            span.title = 'Tƒ±kla ‚Üí hari√ß tut / geri al';
            span.textContent = keyword;
            container.appendChild(span);
        });
        
        // Toplam sayƒ±yƒ± g√ºncelle
        const totalElement = container.nextElementSibling;
        if (totalElement && totalElement.tagName === 'SMALL') {
            totalElement.textContent = `Toplam ${activeKeywords.length} anahtar kelime aktif`;
        }
    }
}

function updateStatsDisplay(stats) {
    // ƒ∞statistik kartlarƒ±nƒ± g√ºncelle
    const statCards = document.querySelectorAll('.stats-grid .stat-number');
    if (statCards.length >= 4) {
        statCards[0].textContent = stats.total_categories || 0;
        statCards[1].textContent = stats.enabled_categories || 0;
        statCards[2].textContent = (stats.total_default_keywords || 0) + (stats.total_user_keywords || 0);
        statCards[3].textContent = stats.total_user_keywords || 0;
    }
}

function showDeleteUserKeywords(categoryName) {
    // Bu kategorideki kullanƒ±cƒ± kelimelerini al (sayfa yenilenecek)
    showLoading();
    fetch('/api/ai_keywords/config')
    .then(r => r.json())
    .then(data => {
        hideLoading();
        if (!data.success) {
            showAlert('Yapƒ±landƒ±rma alƒ±namadƒ±', 'error');
            return;
        }
        const userKeywords = data.config.keyword_categories[categoryName].user_keywords || [];
        
        if (userKeywords.length === 0) {
            showAlert('Bu kategoride kullanƒ±cƒ± kelimesi yok', 'error');
            return;
        }
        
        const keywordList = userKeywords.map(kw => `‚Ä¢ ${kw}`).join('\n');
        if (confirm(`${categoryName} kategorisindeki kullanƒ±cƒ± kelimelerini silmek istediƒüinizden emin misiniz?\n\n${keywordList}`)) {
            showLoading();
            
            const promises = userKeywords.map(keyword => 
                fetch('/api/ai_keywords/update', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        category: categoryName,
                        action: 'remove_user_keyword',
                        keyword: keyword
                    })
                }).then(r => r.json())
            );
            
            Promise.all(promises).then(results => {
                hideLoading();
                const successful = results.filter(r => r.success).length;
                showAlert(`${successful} kullanƒ±cƒ± kelimesi silindi`);
                setTimeout(() => location.reload(), 1000);
            }).catch(e => {
                hideLoading();
                showAlert('Silme hatasƒ±: ' + e, 'error');
            });
        }
    })
    .catch(e => {
        hideLoading();
        showAlert('Yapƒ±landƒ±rma alma hatasƒ±: ' + e, 'error');
    });
}

function testClick() {
    showAlert('Test tƒ±klama √ßalƒ±≈üƒ±yor!', 'info');
}

// Enter tu≈üu ile keyword ekleme
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('[id^="newKeyword-"]').forEach(input => {
        input.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                const categoryName = this.id.replace('newKeyword-', '');
                addUserKeyword(categoryName);
            }
        });
    });
});
</script>
</div>
{% endblock %} 