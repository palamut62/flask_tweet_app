{% extends "base.html" %}

{% block title %}Şifre Yöneticisi - AI Tweet Bot{% endblock %}

{% block extra_css %}
<style>
/* Simple Password Manager Styles */
.password-manager-container {
    width: 100%;
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
    min-height: 100vh;
    background: var(--twitter-background);
}

/* Simple Cards */
.simple-card {
    background: var(--twitter-background);
    border-radius: 8px;
    border: 1px solid var(--twitter-border);
    padding: 20px;
    margin-bottom: 20px;
    color: var(--twitter-text);
    transition: all 0.2s ease;
}

.simple-card:hover {
    border-color: var(--twitter-blue);
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

/* Simple Header */
.page-header {
    text-align: center;
    margin-bottom: 30px;
    color: var(--twitter-text);
}

.page-header h1 {
    font-size: 2rem;
    font-weight: 600;
    margin-bottom: 10px;
    color: var(--twitter-text);
}

.page-header .lead {
    font-size: 1rem;
    color: var(--twitter-text-secondary);
    font-weight: 400;
}

/* Simple Status */
.stats-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.stat-item {
    text-align: center;
    padding: 15px;
}

.stat-item h4 {
    font-size: 1.1rem;
    margin-bottom: 10px;
    font-weight: 500;
    color: var(--twitter-text-secondary);
}

.stat-number {
    font-size: 2rem;
    font-weight: 600;
    color: var(--twitter-blue);
}

/* Simple Buttons */
.btn-simple {
    background: var(--twitter-blue);
    border: 1px solid var(--twitter-blue);
    color: white;
    border-radius: 6px;
    padding: 8px 16px;
    font-weight: 500;
    transition: all 0.2s ease;
}

.btn-simple:hover {
    background: #1a91da;
    border-color: #1a91da;
    color: white;
}

.btn-secondary-simple {
    background: var(--twitter-light-gray);
    border: 1px solid var(--twitter-border);
    color: var(--twitter-text);
    border-radius: 6px;
    padding: 8px 16px;
    font-weight: 500;
    transition: all 0.2s ease;
}

.btn-secondary-simple:hover {
    background: #e8f4fd;
    border-color: var(--twitter-blue);
    color: var(--twitter-text);
}

.btn-danger-simple {
    background: #dc3545;
    border: 1px solid #dc3545;
    color: white;
    border-radius: 6px;
    padding: 8px 16px;
    font-weight: 500;
    transition: all 0.2s ease;
}

.btn-danger-simple:hover {
    background: #c82333;
    border-color: #c82333;
    color: white;
}

.btn-secondary-simple:disabled {
    background: #e9ecef;
    border-color: #dee2e6;
    color: #6c757d;
    cursor: not-allowed;
    opacity: 0.6;
}

.btn-secondary-simple:disabled:hover {
    background: #e9ecef;
    border-color: #dee2e6;
    color: #6c757d;
    transform: none;
}

/* Simple Icons */
.item-icon {
    width: 40px;
    height: 40px;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    margin-right: 15px;
    background: var(--twitter-blue);
    color: white;
    flex-shrink: 0;
}

/* Simple Forms */
.form-simple {
    background: var(--twitter-background);
    border: 1px solid var(--twitter-border);
    border-radius: 6px;
    color: var(--twitter-text);
    padding: 8px 12px;
    transition: all 0.2s ease;
    font-size: 1rem;
    width: 100%;
}

.form-simple:focus {
    background: var(--twitter-background);
    border-color: var(--twitter-blue);
    color: var(--twitter-text);
    box-shadow: 0 0 0 2px rgba(29, 161, 242, 0.2);
    outline: none;
}

.form-simple::placeholder {
    color: var(--twitter-text-secondary);
}

/* Simple Content Grid */
.content-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 30px;
    margin-top: 30px;
}

@media (max-width: 768px) {
    .content-grid {
        grid-template-columns: 1fr;
        gap: 20px;
    }
}

.section-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 20px;
}

.section-header h3 {
    color: var(--twitter-text);
    font-weight: 600;
    font-size: 1.2rem;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 8px;
}

.item-count {
    background: var(--twitter-light-gray);
    color: var(--twitter-text-secondary);
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 0.8rem;
    font-weight: 500;
}

/* Simple Items */
.password-item, .card-item {
    background: var(--twitter-background);
    border: 1px solid var(--twitter-border);
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 12px;
    transition: all 0.2s ease;
    color: var(--twitter-text);
}

.password-item:hover, .card-item:hover {
    border-color: var(--twitter-blue);
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.item-header {
    display: flex;
    align-items: center;
    margin-bottom: 12px;
}

.item-title {
    flex: 1;
}

.item-title h5 {
    margin: 0 0 4px 0;
    font-size: 1rem;
    font-weight: 600;
    color: var(--twitter-text);
}

.item-title small {
    color: var(--twitter-text-secondary);
    font-size: 0.8rem;
}

.item-actions {
    display: flex;
    gap: 8px;
}

.item-details {
    display: grid;
    gap: 8px;
}

.item-details p {
    margin: 0;
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 0.9rem;
}

.item-details strong {
    min-width: 80px;
    color: var(--twitter-text-secondary);
    font-weight: 500;
}

.item-details code {
    background: var(--twitter-light-gray);
    padding: 2px 6px;
    border-radius: 4px;
    font-family: monospace;
    font-size: 0.8rem;
    border: 1px solid var(--twitter-border);
}

.btn-sm {
    padding: 4px 8px;
    font-size: 0.8rem;
}

.empty-state {
    text-align: center;
    padding: 40px 20px;
    color: var(--twitter-text-secondary);
}

.empty-state i {
    font-size: 3rem;
    margin-bottom: 15px;
    opacity: 0.5;
}

.empty-state h5 {
    margin-bottom: 10px;
    color: var(--twitter-text);
}

.add-buttons {
    display: flex;
    gap: 10px;
    justify-content: center;
    margin-top: 20px;
}

/* Floating Action Buttons */
.fab-container {
    position: fixed;
    bottom: 40px;
    right: 40px;
    display: flex;
    flex-direction: column;
    gap: 15px;
    z-index: 1000;
}

.fab {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    border: none;
    color: white;
    font-size: 20px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
}

.fab:hover {
    transform: scale(1.1);
    box-shadow: 0 6px 20px rgba(0,0,0,0.4);
}

.fab-add-password {
    background: var(--twitter-blue);
}

.fab-add-card {
    background: #28a745;
}

/* Responsive */
@media (max-width: 768px) {
    .password-manager-container {
        padding: 15px;
    }
    
    .page-header h1 {
        font-size: 1.8rem;
    }
    
    .stats-row {
        grid-template-columns: 1fr;
        gap: 15px;
    }
    
    .fab-container {
        bottom: 25px;
        right: 25px;
    }
    
    .fab {
        width: 50px;
        height: 50px;
        font-size: 18px;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="password-manager-container">

    <!-- Page Header -->
    <div class="page-header">
        <h1><i class="fas fa-shield-alt"></i> Şifre Yöneticisi</h1>
        <p class="lead">Güvenli şifre ve kart depolama sistemi</p>
    </div>

    <!-- Stats Dashboard -->
    <div class="simple-card">
        <div class="stats-row">
            <div class="stat-item">
                <h4><i class="fas fa-key"></i> Şifreler</h4>
                <div class="stat-number">{{ passwords|length if passwords else 0 }}</div>
                </div>
            <div class="stat-item">
                <h4><i class="fas fa-credit-card"></i> Kartlar</h4>
                <div class="stat-number">{{ cards|length if cards else 0 }}</div>
            </div>
            <div class="stat-item">
                <h4><i class="fas fa-shield-alt"></i> Durum</h4>
                <div class="stat-number">{{ 'Aktif' if master_password else 'Pasif' }}</div>
            </div>
        </div>
    </div>

    <!-- Master Password Setup -->
    {% if not master_password %}
    <div class="simple-card">
        <h3><i class="fas fa-lock"></i> Ana Parola Ayarlama</h3>
        <p style="color: var(--twitter-text-secondary);">Şifrelerinizi şifrelemek için bir ana parola belirleyin.</p>
        <form method="POST" action="{{ url_for('set_master_password') }}" class="row g-3" id="masterPasswordForm">
            <div class="col-md-8">
                <input type="password" name="master_password" class="form-simple" 
                       placeholder="Ana parola (min. 6 karakter)" required minlength="6" id="masterPasswordInput">
            </div>
            <div class="col-md-4">
                <button type="submit" class="btn btn-simple w-100">
                    <i class="fas fa-save"></i> Kaydet
                </button>
            </div>
        </form>
    </div>
    {% endif %}

    <!-- Content Grid -->
    <div class="content-grid">
        <!-- Passwords Section -->
        <div class="content-section">
            <div class="section-header">
                <h3><i class="fas fa-key"></i> Şifreler</h3>
                <span class="item-count">{{ passwords|length if passwords else 0 }}</span>
            </div>
            
                {% if passwords %}
                    {% for password in passwords %}
                <div class="password-item">
                    <div class="item-header">
                        <div class="item-icon">
                                    <i class="fas fa-globe"></i>
                            </div>
                        <div class="item-title">
                            <h5>{{ password.site_name }}</h5>
                            <small>{{ password.created_at[:10] if password.created_at else '' }}</small>
                            </div>
                        <div class="item-actions">
                            <button class="btn btn-sm btn-simple" onclick="copyToClipboard('{{ password.username|e }}', 'Kullanıcı adı')">
                                <i class="fas fa-user"></i>
                                </button>
                            <button class="btn btn-sm btn-simple" onclick="copyToClipboard('{{ password.password|e }}', 'Şifre')">
                                <i class="fas fa-copy"></i>
                            </button>
                            <button class="btn btn-sm btn-danger-simple" onclick="deletePassword('{{ password.site_name }}')">
                                <i class="fas fa-trash"></i>
                            </button>
                            </div>
                        </div>
                        
                    <div class="item-details">
                        <p><strong>Kullanıcı:</strong> <code>{{ password.username }}</code></p>
                        <p><strong>Şifre:</strong> <code>{{ password.password }}</code></p>
                        {% if password.notes %}
                        <p><strong>Notlar:</strong> {{ password.notes }}</p>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                <div class="empty-state">
                    <i class="fas fa-key"></i>
                        <h5>Henüz şifre eklenmemiş</h5>
                    <p>İlk şifrenizi eklemek için + butonuna tıklayın.</p>
                    </div>
                {% endif %}
        </div>

        <!-- Cards Section -->
        <div class="content-section">
            <div class="section-header">
                <h3><i class="fas fa-credit-card"></i> Kartlar</h3>
                <span class="item-count">{{ cards|length if cards else 0 }}</span>
            </div>
            
                {% if cards %}
                    {% for card in cards %}
                    <div class="card-item">
                    <div class="item-header">
                        <div class="item-icon">
                                    <i class="fas fa-credit-card"></i>
                            </div>
                        <div class="item-title">
                            <h5>{{ card.card_name }}</h5>
                            <small>{{ card.created_at[:10] if card.created_at else '' }}</small>
                            </div>
                                                 <div class="item-actions">
                             <button class="btn btn-sm btn-simple" onclick="copyToClipboard('{{ card.card_number|e }}', 'Kart numarası')">
                                 <i class="fas fa-copy"></i>
                                </button>
                             <button class="btn btn-sm btn-secondary-simple" title="CVV güvenlik nedeniyle kaydedilmedi" disabled>
                                 <i class="fas fa-shield-alt"></i>
                             </button>
                             <button class="btn btn-sm btn-danger-simple" onclick="deleteCard('{{ card.card_name }}')">
                                 <i class="fas fa-trash"></i>
                             </button>
                            </div>
                        </div>
                        
                                         <div class="item-details">
                         <p><strong>Kart No:</strong> <code>{{ card.card_number }}</code></p>
                         <p><strong>İsim:</strong> <code>{{ card.cardholder_name }}</code></p>
                         <p><strong>Son Kullanma:</strong> <code>{{ card.expiry_date }}</code></p>
                         <p><strong>CVV:</strong> <code style="color: #6c757d; font-style: italic;">Güvenlik nedeniyle kaydedilmedi</code></p>
                         {% if card.notes %}
                         <p><strong>Notlar:</strong> {{ card.notes }}</p>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                <div class="empty-state">
                    <i class="fas fa-credit-card"></i>
                        <h5>Henüz kart eklenmemiş</h5>
                    <p>İlk kartınızı eklemek için + butonuna tıklayın.</p>
                    </div>
                {% endif %}
        </div>
    </div>

    <!-- Floating Action Buttons -->
    {% if master_password %}
    <div class="fab-container">
        <button class="fab fab-add-password" onclick="togglePasswordModal()" title="Şifre Ekle">
            <i class="fas fa-key"></i>
        </button>
        <button class="fab fab-add-card" onclick="toggleCardModal()" title="Kart Ekle">
            <i class="fas fa-credit-card"></i>
        </button>
    </div>
    {% endif %}
</div>

<!-- Password Modal -->
<div class="modal fade" id="passwordModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-key"></i> Yeni Şifre Ekle</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('add_password') }}" id="passwordForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Site/Uygulama Adı</label>
                        <input type="text" name="site_name" class="form-simple" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Kullanıcı Adı/E-posta</label>
                        <input type="text" name="username" class="form-simple" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Şifre</label>
                        <div class="input-group">
                            <input type="password" name="password" class="form-simple" id="passwordInput" required>
                            <button type="button" class="btn btn-outline-secondary" onclick="togglePasswordVisibility('passwordInput')">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button type="button" class="btn btn-outline-primary" onclick="generatePassword()">
                                <i class="fas fa-random"></i>
                            </button>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Notlar (Opsiyonel)</label>
                        <textarea name="notes" class="form-simple" rows="2"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary-simple" data-bs-dismiss="modal" onclick="cancelPasswordForm()">İptal</button>
                    <button type="submit" class="btn btn-simple">
                        <i class="fas fa-save"></i> Kaydet
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Card Modal -->
<div class="modal fade" id="cardModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-credit-card"></i> Yeni Kart Ekle</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('add_card') }}" id="cardForm" onsubmit="return validateCardForm()">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Kart Adı</label>
                        <input type="text" name="card_name" class="form-simple" placeholder="Örn: İş Bankası Kredi Kartı" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Kart Numarası</label>
                        <input type="text" name="card_number" class="form-simple" placeholder="1234 5678 9012 3456" 
                                                                title="13-20 haneli kart numarası" required
                               maxlength="25" id="cardNumberInput">
                        <small class="form-text text-muted">
                            <i class="fas fa-info-circle"></i> Sadece rakamları girin, boşluklar otomatik eklenir
                        </small>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Son Kullanma Tarihi</label>
                            <input type="text" name="expiry_date" class="form-simple" placeholder="MM/YY" 
                                   title="MM/YY formatında" required
                                   maxlength="5" id="expiryDateInput">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">CVV (Güvenlik için kaydedilmez)</label>
                            <input type="password" name="cvv" class="form-simple" placeholder="123" 
                                   maxlength="4" id="cvvInput" readonly
                                   style="background-color: #f8f9fa; cursor: not-allowed;">
                            <small class="form-text text-muted">
                                <i class="fas fa-shield-alt"></i> CVV güvenlik nedeniyle kaydedilmez
                            </small>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Kart Sahibinin Adı</label>
                        <input type="text" name="cardholder_name" class="form-simple" placeholder="JOHN DOE" 
                               style="text-transform: uppercase;" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Notlar (Opsiyonel)</label>
                        <textarea name="notes" class="form-simple" rows="2"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary-simple" data-bs-dismiss="modal" onclick="cancelCardForm()">İptal</button>
                    <button type="submit" class="btn btn-simple">
                        <i class="fas fa-save"></i> Kaydet
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- JavaScript -->
<script>
// Toggle functions
function togglePasswordModal() {
    new bootstrap.Modal(document.getElementById('passwordModal')).show();
}

function toggleCardModal() {
    new bootstrap.Modal(document.getElementById('cardModal')).show();
}

function togglePasswordVisibility(inputId) {
    const input = document.getElementById(inputId);
    const icon = input.nextElementSibling.querySelector('i');
    
    if (input.type === 'password') {
        input.type = 'text';
        icon.className = 'fas fa-eye-slash';
    } else {
        input.type = 'password';
        icon.className = 'fas fa-eye';
    }
}

function generatePassword() {
    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*';
    let password = '';
    for (let i = 0; i < 16; i++) {
        password += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    document.getElementById('passwordInput').value = password;
}

function copyToClipboard(text, type) {
    // Text'i temizle (HTML entities'leri decode et)
    const cleanText = text.replace(/&amp;/g, '&')
                          .replace(/&lt;/g, '<')
                          .replace(/&gt;/g, '>')
                          .replace(/&quot;/g, '"')
                          .replace(/&#39;/g, "'");
    
    if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(cleanText).then(function() {
            showToast(type + ' panoya kopyalandı!', 'success');
        }).catch(function() {
            fallbackCopyToClipboard(cleanText, type);
        });
    } else {
        fallbackCopyToClipboard(cleanText, type);
    }
}

function fallbackCopyToClipboard(text, type) {
    const textArea = document.createElement('textarea');
    textArea.value = text;
    textArea.style.position = 'fixed';
    textArea.style.opacity = '0';
    textArea.style.left = '-9999px';
    textArea.style.top = '-9999px';
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();
    try {
        const successful = document.execCommand('copy');
        if (successful) {
        showToast(type + ' panoya kopyalandı!', 'success');
        } else {
            showToast('Kopyalama başarısız!', 'error');
        }
    } catch (err) {
        console.error('Fallback kopyalama hatası:', err);
        showToast('Kopyalama başarısız!', 'error');
    }
    document.body.removeChild(textArea);
}

function deletePassword(siteName) {
    if (confirm('Bu şifreyi silmek istediğinizden emin misiniz?')) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '{{ url_for("delete_password") }}';
        
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'site_name';
        input.value = siteName;
        
        form.appendChild(input);
        document.body.appendChild(form);
        form.submit();
    }
}

function deleteCard(cardName) {
    if (confirm('Bu kartı silmek istediğinizden emin misiniz?')) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '{{ url_for("delete_card") }}';
        
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'card_name';
        input.value = cardName;
        
        form.appendChild(input);
        document.body.appendChild(form);
        form.submit();
    }
}

function showToast(message, type) {
    const toast = document.createElement('div');
    toast.className = 'toast-notification ' + type;
    toast.innerHTML = `
        <div class="toast-content">
            <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-times-circle' : 'fa-info-circle'}"></i>
            <span>${message}</span>
        </div>
    `;
    toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${type === 'success' ? '#28a745' : type === 'error' ? '#dc3545' : '#17a2b8'};
        color: white;
        padding: 15px 25px;
        border-radius: 8px;
        z-index: 9999;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        transform: translateX(400px);
        transition: transform 0.3s ease;
        max-width: 300px;
        word-wrap: break-word;
    `;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.style.transform = 'translateX(0)';
    }, 100);
    
    setTimeout(() => {
        toast.style.transform = 'translateX(400px)';
        setTimeout(() => {
            if (toast.parentNode) {
                toast.parentNode.removeChild(toast);
            }
        }, 300);
    }, 4000);
}

function cancelPasswordForm() {
    const form = document.getElementById('passwordForm');
    if (form) {
        form.reset();
    }
    
    const modal = bootstrap.Modal.getInstance(document.getElementById('passwordModal'));
    if (modal) {
        modal.hide();
    }
    
    showToast('Şifre ekleme iptal edildi', 'info');
}

function validateCardForm() {
    const cardNumberInput = document.getElementById('cardNumberInput');
    const expiryDateInput = document.getElementById('expiryDateInput');
    
    // Kart numarasını temizle (sadece rakamlar)
    const cardNumber = cardNumberInput.value.replace(/\s/g, '');
    console.log('Kart numarası validasyonu:', cardNumber.length, 'karakter');
    if (cardNumber.length < 13 || cardNumber.length > 20) {
        showToast('Kart numarası 13-20 haneli olmalıdır.', 'error');
        cardNumberInput.focus();
        return false;
    }
    
    if (!/^\d+$/.test(cardNumber)) {
        showToast('Kart numarası sadece rakamlardan oluşmalıdır.', 'error');
        cardNumberInput.focus();
        return false;
    }
    
    // Son kullanma tarihini temizle
    const expiryDate = expiryDateInput.value.replace(/\//g, '');
    if (expiryDate.length !== 4) {
        showToast('Son kullanma tarihi MM/YY formatında olmalıdır.', 'error');
        expiryDateInput.focus();
        return false;
    }
    
    if (!/^\d{4}$/.test(expiryDate)) {
        showToast('Son kullanma tarihi sadece rakamlardan oluşmalıdır.', 'error');
        expiryDateInput.focus();
        return false;
    }
    
    // Form gönderilmeden önce temizlenmiş değerleri set et
    cardNumberInput.value = cardNumber;
    expiryDateInput.value = expiryDate.substring(0,2) + '/' + expiryDate.substring(2,4);
    
    // Debug için konsola yazdır
    console.log('Kart numarası gönderiliyor:', cardNumber);
    console.log('Son kullanma tarihi gönderiliyor:', expiryDateInput.value);
    
    return true;
}

function cancelCardForm() {
    const form = document.getElementById('cardForm');
    if (form) {
        form.reset();
    }
    
    const modal = bootstrap.Modal.getInstance(document.getElementById('cardModal'));
    if (modal) {
        modal.hide();
    }
    
    showToast('Kart ekleme iptal edildi', 'info');
}

// Force cache refresh for card number validation
console.log('Kart numarası validasyonu güncellendi: 13-20 haneli');

// Auto-format card number input with masking
const cardNumberInput = document.getElementById('cardNumberInput');
if (cardNumberInput) {
    cardNumberInput.addEventListener('input', function(e) {
        let value = e.target.value.replace(/\D/g, '');
        
        // Limit to 20 digits (maximum card length for some cards)
        if (value.length > 20) {
            value = value.substring(0, 20);
        }
        
        // Add spaces every 4 digits
        if (value.length > 0) {
            const groups = [];
            for (let i = 0; i < value.length; i += 4) {
                groups.push(value.substring(i, i + 4));
            }
            value = groups.join(' ');
        }
        
        e.target.value = value;
        
        // Visual feedback - rakam sayısına göre (boşlukları saymadan)
        const digitCount = value.replace(/\s/g, '').length;
        if (digitCount >= 20) {
            this.style.borderColor = '#28a745';
            this.style.backgroundColor = '#f8fff9';
        } else if (digitCount >= 16) {
            this.style.borderColor = '#28a745';
            this.style.backgroundColor = '#f8fff9';
        } else if (digitCount >= 13) {
            this.style.borderColor = '#ffc107';
            this.style.backgroundColor = '#fffbf0';
        } else {
            this.style.borderColor = '#ced4da';
            this.style.backgroundColor = 'white';
        }
    });
    
    // Clear formatting on focus for better UX
    cardNumberInput.addEventListener('focus', function() {
        this.style.borderColor = '#1DA1F2';
        this.style.backgroundColor = 'white';
    });
}

// Auto-format expiry date with masking
const expiryDateInput = document.getElementById('expiryDateInput');
if (expiryDateInput) {
    expiryDateInput.addEventListener('input', function(e) {
        let value = e.target.value.replace(/\D/g, '');
        
        // Limit to 4 digits
        if (value.length > 4) {
            value = value.substring(0, 4);
        }
        
        // Add slash after month
        if (value.length >= 2) {
            value = value.substring(0,2) + '/' + value.substring(2,4);
        }
        
        e.target.value = value;
        
        // Visual feedback for valid date
        if (value.length === 5) {
            const month = parseInt(value.substring(0,2));
            const year = parseInt(value.substring(3,5));
            const currentYear = new Date().getFullYear() % 100;
            
            if (month >= 1 && month <= 12 && year >= currentYear && year <= currentYear + 20) {
                this.style.borderColor = '#28a745';
                this.style.backgroundColor = '#f8fff9';
            } else {
                this.style.borderColor = '#dc3545';
                this.style.backgroundColor = '#fff5f5';
            }
        } else {
            this.style.borderColor = '#ced4da';
            this.style.backgroundColor = 'white';
        }
    });
    
    // Clear formatting on focus
    expiryDateInput.addEventListener('focus', function() {
        this.style.borderColor = '#1DA1F2';
        this.style.backgroundColor = 'white';
    });
}

// Auto-format cardholder name to uppercase
const cardholderNameInput = document.querySelector('input[name="cardholder_name"]');
if (cardholderNameInput) {
    cardholderNameInput.addEventListener('input', function(e) {
        e.target.value = e.target.value.toUpperCase();
    });
}

// CVV input handling - show temporary input for validation
const cvvInput = document.getElementById('cvvInput');
if (cvvInput) {
    // Make CVV input temporarily editable for validation
    cvvInput.addEventListener('focus', function() {
        this.readOnly = false;
        this.style.backgroundColor = 'white';
        this.style.cursor = 'text';
        this.placeholder = '123';
    });
    
    cvvInput.addEventListener('blur', function() {
        // Validate CVV format
        const value = this.value.replace(/\D/g, '');
        if (value.length >= 3 && value.length <= 4) {
            this.value = value;
            this.style.backgroundColor = '#d4edda';
            this.style.borderColor = '#28a745';
        } else if (value.length > 0) {
            this.style.backgroundColor = '#f8d7da';
            this.style.borderColor = '#dc3545';
        } else {
            this.value = '';
            this.style.backgroundColor = '#f8f9fa';
            this.style.borderColor = '#ced4da';
        }
        
        // Make readonly again after validation
        setTimeout(() => {
            this.readOnly = true;
            this.style.cursor = 'not-allowed';
        }, 1000);
    });
    
    cvvInput.addEventListener('input', function(e) {
        let value = e.target.value.replace(/\D/g, '');
        if (value.length > 4) {
            value = value.substring(0, 4);
        }
        e.target.value = value;
    });
}
</script>
{% endblock %}
