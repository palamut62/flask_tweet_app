{% extends "base.html" %}

{% block title %}Haber Kaynakları{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/twitter-style.css') }}">
{% endblock %}

{% block content %}
<!-- Haber Kaynakları Header - Twitter Tarzı -->
<div class="news-sources-header">
    <h1 class="news-sources-title">
        <i class="fas fa-newspaper"></i>
        Haber Kaynakları Yönetimi
    </h1>
</div>

<div class="news-sources-content">
    <p style="color: var(--twitter-text-secondary); margin-bottom: 20px; font-size: 14px;">
        Özel haber kaynaklarınızı ekleyin ve yönetin. Sistem bu kaynaklardan otomatik olarak makale çekecek.
    </p>

    <!-- İstatistikler -->
    {% if stats %}
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-number">{{ stats.total_sources }}</div>
            <div class="stat-label">Toplam Kaynak</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ stats.enabled_sources }}</div>
            <div class="stat-label">Aktif Kaynak</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ stats.disabled_sources }}</div>
            <div class="stat-label">Pasif Kaynak</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ stats.average_success_rate }}%</div>
            <div class="stat-label">Ortalama Başarı</div>
        </div>
    </div>
    {% endif %}

    <!-- Yeni Kaynak Ekleme -->
    <div class="news-source-card">
        <div class="news-source-header">
            <div class="news-source-info">
                <div class="news-source-name">
                    <i class="fas fa-plus"></i>
                    Yeni Haber Kaynağı Ekle
                </div>
            </div>
        </div>
        
        <form method="POST" action="{{ url_for('add_news_source_route') }}" id="addSourceForm" onsubmit="debugFormSubmit(event)">
            <div class="form-sections">
                <!-- Temel Bilgiler -->
                <div class="form-section">
                    <h3 class="form-section-title">
                        <i class="fas fa-info-circle"></i>
                        Temel Bilgiler
                    </h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="name" class="form-label">
                                Kaynak Adı *
                            </label>
                            <input type="text" 
                                   id="name" 
                                   name="name" 
                                   required 
                                   placeholder="örn: Wired AI"
                                   class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="description" class="form-label">
                                Açıklama
                            </label>
                            <input type="text" 
                                   id="description" 
                                   name="description" 
                                   placeholder="Kısa açıklama"
                                   class="form-control">
                        </div>
                    </div>
                </div>

                <!-- URL ve Analiz -->
                <div class="form-section">
                    <h3 class="form-section-title">
                        <i class="fas fa-link"></i>
                        URL ve Analiz
                    </h3>
                    <div class="form-group">
                        <label for="url" class="form-label">
                            URL *
                        </label>
                        <input type="url" 
                               id="url" 
                               name="url" 
                               required 
                               placeholder="https://example.com/ai-news"
                               onchange="onUrlChange()"
                               class="form-control">
                        <div class="form-actions">
                            <button type="button" 
                                    id="analyzePageBtn"
                                    onclick="analyzePageSource()"
                                    class="btn btn-primary"
                                    title="Sayfa kaynağını AI ile analiz et">
                                <i class="fas fa-brain"></i>
                                AI Analiz
                            </button>
                            <button type="button" 
                                    id="testUrlBtn"
                                    onclick="testUrlBeforeAdd()"
                                    class="btn btn-secondary"
                                    title="URL'yi test et">
                                <i class="fas fa-vial"></i>
                                Test Et
                            </button>
                        </div>
                        <div id="urlTestResult" class="form-result hidden"></div>
                    </div>
                </div>

                <!-- Otomatik Tespit Seçeneği -->
                <div class="form-section">
                    <h3 class="form-section-title">
                        <i class="fas fa-magic"></i>
                        Selector Tespiti
                    </h3>
                    <div class="form-info-card">
                        <div class="form-info-icon">
                            <i class="fas fa-info-circle"></i>
                        </div>
                        <div class="form-info-content">
                            <div class="form-info-title">Otomatik Selector Tespiti</div>
                            <div class="form-info-text">
                                <div class="form-checkbox-wrapper">
                                    <input type="checkbox" 
                                           id="auto_detect" 
                                           name="auto_detect" 
                                           value="on"
                                           checked 
                                           onchange="toggleManualSelectors()"
                                           class="form-checkbox">
                                    <span class="form-checkbox-label">Otomatik Selector Tespiti</span>
                                </div>
                                <p class="form-info-detail">
                                    Önerilen: Sayfa yapısını otomatik analiz ederek makale selector'larını tespit eder. 
                                    Bu seçenek kapalıysa manuel selector'lar kullanılır.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Manuel Selector'lar (Otomatik tespit kapalıysa gösterilir) -->
                <div id="manualSelectorsSection" class="form-section hidden">
                    <h3 class="form-section-title">
                        <i class="fas fa-code"></i>
                        Manuel CSS Selector'ları
                    </h3>
                    <div class="form-info-card">
                        <div class="form-info-icon">
                            <i class="fas fa-code"></i>
                        </div>
                        <div class="form-info-content">
                            <div class="form-info-title">Manuel CSS Selector'ları</div>
                            <div class="form-info-text">
                                <div class="form-actions">
                                    <button type="button" 
                                            onclick="showSelectorHelp()" 
                                            class="btn btn-secondary">
                                        <i class="fas fa-question-circle"></i>
                                        Yardım
                                    </button>
                                    <a href="{{ url_for('selector_guide') }}" 
                                       target="_blank"
                                       class="btn btn-secondary">
                                        <i class="fas fa-external-link-alt"></i>
                                        Detaylı Kılavuz
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="article_container" class="form-label">
                                Makale Konteyner Selector *
                            </label>
                            <input type="text" 
                                   id="article_container" 
                                   name="article_container" 
                                   placeholder="örn: .article-item, article, .post"
                                   class="form-control manual-selector-input">
                            <div class="form-help-text">Her makaleyi içeren ana konteyner</div>
                        </div>
                        
                        <div class="form-group">
                            <label for="title_selector" class="form-label">
                                Başlık Selector *
                            </label>
                            <input type="text" 
                                   id="title_selector" 
                                   name="title_selector" 
                                   placeholder="örn: h2, .title, .headline"
                                   class="form-control manual-selector-input">
                            <div class="form-help-text">Makale başlığını içeren element</div>
                        </div>
                        
                        <div class="form-group">
                            <label for="link_selector" class="form-label">
                                Link Selector *
                            </label>
                            <input type="text" 
                                   id="link_selector" 
                                   name="link_selector" 
                                   placeholder="örn: a, .link, .read-more"
                                   class="form-control manual-selector-input">
                            <div class="form-help-text">Makale linkini içeren element</div>
                        </div>
                        
                        <div class="form-group">
                            <label for="date_selector" class="form-label">
                                Tarih Selector
                            </label>
                            <input type="text" 
                                   id="date_selector" 
                                   name="date_selector" 
                                   placeholder="örn: .date, time, .published"
                                   class="form-control manual-selector-input">
                            <div class="form-help-text">Makale tarihini içeren element (opsiyonel)</div>
                        </div>
                        
                        <div class="form-group">
                            <label for="summary_selector" class="form-label">
                                Özet Selector
                            </label>
                            <input type="text" 
                                   id="summary_selector" 
                                   name="summary_selector" 
                                   placeholder="örn: .excerpt, .summary, p"
                                   class="form-control manual-selector-input">
                            <div class="form-help-text">Makale özetini içeren element (opsiyonel)</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Form Actions -->
            <div class="form-actions-main">
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-plus"></i>
                    Haber Kaynağı Ekle
                </button>
                <button type="button" onclick="resetForm()" class="btn btn-secondary">
                    <i class="fas fa-undo"></i>
                    Sıfırla
                </button>
            </div>
        </form>
    </div>

    <!-- RSS Kaynak Ekleme -->
    <div class="news-source-card rss-sources-section">
        <div class="rss-sources-header">
            <h2 class="rss-sources-title">
                <i class="fas fa-rss"></i>
                RSS Kaynağı Ekle
            </h2>
        </div>
        
        <form method="POST" action="{{ url_for('add_rss_source_route') }}">
            <div class="form-sections">
                <div class="form-section">
                    <h3 class="form-section-title">
                        <i class="fas fa-rss"></i>
                        RSS Bilgileri
                    </h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="rss_name" class="form-label">
                                RSS Kaynak Adı *
                            </label>
                            <input type="text" 
                                   id="rss_name" 
                                   name="rss_name" 
                                   required 
                                   placeholder="örn: MIT Technology Review"
                                   class="form-control">
                        </div>
                        
                        <div class="form-group">
                            <label for="rss_url" class="form-label">
                                RSS Feed URL *
                            </label>
                            <input type="url" 
                                   id="rss_url" 
                                   name="rss_url" 
                                   required 
                                   placeholder="https://example.com/feed.xml"
                                   class="form-control">
                        </div>
                        
                        <div class="form-group">
                            <label for="rss_description" class="form-label">
                                Açıklama
                            </label>
                            <input type="text" 
                                   id="rss_description" 
                                   name="rss_description" 
                                   placeholder="Kısa açıklama"
                                   class="form-control">
                        </div>
                    </div>
                </div>
            </div>

            <div class="form-actions-main">
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-plus"></i>
                    RSS Kaynağı Ekle
                </button>
            </div>
        </form>
    </div>

    <!-- Mevcut Kaynaklar -->
    <div class="existing-sources-section">
        <div class="existing-sources-header">
            <h2 class="existing-sources-title">
                <i class="fas fa-list"></i>
                Mevcut Haber Kaynakları
            </h2>
        </div>
        
        {% if stats and stats.sources %}
            <div class="sources-grid">
                {% for source in stats.sources %}
                <div class="source-card {{ 'disabled' if not source.enabled }}">
                    <div class="source-header">
                        <div class="source-info">
                            <div class="source-name">{{ source.name }}</div>
                            <div class="source-description">{{ source.description or 'Açıklama yok' }}</div>
                            <a href="{{ source.url }}" target="_blank" class="source-url">
                                {{ source.url }}
                                <i class="fas fa-external-link-alt"></i>
                            </a>
                        </div>
                        <div class="source-badges">
                            {% if source.type == 'rss' %}
                                <span class="source-badge source-badge-rss">
                                    <i class="fas fa-rss"></i>RSS
                                </span>
                            {% else %}
                                <span class="source-badge source-badge-scraping">
                                    <i class="fas fa-spider"></i>Scraping
                                </span>
                            {% endif %}
                            
                            {% if not source.enabled %}
                                <span class="source-badge source-badge-disabled">
                                    Pasif
                                </span>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- İstatistikler -->
                    <div class="source-stats">
                        <div class="source-stat">
                            <div class="source-stat-number {{ 'success' if source.success_rate >= 80 else ('warning' if source.success_rate >= 50 else 'error') }}">
                                {{ source.success_rate }}%
                            </div>
                            <div class="source-stat-label">Başarı Oranı</div>
                        </div>
                        <div class="source-stat">
                            <div class="source-stat-number info">{{ source.total_articles }}</div>
                            <div class="source-stat-label">Toplam Makale</div>
                        </div>
                        <div class="source-stat">
                            <div class="source-stat-number info">{{ source.last_check_hours }}h</div>
                            <div class="source-stat-label">Son Kontrol</div>
                        </div>
                    </div>
                    
                    <!-- Butonlar -->
                    <div class="source-actions">
                        <!-- Test Butonu -->
                        <button onclick="testSource('{{ source.id }}', this)" 
                                class="source-action-btn btn btn-secondary">
                            <i class="fas fa-vial"></i>
                            Test
                        </button>
                        
                        <!-- Aktif/Pasif Butonu -->
                        <form method="POST" action="{{ url_for('toggle_news_source_route') }}" class="inline">
                            <input type="hidden" name="source_id" value="{{ source.id }}">
                            <input type="hidden" name="enabled" value="{{ 'false' if source.enabled else 'true' }}">
                            <button type="submit" 
                                    class="source-action-btn btn {{ 'btn-warning' if source.enabled else 'btn-success' }}">
                                <i class="fas fa-{{ 'pause' if source.enabled else 'play' }}"></i>
                                {{ 'Pasif Yap' if source.enabled else 'Aktif Yap' }}
                            </button>
                        </form>
                        
                        <!-- Sil Butonu -->
                        <form method="POST" action="{{ url_for('remove_news_source_route') }}" class="inline">
                            <input type="hidden" name="source_id" value="{{ source.id }}">
                            <input type="hidden" name="source_type" value="{{ source.type }}">
                            <button type="submit" 
                                    onclick="return showConfirmDialog('Kaynak Silme', 'Bu kaynağı silmek istediğinizden emin misiniz?', () => this.form.submit())"
                                    class="source-action-btn btn btn-danger">
                                <i class="fas fa-trash"></i>
                                Sil
                            </button>
                        </form>
                    </div>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="empty-state">
                <div class="empty-state-icon">
                    <i class="fas fa-newspaper"></i>
                </div>
                <h3 class="empty-state-title">Henüz Haber Kaynağı Yok</h3>
                <p class="empty-state-text">Yukarıdaki formu kullanarak ilk haber kaynağınızı ekleyin.</p>
            </div>
        {% endif %}
    </div>
</div>

<!-- Test Sonucu Modal -->
<div id="testModal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Test Sonucu</h3>
            <button onclick="closeTestModal()" class="modal-close">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <div id="testResult">
                <!-- Test sonucu buraya gelecek -->
            </div>
        </div>
        <div class="modal-footer">
            <button onclick="closeTestModal()" class="btn btn-secondary">Kapat</button>
        </div>
    </div>
</div>

<!-- Sayfa Kaynağı Analiz Modal -->
<div id="pageSourceModal" class="modal-overlay">
    <div class="modal-content" style="max-width: 95vw; width: 1200px;">
        <div class="modal-header">
            <div>
                <h3 class="modal-title">🧠 AI Sayfa Kaynağı Analizi</h3>
                <p style="font-size: 12px; color: var(--twitter-text-secondary); margin-top: 4px;">
                    Sayfa yapısı analiz ediliyor ve selector'lar otomatik tespit ediliyor
                </p>
            </div>
            <button onclick="closePageSourceModal()" class="modal-close">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="modal-body" style="padding: 0;">
            <div style="display: flex; height: 600px;">
                <!-- Sol Panel: AI Analizi -->
                <div style="width: 30%; padding: 20px; border-right: 1px solid var(--twitter-border); overflow-y: auto;">
                    <div id="aiAnalysisContent">
                        <div style="text-align: center; padding: 40px 20px;">
                            <div class="loading-spinner"></div>
                            <p style="color: var(--twitter-text-secondary); margin-top: 16px;">AI analizi yapılıyor...</p>
                        </div>
                    </div>
                </div>
                
                <!-- Sağ Panel: HTML Kaynağı -->
                <div style="width: 70%; display: flex; flex-direction: column;">
                    <!-- Tab Navigation -->
                    <div style="border-bottom: 1px solid var(--twitter-border); background: var(--twitter-secondary-bg);">
                        <nav style="display: flex; padding: 0 20px;">
                            <button onclick="switchTab('highlighted')" 
                                    id="highlightedTab"
                                    class="tab-button active">
                                <i class="fas fa-palette" style="color: var(--twitter-blue);"></i>
                                <span>Renklendirilmiş</span>
                                <span style="margin-left: 4px; font-size: 10px; background: var(--twitter-blue); color: white; padding: 2px 6px; border-radius: 10px;">AI</span>
                            </button>
                            <button onclick="switchTab('source')" 
                                    id="sourceTab"
                                    class="tab-button">
                                <i class="fas fa-code" style="color: var(--twitter-blue);"></i>
                                <span>Orijinal Kaynak</span>
                                <span style="margin-left: 4px; font-size: 10px; background: var(--twitter-blue); color: white; padding: 2px 6px; border-radius: 10px;">RAW</span>
                            </button>
                            <button onclick="switchTab('formatted')" 
                                    id="formattedTab"
                                    class="tab-button">
                                <i class="fas fa-file-code" style="color: var(--twitter-success);"></i>
                                <span>Formatlanmış</span>
                                <span style="margin-left: 4px; font-size: 10px; background: var(--twitter-success); color: white; padding: 2px 6px; border-radius: 10px;">SYNTAX</span>
                            </button>
                        </nav>
                    </div>

                    <!-- Tab Content -->
                    <div style="flex: 1; overflow: hidden;">
                        <!-- Highlighted Tab -->
                        <div id="highlightedContent" class="tab-content active" style="height: 100%; display: flex; flex-direction: column;">
                            <!-- Toolbar -->
                            <div style="padding: 16px 20px; border-bottom: 1px solid var(--twitter-border); background: var(--twitter-secondary-bg);">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                    <h4 style="font-weight: 600; color: var(--twitter-text); margin: 0;">Renklendirilmiş Sayfa Kaynağı</h4>
                                    <div style="display: flex; align-items: center; gap: 12px;">
                                        <div id="htmlStats" style="font-size: 11px; color: var(--twitter-text-secondary);">
                                            <!-- HTML istatistikleri buraya gelecek -->
                                        </div>
                                        <button onclick="scrollToNextHighlight()" 
                                                style="padding: 4px 8px; background: rgba(29, 161, 242, 0.1); color: var(--twitter-blue); border: none; border-radius: 4px; font-size: 11px; cursor: pointer;"
                                                title="Sonraki işaretli alana git">
                                            <i class="fas fa-arrow-down"></i>
                                        </button>
                                    </div>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; font-size: 11px;">
                                    <div style="display: flex; align-items: center; gap: 16px;">
                                        <div style="display: flex; align-items: center;">
                                            <div style="width: 12px; height: 12px; background: var(--twitter-error); border-radius: 2px; margin-right: 4px;"></div>
                                            <span>Konteyner</span>
                                        </div>
                                        <div style="display: flex; align-items: center;">
                                            <div style="width: 12px; height: 12px; background: var(--twitter-success); border-radius: 2px; margin-right: 4px;"></div>
                                            <span>Başlık</span>
                                        </div>
                                        <div style="display: flex; align-items: center;">
                                            <div style="width: 12px; height: 12px; background: var(--twitter-blue); border-radius: 2px; margin-right: 4px;"></div>
                                            <span>Link</span>
                                        </div>
                                        <div style="display: flex; align-items: center;">
                                            <div style="width: 12px; height: 12px; background: var(--twitter-warning); border-radius: 2px; margin-right: 4px;"></div>
                                            <span>Tarih</span>
                                        </div>
                                        <div style="display: flex; align-items: center;">
                                            <div style="width: 12px; height: 12px; background: var(--twitter-text-secondary); border-radius: 2px; margin-right: 4px;"></div>
                                            <span>Özet</span>
                                        </div>
                                    </div>
                                    <div style="color: var(--twitter-text-secondary);">
                                        💡 Renkli alanları tıklayarak selector'ları kopyalayın
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Highlighted HTML Content -->
                            <div style="flex: 1; overflow-y: auto;">
                                <div id="htmlSourceContent" style="min-height: 100%; padding: 20px;">
                                    <div style="text-align: center; padding: 40px 20px;">
                                        <div class="loading-spinner"></div>
                                        <p style="color: var(--twitter-success); margin-top: 16px;">Renklendirilmiş sayfa kaynağı yükleniyor...</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Source Tab -->
                        <div id="sourceContent" class="tab-content" style="height: 100%; display: none; flex-direction: column;">
                            <!-- Source Toolbar -->
                            <div style="padding: 16px 20px; border-bottom: 1px solid var(--twitter-border); background: var(--twitter-secondary-bg);">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <h4 style="font-weight: 600; color: var(--twitter-text); margin: 0;">Orijinal HTML Kaynağı</h4>
                                    <div style="display: flex; align-items: center; gap: 12px;">
                                        <div id="sourceStats" style="font-size: 11px; color: var(--twitter-text-secondary);">
                                            <!-- Kaynak istatistikleri buraya gelecek -->
                                        </div>
                                        <button onclick="copySourceToClipboard()" 
                                                style="padding: 4px 8px; background: rgba(29, 161, 242, 0.1); color: var(--twitter-blue); border: none; border-radius: 4px; font-size: 11px; cursor: pointer;"
                                                title="Tüm kaynağı kopyala">
                                            <i class="fas fa-copy"></i>
                                        </button>
                                        <button onclick="downloadSource()" 
                                                style="padding: 4px 8px; background: rgba(0, 186, 124, 0.1); color: var(--twitter-success); border: none; border-radius: 4px; font-size: 11px; cursor: pointer;"
                                                title="HTML dosyası olarak indir">
                                            <i class="fas fa-download"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Original HTML Content -->
                            <div style="flex: 1; overflow-y: auto;">
                                <div class="code-container" style="background: var(--twitter-background); min-height: 100%;">
                                    <div class="line-numbers" id="originalLineNumbers">
                                        <!-- Satır numaraları buraya gelecek -->
                                    </div>
                                    <div id="originalSourceContent" class="code-content" style="min-height: 100%;">
                                        <div style="text-align: center; padding: 40px 20px;">
                                            <div class="loading-spinner"></div>
                                            <p style="color: var(--twitter-text-secondary); margin-top: 16px;">Orijinal sayfa kaynağı yükleniyor...</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Formatted Tab -->
                        <div id="formattedContent" class="tab-content" style="height: 100%; display: none; flex-direction: column;">
                            <!-- Formatted Toolbar -->
                            <div style="padding: 16px 20px; border-bottom: 1px solid var(--twitter-border); background: var(--twitter-secondary-bg);">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <h4 style="font-weight: 600; color: var(--twitter-text); margin: 0;">Formatlanmış HTML</h4>
                                    <div style="display: flex; align-items: center; gap: 12px;">
                                        <div id="formattedStats" style="font-size: 11px; color: var(--twitter-text-secondary);">
                                            <!-- Formatlanmış istatistikler buraya gelecek -->
                                        </div>
                                        <button onclick="copyFormattedToClipboard()" 
                                                style="padding: 4px 8px; background: rgba(29, 161, 242, 0.1); color: var(--twitter-blue); border: none; border-radius: 4px; font-size: 11px; cursor: pointer;"
                                                title="Formatlanmış kodu kopyala">
                                            <i class="fas fa-copy"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Formatted HTML Content -->
                            <div style="flex: 1; overflow-y: auto;">
                                <div class="code-container" style="background: var(--twitter-background); min-height: 100%;">
                                    <div class="line-numbers" id="formattedLineNumbers">
                                        <!-- Satır numaraları buraya gelecek -->
                                    </div>
                                    <div id="formattedSourceContent" class="code-content" style="min-height: 100%;">
                                        <div style="text-align: center; padding: 40px 20px;">
                                            <div class="loading-spinner"></div>
                                            <p style="color: var(--twitter-text-secondary); margin-top: 16px;">Formatlanmış sayfa kaynağı yükleniyor...</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="modal-footer">
            <div style="flex: 1; font-size: 12px; color: var(--twitter-text-secondary);">
                💡 Renkli alanlar tıklanabilir - Selector'ı kopyalamak için tıklayın
            </div>
            <div style="display: flex; gap: 12px;">
                <button onclick="applyDetectedSelectors()" 
                        class="btn btn-primary">
                    <i class="fas fa-magic"></i>
                    Tespit Edilen Selector'ları Uygula
                </button>
                <button onclick="closePageSourceModal()" 
                        class="btn btn-secondary">
                    Kapat
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Selector Yardım Modal -->
<div id="selectorHelpModal" class="modal-overlay">
    <div class="modal-content" style="max-width: 800px;">
        <div class="modal-header">
            <h3 class="modal-title">CSS Selector Yardımı</h3>
            <button onclick="closeSelectorHelpModal()" class="modal-close">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="modal-body">
            <div style="display: flex; flex-direction: column; gap: 24px;">
                <!-- Temel Selector'lar -->
                <div>
                    <h4 style="font-size: 16px; font-weight: 600; color: var(--twitter-text); margin-bottom: 12px;">🎯 Temel CSS Selector'ları</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                        <div style="background: var(--twitter-secondary-bg); padding: 12px; border-radius: 8px;">
                            <code style="font-size: 13px; font-family: monospace; color: var(--twitter-blue);">.class-name</code>
                            <p style="font-size: 11px; color: var(--twitter-text-secondary); margin-top: 4px;">Class ile seçim</p>
                        </div>
                        <div style="background: var(--twitter-secondary-bg); padding: 12px; border-radius: 8px;">
                            <code style="font-size: 13px; font-family: monospace; color: var(--twitter-blue);">#id-name</code>
                            <p style="font-size: 11px; color: var(--twitter-text-secondary); margin-top: 4px;">ID ile seçim</p>
                        </div>
                        <div style="background: var(--twitter-secondary-bg); padding: 12px; border-radius: 8px;">
                            <code style="font-size: 13px; font-family: monospace; color: var(--twitter-blue);">tag</code>
                            <p style="font-size: 11px; color: var(--twitter-text-secondary); margin-top: 4px;">HTML tag ile seçim</p>
                        </div>
                        <div style="background: var(--twitter-secondary-bg); padding: 12px; border-radius: 8px;">
                            <code style="font-size: 13px; font-family: monospace; color: var(--twitter-blue);">parent child</code>
                            <p style="font-size: 11px; color: var(--twitter-text-secondary); margin-top: 4px;">Alt element seçimi</p>
                        </div>
                    </div>
                </div>
                
                <!-- Örnek Siteler -->
                <div>
                    <h4 style="font-size: 16px; font-weight: 600; color: var(--twitter-text); margin-bottom: 12px;">📰 Popüler Haber Sitelerinde Örnek Selector'lar</h4>
                    <div style="display: flex; flex-direction: column; gap: 12px;">
                        <div style="border: 1px solid var(--twitter-border); border-radius: 8px; padding: 16px;">
                            <h5 style="font-weight: 600; color: var(--twitter-text); margin-bottom: 8px;">TechCrunch</h5>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 8px; font-size: 13px;">
                                <div><strong>Konteyner:</strong> <code style="color: var(--twitter-blue);">.post-block</code></div>
                                <div><strong>Başlık:</strong> <code style="color: var(--twitter-blue);">h2 a</code></div>
                                <div><strong>Link:</strong> <code style="color: var(--twitter-blue);">h2 a</code></div>
                                <div><strong>Tarih:</strong> <code style="color: var(--twitter-blue);">.river-byline time</code></div>
                            </div>
                        </div>
                        
                        <div style="border: 1px solid var(--twitter-border); border-radius: 8px; padding: 16px;">
                            <h5 style="font-weight: 600; color: var(--twitter-text); margin-bottom: 8px;">The Verge</h5>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 8px; font-size: 13px;">
                                <div><strong>Konteyner:</strong> <code style="color: var(--twitter-blue);">.c-entry-box</code></div>
                                <div><strong>Başlık:</strong> <code style="color: var(--twitter-blue);">h2 a</code></div>
                                <div><strong>Link:</strong> <code style="color: var(--twitter-blue);">h2 a</code></div>
                                <div><strong>Tarih:</strong> <code style="color: var(--twitter-blue);">.c-byline time</code></div>
                            </div>
                        </div>
                        
                        <div style="border: 1px solid var(--twitter-border); border-radius: 8px; padding: 16px;">
                            <h5 style="font-weight: 600; color: var(--twitter-text); margin-bottom: 8px;">Wired</h5>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 8px; font-size: 13px;">
                                <div><strong>Konteyner:</strong> <code style="color: var(--twitter-blue);">.SummaryItemWrapper</code></div>
                                <div><strong>Başlık:</strong> <code style="color: var(--twitter-blue);">h3 a</code></div>
                                <div><strong>Link:</strong> <code style="color: var(--twitter-blue);">h3 a</code></div>
                                <div><strong>Tarih:</strong> <code style="color: var(--twitter-blue);">.SummaryItemPublishDate</code></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Adım Adım Kılavuz -->
                <div>
                    <h4 style="font-size: 16px; font-weight: 600; color: var(--twitter-text); margin-bottom: 12px;">🔍 Adım Adım Selector Bulma</h4>
                    <div style="background: rgba(29, 161, 242, 0.05); border: 1px solid rgba(29, 161, 242, 0.1); border-radius: 8px; padding: 16px;">
                        <ol style="font-size: 13px; line-height: 1.6; color: var(--twitter-text); margin: 0; padding-left: 20px;">
                            <li><strong>1.</strong> Hedef siteyi tarayıcıda açın</li>
                            <li><strong>2.</strong> F12 tuşuna basarak Developer Tools'u açın</li>
                            <li><strong>3.</strong> Bir makale başlığına sağ tıklayıp "Inspect" seçin</li>
                            <li><strong>4.</strong> Seçilen element üzerinde sağ tıklayıp "Copy → Copy selector" seçin</li>
                            <li><strong>5.</strong> Kopyalanan selector'ı test edin</li>
                            <li><strong>6.</strong> Gerekirse selector'ı sadeleştirin (çok uzunsa)</li>
                        </ol>
                    </div>
                </div>
                
                <!-- İpuçları -->
                <div>
                    <h4 style="font-size: 16px; font-weight: 600; color: var(--twitter-text); margin-bottom: 12px;">💡 İpuçları</h4>
                    <div style="background: rgba(255, 215, 0, 0.05); border: 1px solid rgba(255, 215, 0, 0.1); border-radius: 8px; padding: 16px;">
                        <ul style="font-size: 13px; line-height: 1.6; color: var(--twitter-text); margin: 0; padding-left: 20px;">
                            <li>• Çok spesifik selector'lar yerine genel olanları tercih edin</li>
                            <li>• Birden fazla makale için çalıştığından emin olun</li>
                            <li>• Relative linkler için base URL'yi unutmayın</li>
                            <li>• Tarih ve özet selector'ları opsiyoneldir</li>
                            <li>• Test butonunu kullanarak selector'ları doğrulayın</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="modal-footer">
            <button onclick="closeSelectorHelpModal()" class="btn btn-primary">Anladım</button>
        </div>
    </div>
</div>

<!-- Loading Spinner -->
<style>
.loading-spinner {
    width: 24px;
    height: 24px;
    border: 2px solid var(--twitter-border);
    border-top: 2px solid var(--twitter-blue);
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.tab-button {
    padding: 12px 16px;
    border: none;
    background: transparent;
    color: var(--twitter-text-secondary);
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
    border-bottom: 2px solid transparent;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    gap: 6px;
}

.tab-button:hover {
    color: var(--twitter-text);
    background: rgba(0, 0, 0, 0.05);
}

.tab-button.active {
    color: var(--twitter-text);
    border-bottom-color: var(--twitter-blue);
    background: var(--twitter-background);
}

.tab-content {
    display: none;
}

.tab-content.active {
    display: flex;
}

.code-container {
    display: flex;
    font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
    font-size: 12px;
    line-height: 1.5;
}

.line-numbers {
    background: var(--twitter-secondary-bg);
    border-right: 1px solid var(--twitter-border);
    padding: 8px 6px;
    font-size: 11px;
    color: var(--twitter-text-secondary);
    text-align: right;
    user-select: none;
    min-width: 40px;
}

.code-content {
    flex: 1;
    padding: 8px 12px;
    overflow-x: auto;
    white-space: pre-wrap;
    word-break: break-word;
}
</style>

<!-- JavaScript Functions -->
<script>
// Toast notification system
function showToast(message, type = 'info') {
    // Create toast container if it doesn't exist
    let toastContainer = document.getElementById('toast-container');
    if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.id = 'toast-container';
        toastContainer.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            max-width: 400px;
        `;
        document.body.appendChild(toastContainer);
    }

    // Create toast element
    const toast = document.createElement('div');
    const icon = getToastIcon(type);
    const title = getToastTitle(type);
    
    toast.className = `toast toast-${type}`;
    toast.style.cssText = `
        background: var(--twitter-background);
        border: 1px solid var(--twitter-border);
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 10px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        display: flex;
        align-items: flex-start;
        gap: 12px;
        animation: slideIn 0.3s ease-out;
        max-width: 400px;
    `;
    
    toast.innerHTML = `
        <div style="flex-shrink: 0; font-size: 20px;">${icon}</div>
        <div style="flex: 1;">
            <div style="font-weight: 600; margin-bottom: 4px; color: var(--twitter-text);">${title}</div>
            <div style="color: var(--twitter-text-secondary); font-size: 14px;">${message}</div>
        </div>
        <button onclick="this.parentElement.remove()" style="
            background: none;
            border: none;
            color: var(--twitter-text-secondary);
            cursor: pointer;
            font-size: 18px;
            padding: 0;
            margin-left: 8px;
        ">&times;</button>
    `;
    
    toastContainer.appendChild(toast);
    
    // Auto remove after 5 seconds
    setTimeout(() => {
        if (toast.parentElement) {
            toast.style.animation = 'slideOut 0.3s ease-in';
            setTimeout(() => toast.remove(), 300);
        }
    }, 5000);
}

function getToastIcon(type) {
    const icons = {
        success: '✅',
        error: '❌',
        warning: '⚠️',
        info: 'ℹ️'
    };
    return icons[type] || icons.info;
}

function getToastTitle(type) {
    const titles = {
        success: 'Başarılı',
        error: 'Hata',
        warning: 'Uyarı',
        info: 'Bilgi'
    };
    return titles[type] || titles.info;
}

// Add CSS animations
const style = document.createElement('style');
style.textContent = `
    @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    @keyframes slideOut {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
    }
`;
document.head.appendChild(style);

// Manuel selector'ları göster/gizle
function toggleManualSelectors() {
    const autoDetect = document.getElementById('auto_detect');
    const manualSection = document.getElementById('manualSelectorsSection');
    
    if (!autoDetect || !manualSection) {
        console.error('Gerekli elementler bulunamadı!');
        return;
    }
    
    if (autoDetect.checked) {
        manualSection.classList.add('hidden');
        clearManualSelectors();
    } else {
        manualSection.classList.remove('hidden');
        enableManualSelectors();
    }
}

// Manuel selector'ları temizle ve disable et
function clearManualSelectors() {
    const manualInputs = document.querySelectorAll('.manual-selector-input');
    manualInputs.forEach(input => {
        input.value = '';
        input.readOnly = true;
        input.style.backgroundColor = 'var(--twitter-secondary-bg)';
        input.style.color = 'var(--twitter-text-secondary)';
        input.style.cursor = 'not-allowed';
    });
}

// Manuel selector'ları aktif et
function enableManualSelectors() {
    const manualInputs = document.querySelectorAll('.manual-selector-input');
    manualInputs.forEach(input => {
        input.readOnly = false;
        input.style.backgroundColor = '';
        input.style.color = '';
        input.style.cursor = '';
    });
}

// Selector yardım modalını göster
function showSelectorHelp() {
    const modal = document.getElementById('selectorHelpModal');
    modal.classList.add('active');
}

function closeSelectorHelpModal() {
    const modal = document.getElementById('selectorHelpModal');
    modal.classList.remove('active');
}

// URL değiştiğinde çağrılır
function onUrlChange() {
    const url = document.getElementById('url').value.trim();
    const analyzeBtn = document.getElementById('analyzePageBtn');
    
    if (url && (url.startsWith('http://') || url.startsWith('https://'))) {
        analyzeBtn.disabled = false;
        analyzeBtn.classList.remove('opacity-50', 'cursor-not-allowed');
    } else {
        analyzeBtn.disabled = true;
        analyzeBtn.classList.add('opacity-50', 'cursor-not-allowed');
    }
}

// Sayfa kaynağını AI ile analiz et
function analyzePageSource() {
    const url = document.getElementById('url').value.trim();
    
    if (!url) {
        showToast('Lütfen önce bir URL girin', 'warning');
        return;
    }
    
    // Modal'ı aç
    const modal = document.getElementById('pageSourceModal');
    modal.classList.add('active');
    
    // Loading state'i göster
    document.getElementById('aiAnalysisContent').innerHTML = `
        <div style="text-align: center; padding: 40px 20px;">
            <div class="loading-spinner"></div>
            <p style="color: var(--twitter-text-secondary); margin-top: 16px;">AI analizi yapılıyor...</p>
            <p style="font-size: 11px; color: var(--twitter-text-secondary); margin-top: 8px;">Bu işlem 10-30 saniye sürebilir</p>
        </div>
    `;
    
    document.getElementById('htmlSourceContent').innerHTML = `
        <div style="text-align: center; padding: 40px 20px;">
            <div class="loading-spinner"></div>
            <p style="color: var(--twitter-success); margin-top: 16px;">Sayfa kaynağı yükleniyor...</p>
        </div>
    `;
    
    // API çağrısı
    fetch('/analyze_page_source', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ url: url })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            displayAnalysisResults(data);
        } else {
            showAnalysisError(data.error || 'Analiz başarısız oldu');
        }
    })
    .catch(error => {
        console.error('Analiz hatası:', error);
        showAnalysisError('Bağlantı hatası: ' + error.message);
    });
}

// Analiz sonuçlarını göster
function displayAnalysisResults(data) {
    const aiAnalysis = data.ai_analysis;
    const htmlContent = data.html_content;
    const htmlSize = data.html_size || htmlContent.length;
    const originalSize = data.original_size || 0;
    
    // Global değişkene kaydet (tab sistemi için)
    window.currentAnalysisData = {
        html_content: htmlContent,
        original_html: data.original_html || htmlContent,
        ai_analysis: aiAnalysis,
        url: data.url,
        html_size: htmlSize,
        original_size: originalSize
    };
    window.originalSourceLoaded = false;
    window.formattedSourceLoaded = false;
    
    // AI analizi sonuçlarını göster
    document.getElementById('aiAnalysisContent').innerHTML = `
        <div style="display: flex; flex-direction: column; gap: 16px;">
            <!-- Güven Seviyesi -->
            <div style="background: ${getConfidenceColor(aiAnalysis.confidence)}-50; border: 1px solid ${getConfidenceColor(aiAnalysis.confidence)}-200; border-radius: 8px; padding: 12px;">
                <div style="display: flex; align-items: center;">
                    <i class="fas fa-${getConfidenceIcon(aiAnalysis.confidence)}" style="color: ${getConfidenceColor(aiAnalysis.confidence)}-600; margin-right: 8px;"></i>
                    <span style="font-weight: 600; color: ${getConfidenceColor(aiAnalysis.confidence)}-800;">
                        Güven: ${aiAnalysis.confidence}
                    </span>
                </div>
            </div>
            
            <!-- HTML Boyut Bilgisi -->
            <div style="background: rgba(29, 161, 242, 0.05); border: 1px solid rgba(29, 161, 242, 0.1); border-radius: 8px; padding: 12px;">
                <div style="display: flex; align-items: center; justify-content: space-between;">
                    <div style="display: flex; align-items: center;">
                        <i class="fas fa-file-code" style="color: var(--twitter-blue); margin-right: 8px;"></i>
                        <span style="font-weight: 600; color: var(--twitter-blue);">HTML Boyutu</span>
                    </div>
                    <div style="font-size: 12px; color: var(--twitter-blue);">
                        ${formatBytes(htmlSize)} ${originalSize > htmlSize ? `(${formatBytes(originalSize)} → kısaltıldı)` : ''}
                    </div>
                </div>
            </div>
            
            <!-- Analiz Sonucu -->
            <div style="background: var(--twitter-secondary-bg); border: 1px solid var(--twitter-border); border-radius: 8px; padding: 12px;">
                <h4 style="font-weight: 600; color: var(--twitter-text); margin: 0 0 8px 0;">📊 Sayfa Analizi</h4>
                <p style="font-size: 13px; color: var(--twitter-text); margin: 0;">${aiAnalysis.analysis}</p>
            </div>
            
            <!-- Tespit Edilen Selector'lar -->
            <div style="display: flex; flex-direction: column; gap: 12px;">
                <h4 style="font-weight: 600; color: var(--twitter-text); margin: 0;">🎯 Tespit Edilen Selector'lar</h4>
                
                ${Object.entries(aiAnalysis.selectors).map(([key, value]) => `
                    <div style="background: var(--twitter-background); border: 1px solid var(--twitter-border); border-radius: 8px; padding: 12px;">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 4px;">
                            <span style="font-size: 11px; font-weight: 600; color: var(--twitter-text-secondary); text-transform: uppercase;">${getSelectorLabel(key)}</span>
                            <button onclick="copyToClipboard('${value}')" 
                                    style="font-size: 11px; color: var(--twitter-blue); background: none; border: none; cursor: pointer;">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                        <code style="font-size: 12px; color: var(--twitter-text); background: var(--twitter-secondary-bg); padding: 4px 8px; border-radius: 4px; display: block; word-break: break-all;">${value}</code>
                    </div>
                `).join('')}
            </div>
            
            <!-- Notlar -->
            ${aiAnalysis.notes ? `
                <div style="background: rgba(255, 215, 0, 0.05); border: 1px solid rgba(255, 215, 0, 0.1); border-radius: 8px; padding: 12px;">
                    <h4 style="font-weight: 600; color: var(--twitter-warning); margin: 0 0 8px 0;">📝 Notlar</h4>
                    <p style="font-size: 13px; color: var(--twitter-warning); margin: 0;">${aiAnalysis.notes}</p>
                </div>
            ` : ''}
        </div>
    `;
    
    // Renklendirilmiş HTML kaynağını göster
    const htmlContainer = document.getElementById('htmlSourceContent');
    htmlContainer.innerHTML = `
        <div style="font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace; font-size: 11px; line-height: 1.4; white-space: pre-wrap; word-break: break-word; background: var(--twitter-background); color: var(--twitter-text); border: 1px solid var(--twitter-border); border-radius: 8px; padding: 12px; overflow-x: auto; max-height: 400px; overflow-y: auto;">
            <pre style="margin: 0; padding: 0; background: transparent; border: none; font-family: inherit; font-size: inherit; line-height: inherit; white-space: pre-wrap;">${htmlContent}</pre>
        </div>
    `;
    
    // Scroll pozisyonunu sıfırla
    htmlContainer.scrollTop = 0;
    
    // Tıklanabilir elementleri aktif et
    activateClickableElements();
    
    // Highlighted elementlerin sayısını göster
    const highlightedElements = htmlContainer.querySelectorAll('.highlighted-selector');
    if (highlightedElements.length > 0) {
        showToast(`✨ ${highlightedElements.length} element renklendirildi ve tıklanabilir hale getirildi!`, 'success');
    }
    
    // HTML istatistiklerini güncelle
    updateHtmlStats(data);
    
    // Scroll index'ini sıfırla
    currentHighlightIndex = 0;
}

// Analiz hatasını göster
function showAnalysisError(error) {
    document.getElementById('aiAnalysisContent').innerHTML = `
        <div style="text-align: center; padding: 40px 20px;">
            <i class="fas fa-exclamation-triangle" style="color: var(--twitter-error); font-size: 48px; margin-bottom: 16px;"></i>
            <h4 style="font-weight: 600; color: var(--twitter-text); margin: 0 0 8px 0;">Analiz Başarısız</h4>
            <p style="font-size: 13px; color: var(--twitter-text-secondary); margin: 0 0 16px 0;">${error}</p>
            <button onclick="analyzePageSource()" 
                    style="padding: 8px 16px; background: var(--twitter-blue); color: white; border: none; border-radius: 8px; cursor: pointer;">
                Tekrar Dene
            </button>
        </div>
    `;
    
    document.getElementById('htmlSourceContent').innerHTML = `
        <div style="text-align: center; padding: 40px 20px;">
            <i class="fas fa-times" style="color: var(--twitter-error); font-size: 32px; margin-bottom: 16px;"></i>
            <p style="color: var(--twitter-error);">Sayfa kaynağı yüklenemedi</p>
        </div>
    `;
}

// Tıklanabilir elementleri aktif et
function activateClickableElements() {
    const elements = document.querySelectorAll('[data-selector]');
    
    elements.forEach(element => {
        element.style.cursor = 'pointer';
        element.title = `Tıklayın: ${element.getAttribute('data-selector-value')}`;
        
        element.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const selector = this.getAttribute('data-selector-value');
            const selectorType = this.getAttribute('data-selector');
            
            copyToClipboard(selector);
            
            // Visual feedback
            const originalBg = this.style.backgroundColor;
            this.style.backgroundColor = 'var(--twitter-success)';
            this.style.color = 'white';
            
            setTimeout(() => {
                this.style.backgroundColor = originalBg;
                this.style.color = '';
            }, 500);
            
            // Toast notification
            showToast(`${getSelectorLabel(selectorType)} selector kopyalandı: ${selector}`, 'success');
        });
    });
}

// Tespit edilen selector'ları forma uygula
function applyDetectedSelectors() {
    const aiAnalysisContent = document.getElementById('aiAnalysisContent');
    const selectorElements = aiAnalysisContent.querySelectorAll('code');
    
    if (selectorElements.length === 0) {
        showToast('Henüz selector analizi yapılmamış', 'warning');
        return;
    }
    
    // Otomatik tespit checkbox'ını kapat
    const autoDetectCheckbox = document.getElementById('auto_detect');
    if (autoDetectCheckbox) {
        autoDetectCheckbox.checked = false;
        toggleManualSelectors();
    }
    
    // Selector'ları forma uygula
    const selectorMapping = {
        'article_container': 'article_container',
        'title_selector': 'title_selector', 
        'link_selector': 'link_selector',
        'date_selector': 'date_selector',
        'summary_selector': 'summary_selector'
    };
    
    selectorElements.forEach((element, index) => {
        const selectorValue = element.textContent.trim();
        const keys = Object.keys(selectorMapping);
        
        if (keys[index]) {
            const fieldId = selectorMapping[keys[index]];
            const field = document.getElementById(fieldId);
            
            if (field) {
                field.value = selectorValue;
                
                // Visual feedback
                field.style.backgroundColor = 'rgba(0, 186, 124, 0.1)';
                setTimeout(() => {
                    field.style.backgroundColor = '';
                }, 1000);
            }
        }
    });
    
    // Modal'ı kapat
    closePageSourceModal();
    
    // Başarı mesajı
    showToast('✅ AI tarafından tespit edilen selector\'lar forma uygulandı!', 'success');
}

// Modal'ı kapat
function closePageSourceModal() {
    const modal = document.getElementById('pageSourceModal');
    modal.classList.remove('active');
}

// Yardımcı fonksiyonlar
function getConfidenceColor(confidence) {
    switch(confidence) {
        case 'Yüksek': return 'var(--twitter-success)';
        case 'Orta': return 'var(--twitter-warning)';
        case 'Düşük': return 'var(--twitter-error)';
        default: return 'var(--twitter-text-secondary)';
    }
}

function getConfidenceIcon(confidence) {
    switch(confidence) {
        case 'Yüksek': return 'check-circle';
        case 'Orta': return 'exclamation-circle';
        case 'Düşük': return 'times-circle';
        default: return 'question-circle';
    }
}

function getSelectorLabel(key) {
    const labels = {
        'article_container': 'Konteyner',
        'title_selector': 'Başlık',
        'link_selector': 'Link',
        'date_selector': 'Tarih',
        'summary_selector': 'Özet'
    };
    return labels[key] || key;
}

function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        console.log('Kopyalandı:', text);
    }).catch(err => {
        console.error('Kopyalama hatası:', err);
        // Fallback
        const textArea = document.createElement('textarea');
        textArea.value = text;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
    });
}

function formatBytes(bytes) {
    if (bytes === 0) return '0 Bytes';
    
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// Sonraki işaretli alana scroll et
let currentHighlightIndex = 0;

function scrollToNextHighlight() {
    const highlights = document.querySelectorAll('.highlighted-selector');
    
    if (highlights.length === 0) {
        showToast('⚠️ Henüz işaretli element bulunamadı', 'warning');
        return;
    }
    
    // Mevcut highlight'ı temizle
    highlights.forEach(el => el.classList.remove('current-highlight'));
    
    // Sonraki highlight'a git
    const currentElement = highlights[currentHighlightIndex];
    currentElement.classList.add('current-highlight');
    
    // Element'e scroll et
    currentElement.scrollIntoView({
        behavior: 'smooth',
        block: 'center'
    });
    
    // Index'i güncelle
    currentHighlightIndex = (currentHighlightIndex + 1) % highlights.length;
    
    // Bilgi göster
    const selectorType = currentElement.getAttribute('data-selector-label');
    const selectorValue = currentElement.getAttribute('data-selector-value');
    showToast(`🎯 ${selectorType}: ${selectorValue}`, 'info');
}

// HTML istatistiklerini güncelle
function updateHtmlStats(data) {
    const htmlContainer = document.getElementById('htmlSourceContent');
    const highlights = htmlContainer.querySelectorAll('.highlighted-selector');
    
    // Selector türlerine göre sayıları hesapla
    const stats = {};
    highlights.forEach(el => {
        const type = el.getAttribute('data-selector');
        stats[type] = (stats[type] || 0) + 1;
    });
    
    const statsHtml = Object.entries(stats).map(([type, count]) => {
        const label = getSelectorLabel(type);
        return `${label}: ${count}`;
    }).join(' | ');
    
    document.getElementById('htmlStats').innerHTML = `
        <span style="font-weight: 600;">${highlights.length} işaretli element</span>
        ${statsHtml ? ` (${statsHtml})` : ''}
    `;
}

// Test fonksiyonları
function testSource(sourceId, buttonElement) {
    // Test butonunu disable et
    buttonElement.disabled = true;
    buttonElement.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Test Ediliyor...';
    
    fetch('/test_news_source', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: 'source_id=' + encodeURIComponent(sourceId)
    })
    .then(response => response.json())
    .then(data => {
        showTestResult(data);
        // Test butonunu tekrar aktif et
        buttonElement.disabled = false;
        buttonElement.innerHTML = '<i class="fas fa-vial"></i> Test';
    })
    .catch(error => {
        showTestResult({success: false, error: 'Test sırasında hata oluştu: ' + error});
        // Test butonunu tekrar aktif et
        buttonElement.disabled = false;
        buttonElement.innerHTML = '<i class="fas fa-vial"></i> Test';
    });
}

function showTestResult(data) {
    const modal = document.getElementById('testModal');
    const resultDiv = document.getElementById('testResult');
    
    if (data.success) {
        resultDiv.innerHTML = `
            <div style="display: flex; align-items: center; gap: 8px; color: var(--twitter-success); margin-bottom: 16px;">
                <i class="fas fa-check-circle"></i>
                <span style="font-weight: 600;">Test Başarılı!</span>
            </div>
            <p style="color: var(--twitter-text); margin-bottom: 16px;">${data.message}</p>
            <div style="background: rgba(0, 186, 124, 0.05); border: 1px solid rgba(0, 186, 124, 0.1); border-radius: 8px; padding: 12px;">
                <p style="font-size: 13px; color: var(--twitter-success); margin: 0 0 12px 0;">
                    <strong>Bulunan Makale Sayısı:</strong> ${data.article_count}
                </p>
                ${data.articles && data.articles.length > 0 ? `
                    <div style="margin-top: 8px;">
                        <p style="font-size: 13px; font-weight: 600; color: var(--twitter-success); margin: 0 0 8px 0;">Örnek Makaleler:</p>
                        <ul style="font-size: 12px; color: var(--twitter-success); margin: 0; padding-left: 20px;">
                            ${data.articles.map(article => `<li>• ${article.title}</li>`).join('')}
                        </ul>
                    </div>
                ` : ''}
            </div>
        `;
    } else {
        resultDiv.innerHTML = `
            <div style="display: flex; align-items: center; gap: 8px; color: var(--twitter-error); margin-bottom: 16px;">
                <i class="fas fa-exclamation-triangle"></i>
                <span style="font-weight: 600;">Test Başarısız!</span>
            </div>
            <div style="background: rgba(244, 36, 94, 0.05); border: 1px solid rgba(244, 36, 94, 0.1); border-radius: 8px; padding: 12px;">
                <p style="font-size: 13px; color: var(--twitter-error); margin: 0;">${data.error}</p>
            </div>
        `;
    }
    
    modal.classList.add('active');
}

function closeTestModal() {
    const modal = document.getElementById('testModal');
    modal.classList.remove('active');
}

// URL test fonksiyonu (kaynak eklemeden önce)
function testUrlBeforeAdd() {
    const urlInput = document.getElementById('url');
    const testBtn = document.getElementById('testUrlBtn');
    const resultDiv = document.getElementById('urlTestResult');
    
    const url = urlInput.value.trim();
    
    if (!url) {
        showUrlTestResult('URL gerekli', 'error');
        return;
    }
    
    // Test butonunu disable et
    testBtn.disabled = true;
    testBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Test Ediliyor...';
    
    fetch('/test_news_source_url', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({url: url})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const message = `✅ ${data.container_count} konteyner bulundu. ${data.sample_articles ? data.sample_articles.length : 0} örnek makale tespit edildi.`;
            showUrlTestResult(message, 'success');
        } else {
            showUrlTestResult(`❌ ${data.message}`, 'error');
        }
        
        // Test butonunu tekrar aktif et
        testBtn.disabled = false;
        testBtn.innerHTML = '<i class="fas fa-vial"></i> Test Et';
    })
    .catch(error => {
        showUrlTestResult(`❌ Test hatası: ${error}`, 'error');
        
        // Test butonunu tekrar aktif et
        testBtn.disabled = false;
        testBtn.innerHTML = '<i class="fas fa-vial"></i> Test Et';
    });
}

function showUrlTestResult(message, type) {
    const resultDiv = document.getElementById('urlTestResult');
    resultDiv.className = `form-result ${type}`;
    resultDiv.textContent = message;
    resultDiv.classList.remove('hidden');
}

// URL değiştiğinde test sonucunu temizle
document.getElementById('url').addEventListener('input', function() {
    const resultDiv = document.getElementById('urlTestResult');
    resultDiv.classList.add('hidden');
});

// Form sıfırlama
function resetForm() {
    document.getElementById('addSourceForm').reset();
    document.getElementById('urlTestResult').classList.add('hidden');
    const manualSection = document.getElementById('manualSelectorsSection');
    if (manualSection) {
        manualSection.classList.add('hidden');
    }
    clearManualSelectors();
    showToast('Form sıfırlandı', 'info');
}

// Onay dialog'u
function showConfirmDialog(title, message, onConfirm) {
    if (confirm(`${title}\n\n${message}`)) {
        onConfirm();
    }
}

// Sayfa yüklendiğinde
document.addEventListener('DOMContentLoaded', function() {
    const autoDetect = document.getElementById('auto_detect');
    const manualSection = document.getElementById('manualSelectorsSection');
    
    if (autoDetect && autoDetect.checked) {
        manualSection.classList.add('hidden');
        clearManualSelectors();
    } else {
        enableManualSelectors();
    }
    
    // URL analiz butonunu başlangıçta devre dışı bırak
    const analyzeBtn = document.getElementById('analyzePageBtn');
    if (analyzeBtn) {
        analyzeBtn.disabled = true;
        analyzeBtn.classList.add('opacity-50', 'cursor-not-allowed');
    }
    
    // URL değişikliklerini dinle
    const urlInput = document.getElementById('url');
    if (urlInput) {
        urlInput.addEventListener('input', onUrlChange);
    }
    
    // Global değişkenleri başlat
    window.originalSourceLoaded = false;
    window.formattedSourceLoaded = false;
    window.currentAnalysisData = null;
});

// Modal dışına tıklanınca kapat
document.addEventListener('click', function(e) {
    if (e.target.classList.contains('modal-overlay')) {
        e.target.classList.remove('active');
    }
});

// ESC tuşu ile modal kapatma
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        const modals = document.querySelectorAll('.modal-overlay.active');
        modals.forEach(modal => modal.classList.remove('active'));
    }
});
</script>
{% endblock %}