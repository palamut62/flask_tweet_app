{% extends "base.html" %}

{% block title %}Tweet Olu≈ütur{% endblock %}

{% block content %}
<!-- Twitter Feed Style -->
<div class="twitter-feed">
    <!-- Header -->
    <div class="feed-header">
        <div class="d-flex align-items-center justify-content-between">
            <div>
                <h1 class="feed-title">Tweet Olu≈ütur</h1>
                <p class="feed-subtitle">Yeni tweet olu≈üturun ve AI ile optimize edin</p>
            </div>
            <div>
                <button onclick="location.reload();" class="twitter-btn twitter-btn-secondary">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </div>
        </div>
    </div>



    <!-- Tweet Olu≈üturma Formu -->
    <div class="tweet-card">
        <!-- Tweet Tema Se√ßimi -->
        <div class="tweet-section">
            <div class="section-header">
                <i class="fas fa-palette text-blue-500"></i>
                <span class="section-title">Tweet Temasƒ±</span>
            </div>
            <div class="section-content">
                <select id="tweet_theme" name="tweet_theme" class="form-select">
                    <option value="bilgilendirici" {% if default_theme == 'bilgilendirici' or not default_theme %}selected{% endif %}>üìä Bilgilendirici - Profesyonel ve eƒüitici</option>
                    <option value="eƒülenceli" {% if default_theme == 'eƒülenceli' %}selected{% endif %}>üéâ Eƒülenceli - Ne≈üeli ve heyecanlƒ±</option>
                    <option value="mizahi" {% if default_theme == 'mizahi' %}selected{% endif %}>üòÇ Mizahi - Komik ve esprili</option>
                    <option value="resmi" {% if default_theme == 'resmi' %}selected{% endif %}>üì¢ Resmi - Ciddi ve otoriteye dayalƒ±</option>
                    <option value="heyecanlƒ±" {% if default_theme == 'heyecanlƒ±' %}selected{% endif %}>üî• Heyecanlƒ± - Dinamik ve ilham verici</option>
                    <option value="meraklƒ±" {% if default_theme == 'meraklƒ±' %}selected{% endif %}>ü§î Meraklƒ± - Sorgulayƒ±cƒ± ve d√º≈ü√ºnd√ºr√ºc√º</option>
                </select>
                <p class="form-help">
                    <i class="fas fa-info-circle"></i> Se√ßilen temaya g√∂re tweet tarzƒ±, emoji ve hashtag'ler otomatik ayarlanacak
                </p>
            </div>
        </div>

        <div class="tweet-form-section expanded">
                <div class="tweet-tabs">
                    <button id="tab-text" class="tab-button active">
                        <i class="fas fa-keyboard"></i>
                        <span>Metinden Tweet</span>
                    </button>
                    <button id="tab-image" class="tab-button">
                        <i class="fas fa-image"></i>
                        <span>Resimden Tweet</span>
                    </button>
                    <button id="tab-link" class="tab-button">
                        <i class="fas fa-link"></i>
                        <span>Link'ten Tweet</span>
                    </button>
                </div>

                <form method="POST" enctype="multipart/form-data" class="tweet-form" id="tweet-form">
                    <input type="hidden" name="tweet_mode" id="tweet_mode" value="text">
                    <input type="hidden" name="tweet_theme" id="hidden_tweet_theme" value="bilgilendirici">
                    
                    <!-- Metinden Tweet Sekmesi -->
                    <div id="text-content" class="tab-content active">
                        <div class="form-group">
                            <label for="tweet_text" class="form-label">
                                <i class="fas fa-edit text-blue-500"></i> Tweet Metni
                            </label>
                            <textarea 
                                name="tweet_text" 
                                id="tweet_text" 
                                rows="4" 
                                class="form-textarea"
                                placeholder="Tweet i√ßin metin girin... AI ile optimize edilecek."
                            ></textarea>
                            <div class="form-footer">
                                <span class="form-help">
                                    <i class="fas fa-info-circle"></i> AI ile optimize edilecek
                                </span>
                                <span id="text-char-count" class="char-count">0 karakter</span>
                            </div>
                        </div>
                    </div>

                    <!-- Resimden Tweet Sekmesi -->
                    <div id="image-content" class="tab-content">
                        <div class="form-group">
                            <label for="tweet_image" class="form-label">
                                <i class="fas fa-upload text-blue-500"></i> Resim Y√ºkle
                            </label>
                            <input 
                                type="file" 
                                name="tweet_image" 
                                id="tweet_image" 
                                accept="image/jpeg,image/png,image/gif,image/webp"
                                class="form-file"
                                onchange="previewImage(this)"
                            >
                            <p class="form-help">
                                <i class="fas fa-info-circle"></i> Desteklenen formatlar: JPEG, PNG, GIF, WebP (Max: 5MB)
                            </p>
                            <!-- Resim √ñnizlemesi -->
                            <div id="image-preview" class="image-preview hidden">
                                <img id="preview-img" src="" alt="√ñnizleme" class="preview-image">
                                <button type="button" onclick="removeImage()" class="remove-btn">
                                    <i class="fas fa-times"></i> Kaldƒ±r
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Link'ten Tweet Sekmesi -->
                    <div id="link-content" class="tab-content">
                        <div class="form-group">
                            <label for="tweet_url" class="form-label">
                                <i class="fas fa-globe text-blue-500"></i> Web Sitesi URL'si
                            </label>
                            <div class="url-input-group">
                                <input 
                                    type="url" 
                                    name="tweet_url" 
                                    id="tweet_url" 
                                    class="form-input"
                                    placeholder="https://example.com/article"
                                >
                                <button type="button" onclick="fetchUrlContent()" class="url-fetch-btn">
                                    <i class="fas fa-download"></i> ƒ∞√ßeriƒüi √áek
                                </button>
                            </div>
                            <div id="url-status" class="url-status hidden"></div>
                            <p class="form-help">
                                <i class="fas fa-info-circle"></i> Link i√ßeriƒüi MCP ile √ßekilip AI ile tweet olu≈üturulacak
                            </p>
                            
                            <!-- URL √ñnizlemesi -->
                            <div id="url-preview" class="url-preview hidden">
                                <div class="url-preview-header">
                                    <i class="fas fa-link text-blue-500"></i>
                                    <span>Link √ñnizlemesi</span>
                                </div>
                                <div class="url-preview-content">
                                    <div class="url-preview-image">
                                        <img id="url-image" src="" alt="Link √ñnizleme" class="preview-image">
                                    </div>
                                    <div class="url-preview-text">
                                        <h4 id="url-title" class="url-title"></h4>
                                        <p id="url-description" class="url-description"></p>
                                        <p id="url-domain" class="url-domain"></p>
                                        <div class="url-meta">
                                            <span id="url-author" class="url-author"></span>
                                            <span id="url-date" class="url-date"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Link ƒ∞√ßeriƒüi √ñzeti -->
                            <div id="url-summary" class="url-summary hidden">
                                <div class="summary-header">
                                    <i class="fas fa-file-alt text-green-500"></i>
                                    <span>ƒ∞√ßerik √ñzeti</span>
                                </div>
                                <div class="summary-content">
                                    <p id="url-summary-text" class="summary-text"></p>
                                    <div class="summary-stats">
                                        <span id="url-word-count" class="stat-item">
                                            <i class="fas fa-font"></i> <span>0</span> kelime
                                        </span>
                                        <span id="url-char-count" class="stat-item">
                                            <i class="fas fa-text-width"></i> <span>0</span> karakter
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Taslak Kaydetme Se√ßeneƒüi -->
                    <div class="draft-section">
                        <label class="draft-checkbox">
                            <input type="checkbox" name="save_as_draft" id="save_as_draft">
                            <span class="draft-label">
                                <i class="fas fa-save text-yellow-500"></i> Taslak olarak kaydet (hen√ºz payla≈üma)
                            </span>
                        </label>
                        <p class="draft-help">
                            Tweet olu≈üturulacak ancak otomatik payla≈üƒ±lmayacak. Daha sonra manuel olarak payla≈üabilirsiniz.
                        </p>
                    </div>

                    <div class="form-actions">
                        <button 
                            type="submit" 
                            name="action" 
                            value="preview"
                            class="action-btn action-btn-primary"
                        >
                            <i class="fas fa-magic"></i>
                            <span>Tweet Olu≈ütur ve √ñnizle</span>
                        </button>
                        <button 
                            type="submit" 
                            name="action" 
                            value="direct_post"
                            class="action-btn action-btn-success"
                        >
                            <i class="fas fa-rocket"></i>
                            <span>Olu≈ütur ve Hemen Payla≈ü</span>
                        </button>
                    </div>
                    <div class="form-note">
                        <p>
                            <i class="fas fa-info-circle"></i> 
                            "Hemen Payla≈ü" se√ßeneƒüi tweet'i olu≈üturup otomatik olarak pending tweets'e ekler
                        </p>
                    </div>
                                </form>
            </div>

        <!-- Olu≈üturulan Tweet Sonucu -->
        {% if generated_tweet %}
        <div class="tweet-card">
            <div class="tweet-header">
                <div class="tweet-avatar">
                    <i class="fas fa-magic"></i>
                </div>
                <div class="tweet-user-info">
                    <span class="tweet-username">AI Tweet Bot</span>
                    <span class="tweet-handle">@aitweetbot</span>
                    <span class="tweet-time">‚Ä¢ ≈ûimdi</span>
                </div>
                <!-- Tweet Durum Bilgisi -->
                {% if tweet_id %}
                <div class="status-indicator {% if is_draft %}status-warning{% else %}status-online{% endif %}">
                    {% if is_draft %}
                        <i class="fas fa-save"></i> Taslak
                    {% else %}
                        <i class="fas fa-check"></i> Hazƒ±r
                    {% endif %}
                </div>
                {% endif %}
            </div>
            
            <!-- Tweet Content -->
            <div class="tweet-content">
                <p>{{ generated_tweet }}</p>
            </div>
            
            <!-- Tweet Actions -->
            <div class="tweet-actions">
                <!-- Character Count -->
                <div class="tweet-action">
                    <i class="fas fa-text-width tweet-action-icon"></i>
                    <span>{{ generated_tweet|length }}/280</span>
                    {% if generated_tweet|length > 280 %}
                    <span class="text-danger ms-1">
                        <i class="fas fa-exclamation-triangle"></i>
                    </span>
                    {% elif generated_tweet|length > 250 %}
                    <span class="text-warning ms-1">
                        <i class="fas fa-exclamation-circle"></i>
                    </span>
                    {% else %}
                    <span class="text-success ms-1">
                        <i class="fas fa-check-circle"></i>
                    </span>
                    {% endif %}
                </div>
                
                <!-- Tweet Preview -->
                <div class="tweet-action">
                    <i class="fas fa-eye tweet-action-icon"></i>
                    <span>√ñnizleme</span>
                </div>
                
                <!-- Kopyala -->
                <button class="tweet-action" onclick="copyTweet()">
                    <i class="fas fa-copy tweet-action-icon"></i>
                    <span>Kopyala</span>
                </button>
                
                <!-- API ile Payla≈ü -->
                {% if tweet_id and not is_draft %}
                <button class="tweet-action retweet" onclick="postManualTweet('{{ tweet_id }}')">
                    <i class="fab fa-twitter tweet-action-icon"></i>
                    <span>API ile Payla≈ü</span>
                </button>
                {% endif %}
                
                <!-- X'te Payla≈ü -->
                <a href="https://twitter.com/intent/tweet?text={{ generated_tweet|urlencode }}" 
                   target="_blank"
                   class="tweet-action">
                    <i class="fab fa-twitter tweet-action-icon"></i>
                    <span>X'te Payla≈ü</span>
                </a>
                
                <!-- D√ºzenle -->
                <button class="tweet-action" onclick="editTweet()">
                    <i class="fas fa-edit tweet-action-icon"></i>
                    <span>D√ºzenle</span>
                </button>
                
                <!-- Farklƒ± Varyasyon -->
                <button class="tweet-action" onclick="generateVariation()">
                    <i class="fas fa-sync-alt tweet-action-icon"></i>
                    <span>Farklƒ± Varyasyon</span>
                </button>
                
                <!-- Sil -->
                {% if tweet_id %}
                <button class="tweet-action delete" onclick="deleteManualTweet('{{ tweet_id }}')">
                    <i class="fas fa-trash tweet-action-icon"></i>
                    <span>Sil</span>
                </button>
                {% endif %}
            </div>
            
            <!-- Tweet Durum Bilgisi -->
            {% if tweet_id %}
            <div class="tweet-footer">
                <div class="d-flex align-items-center justify-content-between">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-database text-blue-500 me-2"></i>
                        <span class="text-muted small">Tweet ID: {{ tweet_id }}</span>
                    </div>
                    <button onclick="viewTweetDetails('{{ tweet_id }}')" class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-info-circle"></i> Detaylar
                    </button>
                </div>
            </div>
            {% endif %}
        </div>
        {% endif %}
    </div>
</div>

<!-- Loading Modal -->
<div id="loading-modal" class="loading-modal hidden">
    <div class="loading-content">
        <div class="loading-spinner"></div>
        <h3 class="loading-title">Tweet Olu≈üturuluyor</h3>
        <p id="loading-text" class="loading-text">AI ile tweet metni hazƒ±rlanƒ±yor...</p>
        <div class="loading-progress">
            <div id="loading-progress-bar" class="loading-progress-bar"></div>
        </div>
    </div>
</div>

<script>
// Global deƒüi≈ükenler
let currentTheme = '{{ default_theme|default("bilgilendirici") }}';
let isGenerating = false;

// Tema bilgileri
const themeData = {
  'bilgilendirici': {
    emoji: 'üìä',
    name: 'Bilgilendirici',
    description: 'Profesyonel ve eƒüitici tarzda tweet\'ler olu≈üturur',
    hashtags: '#AI #Tech #Innovation #Technology',
    color: 'blue'
  },
  'eƒülenceli': {
    emoji: 'üéâ',
    name: 'Eƒülenceli',
    description: 'Ne≈üeli ve heyecanlƒ± tarzda tweet\'ler olu≈üturur',
    hashtags: '#TechFun #Innovation #Cool #Amazing',
    color: 'green'
  },
  'mizahi': {
    emoji: 'üòÇ',
    name: 'Mizahi',
    description: 'Komik ve esprili tarzda tweet\'ler olu≈üturur',
    hashtags: '#TechHumor #AILife #TechJokes #FunnyTech',
    color: 'yellow'
  },
  'resmi': {
    emoji: 'üì¢',
    name: 'Resmi',
    description: 'Ciddi ve otoriteye dayalƒ± tarzda tweet\'ler olu≈üturur',
    hashtags: '#TechNews #Industry #Business #Official',
    color: 'gray'
  },
  'heyecanlƒ±': {
    emoji: 'üî•',
    name: 'Heyecanlƒ±',
    description: 'Dinamik ve ilham verici tarzda tweet\'ler olu≈üturur',
    hashtags: '#Breakthrough #GameChanger #Innovation #Exciting',
    color: 'red'
  },
  'meraklƒ±': {
    emoji: 'ü§î',
    name: 'Meraklƒ±',
    description: 'Sorgulayƒ±cƒ± ve d√º≈ü√ºnd√ºr√ºc√º tarzda tweet\'ler olu≈üturur',
    hashtags: '#TechCuriosity #WhatIf #Thinking #Questions',
    color: 'purple'
  }
};

// Sayfa y√ºklendiƒüinde
document.addEventListener('DOMContentLoaded', function() {
  // Tema dropdown'ƒ±ndan mevcut deƒüeri al
  const themeSelect = document.getElementById('tweet_theme');
  if (themeSelect) {
    currentTheme = themeSelect.value;
    document.getElementById('hidden_tweet_theme').value = currentTheme;
  }
  
  // Tema deƒüi≈üikliƒüi dinleyicisi
  document.getElementById('tweet_theme').addEventListener('change', function() {
    currentTheme = this.value;
    document.getElementById('hidden_tweet_theme').value = currentTheme;
  });
  
  // Tweet text input dinleyicisi - √ñnizleme i√ßin
  const tweetTextArea = document.getElementById('tweet_text');
  if (tweetTextArea) {
    tweetTextArea.addEventListener('input', function() {
      updateCharacterCount(this);
    });
  }
  
  // URL input dinleyicisi
  const tweetUrlInput = document.getElementById('tweet_url');
  if (tweetUrlInput) {
    tweetUrlInput.addEventListener('input', function() {
      validateUrl(this);
    });
  }
  
  // Form g√∂nderimi dinleyicisi
  document.getElementById('tweet-form').addEventListener('submit', function(e) {
    if (isGenerating) {
      e.preventDefault();
      return;
    }
    
    showLoadingModal();
    isGenerating = true;
    
    // Submit butonunu devre dƒ±≈üƒ± bƒ±rak
    const submitBtn = document.getElementById('submit-btn');
    submitBtn.disabled = true;
    submitBtn.classList.add('opacity-50', 'cursor-not-allowed');
  });
});

// Karakter sayƒ±sƒ±nƒ± g√ºncelle
function updateCharacterCount(textarea) {
  const count = textarea.value.length;
  const countElement = document.getElementById('text-char-count');
  if (countElement) {
    countElement.textContent = count + ' karakter';
    
    // Renk deƒüi≈üimi
    if (count > 270) {
      countElement.style.color = '#dc2626'; // Kƒ±rmƒ±zƒ±
    } else if (count > 240) {
      countElement.style.color = '#d97706'; // Turuncu
    } else {
      countElement.style.color = '#6b7280'; // Gri
    }
  }
}



// Karakter sayacƒ±nƒ± g√ºncelle
function updateCharacterCount(element) {
  try {
    const count = element.value.length;
    const countElement = document.getElementById('text-char-count');
    
    if (countElement) {
      countElement.textContent = `${count} karakter`;
      
      // Renk deƒüi≈üimi
      if (count > 250) {
        countElement.className = 'text-sm text-red-500 font-medium';
      } else if (count > 200) {
        countElement.className = 'text-sm text-yellow-500 font-medium';
      } else {
        countElement.className = 'text-sm text-gray-500';
      }
    }
    

    
    console.log('Karakter sayƒ±sƒ± g√ºncellendi:', count); // Debug log
    
  } catch (error) {
    console.error('Karakter sayacƒ± g√ºncelleme hatasƒ±:', error);
  }
}

// Hashtag ve emoji sayƒ±sƒ±nƒ± g√ºncelle
function updateTweetStats(text) {
  try {
    const hashtagCount = text ? (text.match(/#\w+/g) || []).length : 0;
    const emojiCount = text ? (text.match(/[\u{1F600}-\u{1F64F}]|[\u{1F300}-\u{1F5FF}]|[\u{1F680}-\u{1F6FF}]|[\u{1F1E0}-\u{1F1FF}]|[\u{2600}-\u{26FF}]|[\u{2700}-\u{27BF}]/gu) || []).length : 0;
    
    const hashtagElement = document.getElementById('hashtag-count');
    const emojiElement = document.getElementById('emoji-count');
    
    if (hashtagElement) hashtagElement.textContent = hashtagCount;
    if (emojiElement) emojiElement.textContent = emojiCount;
    
  } catch (error) {
    console.error('Tweet istatistik g√ºncelleme hatasƒ±:', error);
  }
}

// Tab deƒüi≈ütirme fonksiyonlarƒ±
function switchTab(activeTab, activeContent) {
  // T√ºm tab'larƒ± pasif yap
  document.querySelectorAll('.tab-button').forEach(tab => {
    tab.classList.remove('active');
  });
  
  // T√ºm i√ßerikleri gizle
  document.querySelectorAll('.tab-content').forEach(content => {
    content.classList.remove('active');
  });
  
  // Aktif tab'ƒ± g√∂ster
  activeTab.classList.add('active');
  activeContent.classList.add('active');
}

// Tab event listener'larƒ±
document.getElementById('tab-text').addEventListener('click', function() {
  document.getElementById('tweet_mode').value = 'text';
  switchTab(this, document.getElementById('text-content'));
});

document.getElementById('tab-image').addEventListener('click', function() {
  document.getElementById('tweet_mode').value = 'image';
  switchTab(this, document.getElementById('image-content'));
});

document.getElementById('tab-link').addEventListener('click', function() {
  document.getElementById('tweet_mode').value = 'link';
  switchTab(this, document.getElementById('link-content'));
});

// Resim √∂nizleme
function previewImage(input) {
  if (input.files && input.files[0]) {
    const file = input.files[0];
    
    // Dosya boyutu kontrol√º (5MB)
    if (file.size > 5 * 1024 * 1024) {
      showToast('Dosya boyutu 5MB\'dan b√ºy√ºk olamaz!', 'error');
      input.value = '';
      return;
    }
    
    const reader = new FileReader();
    reader.onload = function(e) {
      document.getElementById('preview-img').src = e.target.result;
      document.getElementById('image-preview').classList.remove('hidden');
    };
    reader.readAsDataURL(file);
  }
}

// Resim kaldƒ±rma
function removeImage() {
  document.getElementById('tweet_image').value = '';
  document.getElementById('image-preview').classList.add('hidden');
}

// URL doƒürulama
function validateUrl(input) {
  const url = input.value.trim();
  const statusElement = document.getElementById('url-status');
  
  if (!url) {
    statusElement.classList.add('hidden');
    return;
  }
  
  try {
    new URL(url);
    statusElement.className = 'url-status success';
    statusElement.innerHTML = '<i class="fas fa-check-circle"></i> Ge√ßerli URL';
    statusElement.classList.remove('hidden');
    
    // URL √∂nizlemesi i√ßin basit bilgi g√∂ster
    const domain = new URL(url).hostname;
    document.getElementById('url-domain').textContent = domain;
    document.getElementById('url-title').textContent = 'URL √ñnizlemesi';
    document.getElementById('url-description').textContent = 'ƒ∞√ßerik √ßekilecek ve AI ile tweet olu≈üturulacak';
    document.getElementById('url-preview').classList.remove('hidden');
    
  } catch (e) {
    statusElement.className = 'url-status error';
    statusElement.innerHTML = '<i class="fas fa-exclamation-circle"></i> Ge√ßersiz URL formatƒ±';
    statusElement.classList.remove('hidden');
    document.getElementById('url-preview').classList.add('hidden');
  }
}

// Loading modal g√∂ster
function showLoadingModal() {
  document.getElementById('loading-modal').classList.remove('hidden');
  
  // Progress bar animasyonu
  let progress = 0;
  const progressBar = document.getElementById('loading-progress-bar');
  const loadingText = document.getElementById('loading-text');
  
  const messages = [
    'AI ile tweet metni hazƒ±rlanƒ±yor...',
    'ƒ∞√ßerik analiz ediliyor...',
    'Tema √∂zellikleri uygulanƒ±yor...',
    'Tweet optimize ediliyor...',
    'Son kontroller yapƒ±lƒ±yor...'
  ];
  
  let messageIndex = 0;
  
  const interval = setInterval(() => {
    progress += 20;
    progressBar.style.width = `${progress}%`;
    
    if (messageIndex < messages.length) {
      loadingText.textContent = messages[messageIndex];
      messageIndex++;
    }
    
    if (progress >= 100) {
      clearInterval(interval);
    }
  }, 800);
}

// Loading modal gizle
function hideLoadingModal() {
  document.getElementById('loading-modal').classList.add('hidden');
  
  // Submit butonunu tekrar aktif et
  const submitBtn = document.getElementById('submit-btn');
  submitBtn.disabled = false;
  submitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
  isGenerating = false;
}

// Tweet kopyalama
function copyTweet() {
  const tweetElement = document.querySelector('.tweet-card .tweet-content p');
  if (!tweetElement) {
    showToast('Kopyalanacak tweet bulunamadƒ±!', 'error');
    return;
  }
  
  const tweetText = tweetElement.textContent.trim();
  
  navigator.clipboard.writeText(tweetText).then(function() {
    showToast('Tweet ba≈üarƒ±yla kopyalandƒ±!', 'success');
  }).catch(function(err) {
    showToast('Kopyalama ba≈üarƒ±sƒ±z: ' + err, 'error');
  });
}

// Tweet d√ºzenleme
function editTweet() {
  const tweetElement = document.querySelector('.tweet-card .tweet-content p');
  if (!tweetElement) {
    showToast('D√ºzenlenecek tweet bulunamadƒ±!', 'error');
    return;
  }
  
  const tweetText = tweetElement.textContent.trim();
  
  document.getElementById('tweet_text').value = tweetText;
  document.getElementById('tab-text').click();
  updateCharacterCount(document.getElementById('tweet_text'));
  
  // Sayfayƒ± yukarƒ± kaydƒ±r
  document.querySelector('.feed-title').scrollIntoView({ behavior: 'smooth' });
}

// Toast Notification Sistemi
function showToast(message, type = 'info') {
  // Toast container olu≈ütur
  let toastContainer = document.getElementById('toast-container');
  if (!toastContainer) {
    toastContainer = document.createElement('div');
    toastContainer.id = 'toast-container';
    toastContainer.className = 'toast-container';
    document.body.appendChild(toastContainer);
  }
  
  // Toast elementi olu≈ütur
  const toast = document.createElement('div');
  toast.className = `toast toast-${type}`;
  
  const icons = {
    success: 'fas fa-check-circle',
    error: 'fas fa-exclamation-circle',
    warning: 'fas fa-exclamation-triangle',
    info: 'fas fa-info-circle'
  };
  
  const titles = {
    success: 'Ba≈üarƒ±lƒ±',
    error: 'Hata',
    warning: 'Uyarƒ±',
    info: 'Bilgi'
  };
  
  toast.innerHTML = `
    <div class="toast-icon">
      <i class="${icons[type]}"></i>
    </div>
    <div class="toast-content">
      <div class="toast-title">${titles[type]}</div>
      <div class="toast-message">${message}</div>
    </div>
    <button class="toast-close" onclick="this.parentElement.remove()">
      <i class="fas fa-times"></i>
    </button>
  `;
  
  toastContainer.appendChild(toast);
  
  // Animasyon
  setTimeout(() => {
    toast.classList.add('show');
  }, 100);
  
  // Otomatik kaldƒ±rma
  setTimeout(() => {
    toast.classList.remove('show');
    setTimeout(() => {
      if (toast.parentElement) {
        toast.remove();
      }
    }, 300);
  }, 5000);
}

// Modern Confirm Dialog Sistemi
function showConfirmDialog(message, onConfirm, onCancel = null, title = 'Onay Gerekli', type = 'warning') {
    // Mevcut dialog varsa kaldƒ±r
    const existingDialog = document.getElementById('confirm-dialog');
    if (existingDialog) {
        existingDialog.remove();
    }
    
    const dialog = document.createElement('div');
    dialog.id = 'confirm-dialog';
    dialog.className = 'confirm-dialog-overlay';
    dialog.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        animation: fadeIn 0.2s ease-out;
    `;
    
    const icon = type === 'danger' ? 'exclamation-triangle' : 
                 type === 'success' ? 'check-circle' : 
                 type === 'info' ? 'info-circle' : 'question-circle';
    
    const iconColor = type === 'danger' ? '#dc3545' : 
                      type === 'success' ? '#28a745' : 
                      type === 'info' ? '#17a2b8' : '#ffc107';
    
    dialog.innerHTML = `
        <div class="confirm-dialog" style="
            background: white;
            border-radius: 12px;
            padding: 24px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            animation: slideIn 0.3s ease-out;
        ">
            <div style="text-align: center; margin-bottom: 20px;">
                <i class="fas fa-${icon}" style="font-size: 48px; color: ${iconColor}; margin-bottom: 16px;"></i>
                <h3 style="margin: 0; color: #333; font-size: 18px; font-weight: 600;">${title}</h3>
            </div>
            <div style="
                color: #666;
                line-height: 1.5;
                margin-bottom: 24px;
                text-align: center;
                white-space: pre-line;
            ">${message}</div>
            <div style="
                display: flex;
                gap: 12px;
                justify-content: center;
            ">
                <button id="confirm-cancel" style="
                    padding: 10px 20px;
                    border: 1px solid #ddd;
                    background: white;
                    color: #666;
                    border-radius: 6px;
                    cursor: pointer;
                    font-size: 14px;
                    transition: all 0.2s;
                " onmouseover="this.style.background='#f8f9fa'" onmouseout="this.style.background='white'">
                    ƒ∞ptal
                </button>
                <button id="confirm-ok" style="
                    padding: 10px 20px;
                    border: none;
                    background: ${iconColor};
                    color: white;
                    border-radius: 6px;
                    cursor: pointer;
                    font-size: 14px;
                    font-weight: 500;
                    transition: all 0.2s;
                " onmouseover="this.style.opacity='0.9'" onmouseout="this.style.opacity='1'">
                    Onayla
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(dialog);
    
    // Event listeners
    const cancelBtn = dialog.querySelector('#confirm-cancel');
    const okBtn = dialog.querySelector('#confirm-ok');
    
    const closeDialog = () => {
        dialog.style.animation = 'fadeOut 0.2s ease-in';
        setTimeout(() => dialog.remove(), 200);
    };
    
    cancelBtn.addEventListener('click', () => {
        closeDialog();
        if (onCancel) onCancel();
    });
    
    okBtn.addEventListener('click', () => {
        closeDialog();
        if (onConfirm) onConfirm();
    });
    
    // ESC tu≈üu ile kapatma
    const handleEsc = (e) => {
        if (e.key === 'Escape') {
            document.removeEventListener('keydown', handleEsc);
            closeDialog();
            if (onCancel) onCancel();
        }
    };
    document.addEventListener('keydown', handleEsc);
    
    // Dƒ±≈üarƒ± tƒ±klayarak kapatma
    dialog.addEventListener('click', (e) => {
        if (e.target === dialog) {
            closeDialog();
            if (onCancel) onCancel();
        }
    });
}

// CSS Animasyonlarƒ±
const confirmDialogStyle = document.createElement('style');
confirmDialogStyle.textContent = `
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    @keyframes fadeOut {
        from { opacity: 1; }
        to { opacity: 0; }
    }
    @keyframes slideIn {
        from { transform: scale(0.9); opacity: 0; }
        to { transform: scale(1); opacity: 1; }
    }
`;
document.head.appendChild(confirmDialogStyle);

// Farklƒ± varyasyon olu≈ütur
function generateVariation() {
  const tweetElement = document.querySelector('.tweet-card .tweet-content p');
  if (!tweetElement) {
    showToast('Varyasyon olu≈üturulacak tweet bulunamadƒ±!', 'error');
    return;
  }
  
  const tweetText = tweetElement.textContent.trim();
  
  showConfirmDialog(
    'Bu tweet i√ßin farklƒ± bir varyasyon olu≈üturmak istediƒüinizden emin misiniz?',
    function() {
      // Mevcut tweet metnini form'a kopyala
      document.getElementById('tweet_text').value = tweetText;
      document.getElementById('tab-text').click();
      
      // Form'u g√∂nder
      const form = document.getElementById('tweet-form');
      const actionInput = document.createElement('input');
      actionInput.type = 'hidden';
      actionInput.name = 'action';
      actionInput.value = 'preview';
      form.appendChild(actionInput);
      
      showLoadingModal();
      form.submit();
    },
    null,
    'Varyasyon Olu≈ütur',
    'info'
  );
}

// Tweet detaylarƒ±nƒ± g√∂r√ºnt√ºle
function viewTweetDetails(tweetId) {
  showToast(`Tweet ID: ${tweetId} detaylarƒ± g√∂r√ºnt√ºleniyor...`, 'info');
  // Burada tweet detaylarƒ± i√ßin modal a√ßƒ±labilir
}

// Sayfa y√ºklendiƒüinde loading modal'ƒ± gizle
window.addEventListener('load', function() {
  hideLoadingModal();
});

// ==============================
// MANUEL TWEET Y√ñNETƒ∞M FONKSƒ∞YONLARI
// ==============================

// Manuel tweet'i payla≈ü
function postManualTweet(tweetId) {
  if (!tweetId) {
    showToast('Tweet ID bulunamadƒ±!', 'error');
    return;
  }
  
  showConfirmDialog(
    'Bu tweet\'i API ile payla≈ümak istediƒüinizden emin misiniz?',
    () => {
      // Loading g√∂ster
      const button = event.target.closest('button');
      const originalContent = button.innerHTML;
      button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Payla≈üƒ±lƒ±yor...';
      button.disabled = true;
      
      fetch(`/api/manual_tweets/${tweetId}/post`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          showToast('‚úÖ Tweet ba≈üarƒ±yla payla≈üƒ±ldƒ±!', 'success');
          
          // Sayfayƒ± yenile veya elementi g√ºncelle
          if (data.tweet_url) {
            window.open(data.tweet_url, '_blank');
          }
          
          // Dinamik g√ºncelleme - sayfa yenilemesi yok
          setTimeout(() => {
            // Tweet listesini g√ºncelle
            if (typeof refreshPendingTweets === 'function') {
              refreshPendingTweets();
            }
            // Sayfa ana sayfaya y√∂nlendir
            window.location.href = '/';
          }, 1000);
          
        } else {
          showToast('‚ùå Hata: ' + data.error, 'error');
          
          // Rate limit durumunda √∂zel mesaj
          if (data.rate_limited) {
            showToast('‚è∞ Twitter API rate limit\'e takƒ±ldƒ±. L√ºtfen daha sonra tekrar deneyin.', 'warning');
          }
        }
      })
      .catch(error => {
        console.error('Tweet payla≈üƒ±m hatasƒ±:', error);
        showToast('‚ùå Bir hata olu≈ütu: ' + error.message, 'error');
      })
      .finally(() => {
        // Button'u eski haline getir
        button.innerHTML = originalContent;
        button.disabled = false;
      });
    },
    null,
    'Tweet Payla≈üƒ±mƒ±',
    'warning'
  );
}

// Manuel tweet'i sil
function deleteManualTweet(tweetId) {
  if (!tweetId) {
    showToast('Tweet ID bulunamadƒ±!', 'error');
    return;
  }
  
  showConfirmDialog(
    'Bu tweet\'i silmek istediƒüinizden emin misiniz? Bu i≈ülem geri alƒ±namaz.',
    () => {
      // Loading g√∂ster
      const button = event.target.closest('button');
      const originalContent = button.innerHTML;
      button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Siliniyor...';
      button.disabled = true;
      
      fetch(`/api/manual_tweets/${tweetId}/delete`, {
        method: 'DELETE',
        headers: {
          'Content-Type': 'application/json',
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          showToast('‚úÖ Tweet ba≈üarƒ±yla silindi!', 'success');
          
          // Sayfayƒ± yenile veya elementi kaldƒ±r
          setTimeout(() => {
            if (typeof refreshPendingTweets === 'function') {
              refreshPendingTweets();
            } else {
              location.reload();
            }
          }, 1000);
          
        } else {
          showToast('‚ùå Hata: ' + data.error, 'error');
        }
      })
      .catch(error => {
        console.error('Tweet silme hatasƒ±:', error);
        showToast('‚ùå Bir hata olu≈ütu: ' + error.message, 'error');
      })
      .finally(() => {
        // Button'u eski haline getir
        button.innerHTML = originalContent;
        button.disabled = false;
      });
    },
    null,
    'Tweet Silme',
    'danger'
  );
  return;
  
  // Loading g√∂ster
  const button = event.target.closest('button');
  const originalContent = button.innerHTML;
  button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
  button.disabled = true;
  
  fetch(`/api/manual_tweets/${tweetId}/delete`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      showToast('‚úÖ Tweet ba≈üarƒ±yla silindi!', 'success');
      
      // Elementi DOM'dan kaldƒ±r
      const tweetElement = button.closest('.bg-white');
      if (tweetElement) {
        tweetElement.style.transition = 'all 0.3s ease';
        tweetElement.style.opacity = '0';
        tweetElement.style.transform = 'scale(0.9)';
        
        setTimeout(() => {
          tweetElement.remove();
        }, 300);
      }
      
    } else {
      showToast('‚ùå Hata: ' + data.error, 'error');
    }
  })
  .catch(error => {
    console.error('Tweet silme hatasƒ±:', error);
    showToast('‚ùå Bir hata olu≈ütu: ' + error.message, 'error');
  })
  .finally(() => {
    // Button'u eski haline getir
    button.innerHTML = originalContent;
    button.disabled = false;
  });
}

// Tweet detaylarƒ±nƒ± g√∂r√ºnt√ºle
function viewTweetDetails(tweetId) {
  if (!tweetId) {
    showToast('Tweet ID bulunamadƒ±!', 'error');
    return;
  }
  
  fetch(`/api/manual_tweets/${tweetId}`)
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      const tweet = data.tweet;
      
      // Modal olu≈ütur ve g√∂ster
      showTweetDetailsModal(tweet);
      
    } else {
      showToast('‚ùå Tweet detaylarƒ± alƒ±namadƒ±: ' + data.error, 'error');
    }
  })
  .catch(error => {
    console.error('Tweet detay hatasƒ±:', error);
    showToast('‚ùå Bir hata olu≈ütu: ' + error.message, 'error');
  });
}

// Tweet detay modal'ƒ±nƒ± g√∂ster
function showTweetDetailsModal(tweet) {
  // Modal HTML'i olu≈ütur
  const modalHTML = `
    <div id="tweet-detail-modal" class="tweet-detail-modal">
      <div class="tweet-detail-overlay"></div>
      <div class="tweet-detail-container">
        <!-- Modal Header -->
        <div class="tweet-detail-header">
          <div class="tweet-detail-title">
            <i class="fas fa-info-circle"></i>
            <span>Tweet Detaylarƒ±</span>
          </div>
          <button onclick="closeTweetDetailsModal()" class="tweet-detail-close">
            <i class="fas fa-times"></i>
          </button>
        </div>
        
        <!-- Tweet Content Section -->
        <div class="tweet-detail-content">
          <div class="tweet-detail-section">
            <div class="tweet-detail-section-header">
              <i class="fas fa-comment"></i>
              <span>Tweet ƒ∞√ßeriƒüi</span>
            </div>
            <div class="tweet-detail-tweet-content">
              <p>${tweet.content}</p>
            </div>
            <div class="tweet-detail-stats">
              <div class="tweet-stat">
                <i class="fas fa-text-width"></i>
                <span>${tweet.char_count}/280 karakter</span>
              </div>
              <div class="tweet-stat">
                <i class="fas fa-hashtag"></i>
                <span>${tweet.hashtag_count} hashtag</span>
              </div>
              <div class="tweet-stat">
                <i class="fas fa-smile"></i>
                <span>${tweet.emoji_count} emoji</span>
              </div>
            </div>
          </div>
          
          <!-- Tweet Info Section -->
          <div class="tweet-detail-section">
            <div class="tweet-detail-section-header">
              <i class="fas fa-cog"></i>
              <span>Tweet Bilgileri</span>
            </div>
            <div class="tweet-detail-info-grid">
              <div class="tweet-detail-info-item">
                <span class="info-label">Tweet ID:</span>
                <span class="info-value">${tweet.id}</span>
              </div>
              <div class="tweet-detail-info-item">
                <span class="info-label">Durum:</span>
                <span class="info-badge ${tweet.status === 'draft' ? 'status-draft' : 
                  tweet.status === 'ready' ? 'status-ready' : 
                  tweet.status === 'posted' ? 'status-posted' : 'status-unknown'}">
                  ${tweet.status === 'draft' ? 'Taslak' : 
                    tweet.status === 'ready' ? 'Hazƒ±r' :
                    tweet.status === 'posted' ? 'Payla≈üƒ±ldƒ±' : tweet.status}
                </span>
              </div>
              <div class="tweet-detail-info-item">
                <span class="info-label">Tema:</span>
                <span class="info-value">${tweet.theme || 'Belirtilmemi≈ü'}</span>
              </div>
              <div class="tweet-detail-info-item">
                <span class="info-label">Olu≈üturulma:</span>
                <span class="info-value">${new Date(tweet.created_at).toLocaleString('tr-TR')}</span>
              </div>
              <div class="tweet-detail-info-item">
                <span class="info-label">Kaynak T√ºr√º:</span>
                <span class="info-value">${
                  tweet.source_data?.type === 'text' ? 'Metin' :
                  tweet.source_data?.type === 'url' ? 'URL' :
                  tweet.source_data?.type === 'image' ? 'Resim' : 'Bilinmiyor'
                }</span>
              </div>
              ${tweet.is_posted ? `
                <div class="tweet-detail-info-item">
                  <span class="info-label">Payla≈üƒ±m Tarihi:</span>
                  <span class="info-value">${new Date(tweet.posted_at).toLocaleString('tr-TR')}</span>
                </div>
                ${tweet.posted_url ? `
                  <div class="tweet-detail-info-item">
                    <span class="info-label">Tweet URL:</span>
                    <a href="${tweet.posted_url}" target="_blank" class="info-link">
                      <i class="fas fa-external-link-alt"></i>
                      <span>G√∂r√ºnt√ºle</span>
                    </a>
                  </div>
                ` : ''}
              ` : ''}
            </div>
          </div>
          
          <!-- Source Data Section -->
          ${tweet.source_data ? `
            <div class="tweet-detail-section">
              <div class="tweet-detail-section-header">
                <i class="fas fa-link"></i>
                <span>Kaynak Bilgileri</span>
              </div>
              <div class="tweet-detail-source">
                ${tweet.source_data.type === 'url' ? `
                  <div class="source-info">
                    <div class="source-item">
                      <span class="source-label">URL:</span>
                      <a href="${tweet.source_data.source_url}" target="_blank" class="source-link">
                        ${tweet.source_data.source_url}
                      </a>
                    </div>
                    ${tweet.source_data.fetched_title ? `
                      <div class="source-item">
                        <span class="source-label">Ba≈ülƒ±k:</span>
                        <span class="source-value">${tweet.source_data.fetched_title}</span>
                      </div>
                    ` : ''}
                  </div>
                ` : tweet.source_data.type === 'image' ? `
                  <div class="source-info">
                    <div class="source-item">
                      <span class="source-label">Dosya:</span>
                      <span class="source-value">${tweet.source_data.original_filename}</span>
                    </div>
                    ${tweet.source_data.ocr_text ? `
                      <div class="source-item">
                        <span class="source-label">OCR Metni:</span>
                        <span class="source-value">${tweet.source_data.ocr_text.substring(0, 100)}...</span>
                      </div>
                    ` : ''}
                  </div>
                ` : tweet.source_data.type === 'text' ? `
                  <div class="source-info">
                    <div class="source-item">
                      <span class="source-label">Orijinal Metin:</span>
                      <span class="source-value">${tweet.source_data.original_text.substring(0, 100)}...</span>
                    </div>
                  </div>
                ` : ''}
              </div>
            </div>
          ` : ''}
        </div>
        
        <!-- Modal Actions -->
        <div class="tweet-detail-actions">
          ${!tweet.is_posted ? `
            ${tweet.status === 'ready' ? `
              <button onclick="postManualTweet('${tweet.id}')" class="tweet-detail-btn tweet-detail-btn-primary">
                <i class="fab fa-twitter"></i>
                <span>Payla≈ü</span>
              </button>
            ` : ''}
            <button onclick="deleteManualTweet('${tweet.id}')" class="tweet-detail-btn tweet-detail-btn-danger">
              <i class="fas fa-trash"></i>
              <span>Sil</span>
            </button>
          ` : ''}
          <button onclick="closeTweetDetailsModal()" class="tweet-detail-btn tweet-detail-btn-secondary">
            <i class="fas fa-times"></i>
            <span>Kapat</span>
          </button>
        </div>
      </div>
    </div>
  `;
  
  // Modal'ƒ± DOM'a ekle
  document.body.insertAdjacentHTML('beforeend', modalHTML);
}

// Tweet detay modal'ƒ±nƒ± kapat
function closeTweetDetailsModal() {
  const modal = document.getElementById('tweet-detail-modal');
  if (modal) {
    modal.remove();
  }
}

// T√ºm manuel tweet'leri y√ºkle
function loadAllManualTweets() {
  fetch('/api/manual_tweets')
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      showAllTweetsModal(data.tweets, data.stats);
    } else {
      showToast('‚ùå Tweetler y√ºklenemedi: ' + data.error, 'error');
    }
  })
  .catch(error => {
    console.error('Tweet y√ºkleme hatasƒ±:', error);
    showToast('‚ùå Bir hata olu≈ütu: ' + error.message, 'error');
  });
}

// T√ºm tweet'ler modal'ƒ±nƒ± g√∂ster
function showAllTweetsModal(tweets, stats) {
  const modalHTML = `
    <div id="all-tweets-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div class="bg-white rounded-lg p-6 max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-xl font-bold text-gray-900">T√ºm Manuel Tweet'ler</h3>
          <button onclick="closeAllTweetsModal()" class="text-gray-500 hover:text-gray-700">
            <i class="fas fa-times text-xl"></i>
          </button>
        </div>
        
        <!-- ƒ∞statistikler -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
          <div class="bg-blue-50 p-3 rounded-lg text-center">
            <div class="text-2xl font-bold text-blue-600">${stats.total}</div>
            <div class="text-sm text-blue-800">Toplam</div>
          </div>
          <div class="bg-yellow-50 p-3 rounded-lg text-center">
            <div class="text-2xl font-bold text-yellow-600">${stats.drafts}</div>
            <div class="text-sm text-yellow-800">Taslak</div>
          </div>
          <div class="bg-green-50 p-3 rounded-lg text-center">
            <div class="text-2xl font-bold text-green-600">${stats.ready}</div>
            <div class="text-sm text-green-800">Hazƒ±r</div>
          </div>
          <div class="bg-purple-50 p-3 rounded-lg text-center">
            <div class="text-2xl font-bold text-purple-600">${stats.posted}</div>
            <div class="text-sm text-purple-800">Payla≈üƒ±ldƒ±</div>
          </div>
        </div>
        
        <!-- Tweet Listesi -->
        <div class="space-y-3 max-h-96 overflow-y-auto">
          ${tweets.map(tweet => `
            <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
              <div class="flex justify-between items-start">
                <div class="flex-1">
                  <p class="text-gray-700 mb-2">${tweet.content.length > 150 ? tweet.content.substring(0, 150) + '...' : tweet.content}</p>
                  <div class="flex items-center gap-4 text-xs text-gray-500">
                    <span><i class="fas fa-calendar"></i> ${new Date(tweet.created_at).toLocaleDateString('tr-TR')}</span>
                    <span><i class="fas fa-palette"></i> ${tweet.theme || 'Tema Yok'}</span>
                    <span class="px-2 py-1 rounded ${
                      tweet.status === 'draft' ? 'bg-yellow-100 text-yellow-700' :
                      tweet.status === 'ready' ? 'bg-green-100 text-green-700' :
                      tweet.status === 'posted' ? 'bg-blue-100 text-blue-700' : 'bg-gray-100 text-gray-700'
                    }">
                      ${tweet.status === 'draft' ? 'Taslak' : 
                        tweet.status === 'ready' ? 'Hazƒ±r' :
                        tweet.status === 'posted' ? 'Payla≈üƒ±ldƒ±' : tweet.status}
                    </span>
                  </div>
                </div>
                <div class="flex gap-2 ml-4">
                  ${!tweet.is_posted && tweet.status === 'ready' ? `
                    <button onclick="postManualTweet('${tweet.id}')" class="text-blue-600 hover:text-blue-800" title="Payla≈ü">
                      <i class="fab fa-twitter"></i>
                    </button>
                  ` : ''}
                  <button onclick="viewTweetDetails('${tweet.id}')" class="text-gray-600 hover:text-gray-800" title="Detaylar">
                    <i class="fas fa-eye"></i>
                  </button>
                  ${!tweet.is_posted ? `
                    <button onclick="deleteManualTweet('${tweet.id}')" class="text-red-600 hover:text-red-800" title="Sil">
                      <i class="fas fa-trash"></i>
                    </button>
                  ` : ''}
                </div>
              </div>
            </div>
          `).join('')}
        </div>
        
        <div class="mt-6 text-center">
          <button onclick="closeAllTweetsModal()" class="px-6 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-all duration-200">
            Kapat
          </button>
        </div>
      </div>
    </div>
  `;
  
  document.body.insertAdjacentHTML('beforeend', modalHTML);
}

// T√ºm tweet'ler modal'ƒ±nƒ± kapat
function closeAllTweetsModal() {
  const modal = document.getElementById('all-tweets-modal');
  if (modal) {
    modal.remove();
  }
}

// Manuel payla≈üƒ±m onayƒ± modal'ƒ±nƒ± g√∂ster
let currentTweetIdToPost = null;

function confirmManualPost(tweetId) {
  currentTweetIdToPost = tweetId;
  
  // Tweet detaylarƒ±nƒ± al
  fetch(`/api/manual_tweets/${tweetId}`)
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      showManualPostConfirmModal(data.tweet);
    } else {
      showToast('‚ùå Tweet bilgileri alƒ±namadƒ±: ' + data.error, 'error');
    }
  })
  .catch(error => {
    console.error('Tweet bilgileri alma hatasƒ±:', error);
    showToast('‚ùå Bir hata olu≈ütu: ' + error.message, 'error');
  });
}

function showManualPostConfirmModal(tweet) {
  const modalHTML = `
    <div id="manual-post-confirm-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div class="bg-white rounded-lg p-6 max-w-lg w-full mx-4">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-lg font-bold text-gray-900">Tweet Payla≈üƒ±m Onayƒ±</h3>
          <button onclick="closeManualPostConfirmModal()" class="text-gray-500 hover:text-gray-700">
            <i class="fas fa-times"></i>
          </button>
        </div>
        
        <div class="mb-6 p-4 bg-gray-50 rounded-lg border border-gray-200">
          <h4 class="font-semibold text-gray-800 mb-2">Payla≈üƒ±lacak Tweet:</h4>
          <p class="text-gray-700 whitespace-pre-wrap">${tweet.content}</p>
          <div class="flex justify-between items-center mt-2 text-sm text-gray-500">
            <span>Karakter: ${tweet.char_count}/280</span>
            <span>Tema: ${tweet.theme || 'Belirtilmemi≈ü'}</span>
          </div>
        </div>
        
        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6">
          <div class="flex items-start gap-3">
            <i class="fas fa-exclamation-triangle text-yellow-600 mt-1"></i>
            <div>
              <h4 class="font-medium text-yellow-800">Dikkat!</h4>
              <p class="text-yellow-700 text-sm mt-1">
                Bu tweet Twitter'a payla≈üƒ±lacak. Payla≈üƒ±m i≈ülemi geri alƒ±namaz.
              </p>
            </div>
          </div>
        </div>
        
        <div class="flex gap-3 justify-end">
          <button onclick="closeManualPostConfirmModal()" 
                  class="px-4 py-2 text-gray-600 border border-gray-300 rounded-lg hover:bg-gray-50">
            ƒ∞ptal
          </button>
          <button onclick="executeManualPost()" 
                  class="px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 font-medium">
            <i class="fab fa-twitter"></i> Payla≈ü
          </button>
        </div>
      </div>
    </div>
  `;
  
  document.body.insertAdjacentHTML('beforeend', modalHTML);
}

function closeManualPostConfirmModal() {
  const modal = document.getElementById('manual-post-confirm-modal');
  if (modal) {
    modal.remove();
  }
  currentTweetIdToPost = null;
}

function executeManualPost() {
  if (!currentTweetIdToPost) {
    showToast('‚ùå Tweet ID bulunamadƒ±!', 'error');
    return;
  }
  
  const button = document.querySelector('#manual-post-confirm-modal button[onclick="executeManualPost()"]');
  if (button) {
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Payla≈üƒ±lƒ±yor...';
    button.disabled = true;
  }
  
  fetch(`/api/manual_tweets/${currentTweetIdToPost}/post`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      showToast('‚úÖ Tweet ba≈üarƒ±yla payla≈üƒ±ldƒ±!', 'success');
      closeManualPostConfirmModal();
      // Sayfayƒ± yenile
      window.location.reload();
    } else {
      showToast('‚ùå Tweet payla≈üƒ±lamadƒ±: ' + data.error, 'error');
      if (button) {
        button.innerHTML = '<i class="fab fa-twitter"></i> Payla≈ü';
        button.disabled = false;
      }
    }
  })
  .catch(error => {
    console.error('Tweet payla≈üƒ±m hatasƒ±:', error);
    showToast('‚ùå Bir hata olu≈ütu: ' + error.message, 'error');
    if (button) {
      button.innerHTML = '<i class="fab fa-twitter"></i> Payla≈ü';
      button.disabled = false;
    }
  });
}

// Manuel tweet payla≈üƒ±mƒ± (X.com'da a√ßma)
function manualPostTweetFromCreate(tweetId) {
  // UI feedback - tweet'i ge√ßici olarak devre dƒ±≈üƒ± bƒ±rak
  const tweetElement = document.querySelector(`[data-tweet-id="${tweetId}"]`);
  if (tweetElement) {
    tweetElement.style.opacity = '0.5';
    tweetElement.style.pointerEvents = 'none';
  }
  
  // Tweet detaylarƒ±nƒ± al
  fetch(`/api/manual_tweets/${tweetId}`)
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      const tweet = data.tweet;
      const tweetText = tweet.content;
      
      // Manuel payla≈üƒ±m endpoint'ini √ßaƒüƒ±r
      fetch('/manual_post_tweet', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({tweet_id: tweetId})
      })
      .then(response => response.json())
      .then(manualData => {
        if (manualData.success) {
          // X.com'da yeni sekmede a√ß
          window.open(manualData.x_share_url, '_blank');
          
          // Tweet'i UI'dan kaldƒ±r
          if (tweetElement) {
            tweetElement.style.transition = 'all 0.3s ease';
            tweetElement.style.transform = 'translateX(-100%)';
            tweetElement.style.opacity = '0';
            
            setTimeout(() => {
              tweetElement.remove();
            }, 300);
          }
          
          // Kullanƒ±cƒ±ya bilgi ver
          setTimeout(() => {
            showToast('‚úÖ Tweet manuel olarak payla≈üƒ±ldƒ± ve kaydedildi!', 'success');
          }, 500);
          
        } else {
          // Hata durumunda UI'ƒ± geri y√ºkle
          if (tweetElement) {
            tweetElement.style.opacity = '1';
            tweetElement.style.pointerEvents = 'auto';
          }
          showToast('‚ùå Manuel payla≈üƒ±m hatasƒ±: ' + manualData.error, 'error');
        }
      })
      .catch(error => {
        console.error('Manuel payla≈üƒ±m hatasƒ±:', error);
        // Hata durumunda UI'ƒ± geri y√ºkle
        if (tweetElement) {
          tweetElement.style.opacity = '1';
          tweetElement.style.pointerEvents = 'auto';
        }
        showToast('‚ùå Manuel payla≈üƒ±m sƒ±rasƒ±nda bir hata olu≈ütu!', 'error');
      });
      
    } else {
      // Hata durumunda UI'ƒ± geri y√ºkle
      if (tweetElement) {
        tweetElement.style.opacity = '1';
        tweetElement.style.pointerEvents = 'auto';
      }
      showToast('‚ùå Tweet bilgileri alƒ±namadƒ±: ' + data.error, 'error');
    }
  })
  .catch(error => {
    console.error('Tweet bilgileri alma hatasƒ±:', error);
    // Hata durumunda UI'ƒ± geri y√ºkle
    if (tweetElement) {
      tweetElement.style.opacity = '1';
      tweetElement.style.pointerEvents = 'auto';
    }
    showToast('‚ùå Bir hata olu≈ütu: ' + error.message, 'error');
  });
}

// Toast notification system
function showToast(message, type = 'info') {
    // Create toast container if it doesn't exist
    let toastContainer = document.getElementById('toast-container');
    if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.id = 'toast-container';
        toastContainer.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            max-width: 400px;
        `;
        document.body.appendChild(toastContainer);
    }

    // Create toast element
    const toast = document.createElement('div');
    const icon = getToastIcon(type);
    const title = getToastTitle(type);
    
    toast.className = `toast toast-${type}`;
    toast.style.cssText = `
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 10px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        display: flex;
        align-items: flex-start;
        gap: 12px;
        animation: slideIn 0.3s ease-out;
        max-width: 400px;
    `;
    
    toast.innerHTML = `
        <div style="flex-shrink: 0; font-size: 20px;">${icon}</div>
        <div style="flex: 1;">
            <div style="font-weight: 600; margin-bottom: 4px; color: #374151;">${title}</div>
            <div style="color: #6b7280; font-size: 14px;">${message}</div>
        </div>
        <button onclick="this.parentElement.remove()" style="
            background: none;
            border: none;
            color: #9ca3af;
            cursor: pointer;
            font-size: 18px;
            padding: 0;
            margin-left: 8px;
        ">&times;</button>
    `;
    
    toastContainer.appendChild(toast);
    
    // Auto remove after 5 seconds
    setTimeout(() => {
        if (toast.parentElement) {
            toast.style.animation = 'slideOut 0.3s ease-in';
            setTimeout(() => toast.remove(), 300);
        }
    }, 5000);
}

function getToastIcon(type) {
    const icons = {
        success: '‚úÖ',
        error: '‚ùå',
        warning: '‚ö†Ô∏è',
        info: '‚ÑπÔ∏è'
    };
    return icons[type] || icons.info;
}

function getToastTitle(type) {
    const titles = {
        success: 'Ba≈üarƒ±lƒ±',
        error: 'Hata',
        warning: 'Uyarƒ±',
        info: 'Bilgi'
    };
    return titles[type] || titles.info;
}

// Add CSS animations
const style = document.createElement('style');
style.textContent = `
    @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    @keyframes slideOut {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
    }
`;
document.head.appendChild(style);

// Tweet i√ßeriƒüini kopyala
function copyTweetContent(content) {
  navigator.clipboard.writeText(content).then(function() {
    showToast('‚úÖ Tweet i√ßeriƒüi panoya kopyalandƒ±', 'success');
  }).catch(function(err) {
    console.error('Kopyalama hatasƒ±:', err);
    showToast('‚ùå Kopyalama ba≈üarƒ±sƒ±z', 'error');
  });
}

// Tweet i√ßeriƒüini d√ºzenle
function editTweetContent(tweetId) {
  showToast('üîÑ Tweet d√ºzenleme √∂zelliƒüi yakƒ±nda eklenecek', 'info');
}

// ESC tu≈üu ile modal'larƒ± kapat
document.addEventListener('keydown', function(event) {
  if (event.key === 'Escape') {
    closeTweetDetailsModal();
    closeAllTweetsModal();
    closeManualPostConfirmModal();
  }
});
</script>

<!-- Mevcut Tweet'ler B√∂l√ºm√º (Twitter Card Tasarƒ±mƒ±) -->
{% if draft_tweets or ready_tweets %}
<div class="twitter-feed">
    <!-- Header -->
    <div class="feed-header">
        <div class="d-flex align-items-center justify-content-between">
            <div>
                <h1 class="feed-title">Mevcut Tweet'ler</h1>
                <p class="feed-subtitle">Olu≈üturulan tweet'leri y√∂netin ve payla≈üƒ±n</p>
            </div>
            <div>
                <button onclick="loadAllManualTweets()" class="twitter-btn twitter-btn-secondary">
                    <i class="fas fa-list"></i> T√ºm√ºn√º G√∂r√ºnt√ºle
                </button>
            </div>
        </div>
    </div>

    <!-- Tweet Cards -->
    <div class="tweet-feed">
        {% for tweet in (draft_tweets + ready_tweets) %}
        <div class="tweet-card" data-tweet-id="{{ tweet.id }}">
            <div class="tweet-header">
                <div class="tweet-avatar">
                    <i class="fas fa-robot"></i>
                </div>
                <div class="tweet-user-info">
                    <span class="tweet-username">AI Tweet Bot</span>
                    <span class="tweet-handle">@aitweetbot</span>
                    <span class="tweet-time">‚Ä¢ {{ tweet.created_at[:16] }}</span>
                </div>
                <!-- Tweet Durum Bilgisi -->
                <div class="status-indicator {% if tweet.is_draft %}status-warning{% else %}status-online{% endif %}">
                    {% if tweet.is_draft %}
                        <i class="fas fa-save"></i> Taslak
                    {% else %}
                        <i class="fas fa-check"></i> Hazƒ±r
                    {% endif %}
                </div>
            </div>
            
            <!-- Tweet Content -->
            <div class="tweet-content">
                <p>{{ tweet.content }}</p>
            </div>
            
            <!-- Tweet Actions -->
            <div class="tweet-actions">
                <!-- Character Count -->
                <div class="tweet-action">
                    <i class="fas fa-text-width tweet-action-icon"></i>
                    <span>{{ tweet.content|length }}/280</span>
                    {% if tweet.content|length > 280 %}
                    <span class="text-danger ms-1">
                        <i class="fas fa-exclamation-triangle"></i>
                    </span>
                    {% elif tweet.content|length > 250 %}
                    <span class="text-warning ms-1">
                        <i class="fas fa-exclamation-circle"></i>
                    </span>
                    {% else %}
                    <span class="text-success ms-1">
                        <i class="fas fa-check-circle"></i>
                    </span>
                    {% endif %}
                </div>
                
                <!-- Hashtag Count -->
                {% if tweet.hashtag_count %}
                <div class="tweet-action">
                    <i class="fas fa-hashtag tweet-action-icon"></i>
                    <span>{{ tweet.hashtag_count }} hashtag</span>
                </div>
                {% endif %}
                
                <!-- Emoji Count -->
                {% if tweet.emoji_count %}
                <div class="tweet-action">
                    <i class="fas fa-smile tweet-action-icon"></i>
                    <span>{{ tweet.emoji_count }} emoji</span>
                </div>
                {% endif %}
                
                <!-- Theme -->
                <div class="tweet-action">
                    <i class="fas fa-palette tweet-action-icon"></i>
                    <span>{{ tweet.theme|title }}</span>
                </div>
                
                <!-- Kopyala -->
                <button class="tweet-action" data-tweet-content="{{ tweet.content }}" onclick="copyTweetContent(this.dataset.tweetContent)">
                    <i class="fas fa-copy tweet-action-icon"></i>
                    <span>Kopyala</span>
                </button>
                
                <!-- API ile Payla≈ü -->
                {% if not tweet.is_draft %}
                <button class="tweet-action retweet" onclick="confirmManualPost('{{ tweet.id }}')">
                    <i class="fab fa-twitter tweet-action-icon"></i>
                    <span>API ile Payla≈ü</span>
                </button>
                {% endif %}
                
                <!-- X'te Manuel Payla≈ü -->
                {% if not tweet.is_draft %}
                <button class="tweet-action" onclick="manualPostTweetFromCreate('{{ tweet.id }}')">
                    <i class="fab fa-twitter tweet-action-icon"></i>
                    <span>X'te Payla≈ü</span>
                </button>
                {% endif %}
                
                <!-- D√ºzenle -->
                <button class="tweet-action" onclick="editTweetContent('{{ tweet.id }}')">
                    <i class="fas fa-edit tweet-action-icon"></i>
                    <span>D√ºzenle</span>
                </button>
                
                <!-- Detaylar -->
                <button class="tweet-action" onclick="viewTweetDetails('{{ tweet.id }}')">
                    <i class="fas fa-info-circle tweet-action-icon"></i>
                    <span>Detaylar</span>
                </button>
                
                <!-- Sil -->
                {% if tweet.is_draft or not tweet.is_posted %}
                <button class="tweet-action delete" onclick="deleteManualTweet('{{ tweet.id }}')">
                    <i class="fas fa-trash tweet-action-icon"></i>
                    <span>Sil</span>
                </button>
                {% endif %}
            </div>
            
            <!-- Tweet Durum Bilgisi -->
            <div class="tweet-footer">
                <div class="d-flex align-items-center justify-content-between">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-database text-blue-500 me-2"></i>
                        <span class="text-muted small">Tweet ID: {{ tweet.id }}</span>
                    </div>
                    <div class="d-flex align-items-center gap-2">
                        {% if tweet.is_draft %}
                        <span class="badge bg-warning text-dark">
                            <i class="fas fa-save"></i> Taslak
                        </span>
                        {% else %}
                        <span class="badge bg-success">
                            <i class="fas fa-check"></i> Hazƒ±r
                        </span>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

{% endblock %} 