{% extends "base.html" %}

{% block title %}Tweet Oluştur{% endblock %}

{% block content %}
<!-- Twitter Feed Style -->
<div class="twitter-feed">
    <!-- Header -->
    <div class="feed-header">
        <div class="d-flex align-items-center justify-content-between">
            <div>
                <h1 class="feed-title">Tweet Oluştur</h1>
                <p class="feed-subtitle">Yeni tweet oluşturun ve AI ile optimize edin</p>
            </div>
            <div>
                <button onclick="location.reload();" class="twitter-btn twitter-btn-secondary">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Tweet Compose Box -->
    <div class="tweet-compose">
        <div class="compose-header">
            <div class="compose-avatar">
                <i class="fas fa-robot"></i>
            </div>
            <div class="compose-content">
                <textarea class="compose-textarea" placeholder="Ne oluyor?" maxlength="280" rows="3"></textarea>
                
                <!-- Compose Actions -->
                <div class="compose-actions">
                    <div class="compose-options">
                        <button class="compose-option" title="Metin Tweet">
                            <i class="fas fa-font"></i>
                        </button>
                        <button class="compose-option" title="Link Ekle">
                            <i class="fas fa-link"></i>
                        </button>
                        <button class="compose-option" title="Resim Ekle">
                            <i class="fas fa-image"></i>
                        </button>
                    </div>
                    <div class="compose-submit">
                        <span class="character-count">0/280</span>
                        <button class="twitter-btn compose-tweet-btn" disabled>Tweet</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tweet Compose Box -->
    <div class="tweet-compose">
        <div class="compose-header">
            <div class="compose-avatar">
                <i class="fas fa-robot"></i>
            </div>
            <div class="compose-content">
                <textarea class="compose-textarea" placeholder="Ne oluyor?" maxlength="280" rows="3"></textarea>
                
                <!-- Compose Actions -->
                <div class="compose-actions">
                    <div class="compose-options">
                        <button class="compose-option" title="Metin Tweet">
                            <i class="fas fa-font"></i>
                        </button>
                        <button class="compose-option" title="Link Ekle">
                            <i class="fas fa-link"></i>
                        </button>
                        <button class="compose-option" title="Resim Ekle">
                            <i class="fas fa-image"></i>
                        </button>
                    </div>
                    <div class="compose-submit">
                        <span class="character-count">0/280</span>
                        <button class="twitter-btn compose-tweet-btn" disabled>Tweet</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tweet Oluşturma Formu -->
    <div class="tweet-card">
    
    <!-- Tweet Tema Seçimi -->
    <div class="mb-6 p-4 bg-blue-50 rounded-lg border border-blue-200">
      <label for="tweet_theme" class="block text-sm font-medium text-gray-700 mb-2">
        <i class="fas fa-palette text-blue-500"></i> Tweet Teması
      </label>
             <select id="tweet_theme" name="tweet_theme" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
         <option value="bilgilendirici" {% if default_theme == 'bilgilendirici' or not default_theme %}selected{% endif %}>📊 Bilgilendirici - Profesyonel ve eğitici</option>
         <option value="eğlenceli" {% if default_theme == 'eğlenceli' %}selected{% endif %}>🎉 Eğlenceli - Neşeli ve heyecanlı</option>
         <option value="mizahi" {% if default_theme == 'mizahi' %}selected{% endif %}>😂 Mizahi - Komik ve esprili</option>
         <option value="resmi" {% if default_theme == 'resmi' %}selected{% endif %}>📢 Resmi - Ciddi ve otoriteye dayalı</option>
         <option value="heyecanlı" {% if default_theme == 'heyecanlı' %}selected{% endif %}>🔥 Heyecanlı - Dinamik ve ilham verici</option>
         <option value="meraklı" {% if default_theme == 'meraklı' %}selected{% endif %}>🤔 Meraklı - Sorgulayıcı ve düşündürücü</option>
       </select>
      <p class="text-sm text-gray-500 mt-1">
        <i class="fas fa-info-circle"></i> Seçilen temaya göre tweet tarzı, emoji ve hashtag'ler otomatik ayarlanacak
      </p>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
      <!-- Sol Taraf - Tweet Oluşturma -->
      <div>
        <div class="mb-6">
          <div class="flex border-b border-blue-200 mb-4">
            <button id="tab-text" class="flex-1 py-2 font-semibold text-blue-700 border-b-2 border-blue-500 transition-all duration-200">
              <i class="fas fa-keyboard mr-2"></i>Metinden Tweet
            </button>
            <button id="tab-image" class="flex-1 py-2 font-semibold text-gray-500 border-b-2 border-transparent hover:text-blue-600 transition-all duration-200">
              <i class="fas fa-image mr-2"></i>Resimden Tweet
            </button>
            <button id="tab-link" class="flex-1 py-2 font-semibold text-gray-500 border-b-2 border-transparent hover:text-blue-600 transition-all duration-200">
              <i class="fas fa-link mr-2"></i>Link'ten Tweet
            </button>
          </div>

          <form method="POST" enctype="multipart/form-data" class="space-y-4" id="tweet-form">
            <input type="hidden" name="tweet_mode" id="tweet_mode" value="text">
            <input type="hidden" name="tweet_theme" id="hidden_tweet_theme" value="bilgilendirici">
            
            <!-- Metinden Tweet Sekmesi -->
            <div id="text-content" class="tab-content">
              <div class="space-y-4">
                <div>
                  <label for="tweet_text" class="block text-sm font-medium text-gray-700 mb-2">
                    <i class="fas fa-edit text-blue-500"></i> Tweet Metni
                  </label>
                  <textarea 
                                         name="tweet_text" 
                     id="tweet_text" 
                     rows="4" 
                     class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none"
                     placeholder="Tweet için metin girin... AI ile optimize edilecek."
                  ></textarea>
                  <div class="flex justify-between items-center mt-2">
                    <span class="text-sm text-gray-500">
                      <i class="fas fa-info-circle"></i> AI ile optimize edilecek
                    </span>
                    <span id="text-char-count" class="text-sm text-gray-500">0 karakter</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Resimden Tweet Sekmesi -->
            <div id="image-content" class="tab-content hidden">
              <div class="space-y-4">
                <div>
                  <label for="tweet_image" class="block text-sm font-medium text-gray-700 mb-2">
                    <i class="fas fa-upload text-blue-500"></i> Resim Yükle
                  </label>
                  <input 
                    type="file" 
                    name="tweet_image" 
                    id="tweet_image" 
                    accept="image/jpeg,image/png,image/gif,image/webp"
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    onchange="previewImage(this)"
                  >
                  <p class="text-sm text-gray-500 mt-2">
                    <i class="fas fa-info-circle"></i> Desteklenen formatlar: JPEG, PNG, GIF, WebP (Max: 5MB)
                  </p>
                  <!-- Resim Önizlemesi -->
                  <div id="image-preview" class="hidden mt-4">
                    <img id="preview-img" src="" alt="Önizleme" class="max-w-full h-48 object-contain border border-gray-300 rounded-lg">
                    <button type="button" onclick="removeImage()" class="mt-2 px-3 py-1 bg-red-500 text-white rounded text-sm hover:bg-red-600">
                      <i class="fas fa-times"></i> Kaldır
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <!-- Link'ten Tweet Sekmesi -->
            <div id="link-content" class="tab-content hidden">
              <div class="space-y-4">
                <div>
                  <label for="tweet_url" class="block text-sm font-medium text-gray-700 mb-2">
                    <i class="fas fa-globe text-blue-500"></i> Web Sitesi URL'si
                  </label>
                  <input 
                    type="url" 
                    name="tweet_url" 
                    id="tweet_url" 
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                         placeholder="https://example.com/article"
                  >
                  <div id="url-status" class="mt-2 text-sm hidden"></div>
                  <p class="text-sm text-gray-500 mt-2">
                    <i class="fas fa-info-circle"></i> Link içeriği MCP ile çekilip AI ile tweet oluşturulacak
                  </p>
                  <!-- URL Önizlemesi -->
                  <div id="url-preview" class="hidden mt-4 p-3 bg-gray-50 border border-gray-200 rounded-lg">
                    <div class="flex items-start space-x-3">
                      <div class="flex-1">
                        <h4 id="url-title" class="font-medium text-gray-900"></h4>
                        <p id="url-description" class="text-sm text-gray-600 mt-1"></p>
                        <p id="url-domain" class="text-xs text-gray-500 mt-1"></p>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Taslak Kaydetme Seçeneği -->
            <div class="mb-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
              <label class="flex items-center gap-2">
                <input type="checkbox" name="save_as_draft" id="save_as_draft" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                <span class="text-sm font-medium text-gray-700">
                  <i class="fas fa-save text-yellow-500"></i> Taslak olarak kaydet (henüz paylaşma)
                </span>
              </label>
              <p class="text-xs text-gray-500 mt-1 ml-6">
                Tweet oluşturulacak ancak otomatik paylaşılmayacak. Daha sonra manuel olarak paylaşabilirsiniz.
              </p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-3 pt-4">
              <button 
                type="submit" 
                name="action" 
                value="preview"
                class="px-6 py-3 bg-gradient-to-r from-blue-600 to-purple-600 text-white font-semibold rounded-lg hover:from-blue-700 hover:to-purple-700 transform hover:scale-105 transition-all duration-200 shadow-lg flex items-center justify-center gap-2"
              >
                <i class="fas fa-magic"></i>
                <span>Tweet Oluştur ve Önizle</span>
              </button>
              <button 
                type="submit" 
                name="action" 
                value="direct_post"
                class="px-6 py-3 bg-gradient-to-r from-green-600 to-teal-600 text-white font-semibold rounded-lg hover:from-green-700 hover:to-teal-700 transform hover:scale-105 transition-all duration-200 shadow-lg flex items-center justify-center gap-2"
              >
                <i class="fas fa-rocket"></i>
                <span>Oluştur ve Hemen Paylaş</span>
              </button>
            </div>
            <div class="text-center mt-2">
              <p class="text-xs text-gray-500">
                <i class="fas fa-info-circle"></i> 
                "Hemen Paylaş" seçeneği tweet'i oluşturup otomatik olarak pending tweets'e ekler
              </p>
            </div>
          </form>
        </div>
      </div>

      <!-- Sağ Taraf - Önizleme ve Özellikler -->
      <div>
        <!-- Tema Önizlemesi -->
        <div class="mb-6 p-4 bg-gray-50 rounded-lg border border-gray-200">
          <h3 class="text-lg font-semibold text-gray-800 mb-3 flex items-center gap-2">
            <i class="fas fa-eye text-blue-500"></i> Tema Önizlemesi
          </h3>
          <div id="theme-preview" class="bg-white p-4 rounded-lg border border-gray-300">
            <div class="flex items-center gap-2 mb-2">
              <span id="theme-emoji">📊</span>
              <span id="theme-name" class="font-medium">Bilgilendirici</span>
            </div>
            <p id="theme-description" class="text-sm text-gray-600 mb-2">
              Profesyonel ve eğitici tarzda tweet'ler oluşturur
            </p>
            <div class="text-xs text-gray-500">
              <span id="theme-hashtags">#AI #Tech #Innovation</span>
            </div>
          </div>
        </div>




      </div>
    </div>

    <!-- Oluşturulan Tweet Sonucu -->
    {% if generated_tweet %}
    <div class="mt-8 p-6 bg-green-50 rounded-lg border border-green-200">
      <h3 class="text-xl font-semibold text-gray-800 mb-4 flex items-center gap-2">
        <i class="fas fa-check-circle text-green-500"></i> Tweet Başarıyla Oluşturuldu!
      </h3>
      
      <!-- Tweet Metni -->
      <div class="bg-white p-4 rounded-lg border border-gray-300 mb-4">
        <p class="text-gray-800 whitespace-pre-wrap">{{ generated_tweet }}</p>
        <div class="flex justify-between items-center mt-3 text-sm text-gray-500">
          <span><i class="fas fa-info-circle"></i> Karakter sayısı: {{ generated_tweet|length }}/280</span>
          <span class="px-2 py-1 bg-green-100 text-green-700 rounded text-xs font-medium">
            {% if generated_tweet|length <= 240 %}Optimal{% elif generated_tweet|length <= 270 %}İyi{% else %}Limit Yakın{% endif %}
          </span>
        </div>
      </div>
      
      <!-- Tweet Durum Bilgisi -->
      {% if tweet_id %}
      <div class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-2">
            <i class="fas fa-database text-blue-500"></i>
            <span class="text-sm font-medium text-gray-700">Tweet ID: {{ tweet_id }}</span>
            {% if is_draft %}
              <span class="px-2 py-1 bg-yellow-100 text-yellow-700 rounded text-xs font-medium">
                <i class="fas fa-save"></i> Taslak
              </span>
            {% else %}
              <span class="px-2 py-1 bg-green-100 text-green-700 rounded text-xs font-medium">
                <i class="fas fa-check"></i> Hazır
              </span>
            {% endif %}
          </div>
          <button onclick="viewTweetDetails('{{ tweet_id }}')" class="text-blue-600 hover:text-blue-800 text-sm">
            <i class="fas fa-info-circle"></i> Detaylar
          </button>
        </div>
      </div>
      {% endif %}

      <!-- Aksiyon Butonları -->
      <div class="flex flex-wrap gap-3">
        <button 
          onclick="copyTweet()" 
          class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-all duration-200 flex items-center gap-2"
        >
          <i class="fas fa-copy"></i> Kopyala
        </button>
        
        {% if tweet_id and not is_draft %}
        <button 
          onclick="postManualTweet('{{ tweet_id }}')" 
          class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-all duration-200 flex items-center gap-2"
        >
          <i class="fab fa-twitter"></i> API ile Paylaş
        </button>
        {% endif %}
        
        <a 
          href="https://twitter.com/intent/tweet?text={{ generated_tweet|urlencode }}" 
          target="_blank"
          class="px-4 py-2 bg-sky-600 text-white rounded-lg hover:bg-sky-700 transition-all duration-200 flex items-center gap-2"
        >
          <i class="fab fa-twitter"></i> X'te Paylaş
        </a>
        
        {% if tweet_id %}
        <button 
          onclick="deleteManualTweet('{{ tweet_id }}')" 
          class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-all duration-200 flex items-center gap-2"
        >
          <i class="fas fa-trash"></i> Sil
        </button>
        {% endif %}
        
        <button 
          onclick="editTweet()" 
          class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-all duration-200 flex items-center gap-2"
        >
          <i class="fas fa-edit"></i> Düzenle
        </button>
        <button 
          onclick="generateVariation()" 
          class="px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition-all duration-200 flex items-center gap-2"
        >
          <i class="fas fa-sync-alt"></i> Farklı Varyasyon
        </button>
      </div>
    </div>
    {% endif %}
  </div>
</div>

<!-- Loading Modal -->
<div id="loading-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
  <div class="bg-white rounded-lg p-6 max-w-sm w-full mx-4">
    <div class="text-center">
      <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
      <h3 class="text-lg font-semibold text-gray-900 mb-2">Tweet Oluşturuluyor</h3>
      <p id="loading-text" class="text-gray-600">AI ile tweet metni hazırlanıyor...</p>
      <div class="mt-4 bg-gray-200 rounded-full h-2">
        <div id="loading-progress" class="bg-blue-600 h-2 rounded-full transition-all duration-500" style="width: 0%"></div>
      </div>
    </div>
  </div>
</div>

<script>
// Global değişkenler
let currentTheme = '{{ default_theme|default("bilgilendirici") }}';
let isGenerating = false;

// Tema bilgileri
const themeData = {
  'bilgilendirici': {
    emoji: '📊',
    name: 'Bilgilendirici',
    description: 'Profesyonel ve eğitici tarzda tweet\'ler oluşturur',
    hashtags: '#AI #Tech #Innovation #Technology',
    color: 'blue'
  },
  'eğlenceli': {
    emoji: '🎉',
    name: 'Eğlenceli',
    description: 'Neşeli ve heyecanlı tarzda tweet\'ler oluşturur',
    hashtags: '#TechFun #Innovation #Cool #Amazing',
    color: 'green'
  },
  'mizahi': {
    emoji: '😂',
    name: 'Mizahi',
    description: 'Komik ve esprili tarzda tweet\'ler oluşturur',
    hashtags: '#TechHumor #AILife #TechJokes #FunnyTech',
    color: 'yellow'
  },
  'resmi': {
    emoji: '📢',
    name: 'Resmi',
    description: 'Ciddi ve otoriteye dayalı tarzda tweet\'ler oluşturur',
    hashtags: '#TechNews #Industry #Business #Official',
    color: 'gray'
  },
  'heyecanlı': {
    emoji: '🔥',
    name: 'Heyecanlı',
    description: 'Dinamik ve ilham verici tarzda tweet\'ler oluşturur',
    hashtags: '#Breakthrough #GameChanger #Innovation #Exciting',
    color: 'red'
  },
  'meraklı': {
    emoji: '🤔',
    name: 'Meraklı',
    description: 'Sorgulayıcı ve düşündürücü tarzda tweet\'ler oluşturur',
    hashtags: '#TechCuriosity #WhatIf #Thinking #Questions',
    color: 'purple'
  }
};

// Sayfa yüklendiğinde
document.addEventListener('DOMContentLoaded', function() {
  // Tema dropdown'ından mevcut değeri al
  const themeSelect = document.getElementById('tweet_theme');
  if (themeSelect) {
    currentTheme = themeSelect.value;
    document.getElementById('hidden_tweet_theme').value = currentTheme;
  }
  
  updateThemePreview();
  
  // Tema değişikliği dinleyicisi
  document.getElementById('tweet_theme').addEventListener('change', function() {
    currentTheme = this.value;
    document.getElementById('hidden_tweet_theme').value = currentTheme;
    updateThemePreview();
  });
  
  // Tweet text input dinleyicisi - Önizleme için
  const tweetTextArea = document.getElementById('tweet_text');
  if (tweetTextArea) {
    tweetTextArea.addEventListener('input', function() {
      updateCharacterCount(this);
    });
    

  }
  
  // URL input dinleyicisi
  const tweetUrlInput = document.getElementById('tweet_url');
  if (tweetUrlInput) {
    tweetUrlInput.addEventListener('input', function() {
      validateUrl(this);
    });
  }
  
  // Form gönderimi dinleyicisi
  document.getElementById('tweet-form').addEventListener('submit', function(e) {
    if (isGenerating) {
      e.preventDefault();
      return;
    }
    
    showLoadingModal();
    isGenerating = true;
    
    // Submit butonunu devre dışı bırak
    const submitBtn = document.getElementById('submit-btn');
    submitBtn.disabled = true;
    submitBtn.classList.add('opacity-50', 'cursor-not-allowed');
  });
});

// Tema önizlemesini güncelle
function updateThemePreview() {
  const theme = themeData[currentTheme];
  if (theme) {
    document.getElementById('theme-emoji').textContent = theme.emoji;
    document.getElementById('theme-name').textContent = theme.name;
    document.getElementById('theme-description').textContent = theme.description;
    document.getElementById('theme-hashtags').textContent = theme.hashtags;
  }
}

// Karakter sayacını güncelle
function updateCharacterCount(element) {
  try {
    const count = element.value.length;
    const countElement = document.getElementById('text-char-count');
    
    if (countElement) {
      countElement.textContent = `${count} karakter`;
      
      // Renk değişimi
      if (count > 250) {
        countElement.className = 'text-sm text-red-500 font-medium';
      } else if (count > 200) {
        countElement.className = 'text-sm text-yellow-500 font-medium';
      } else {
        countElement.className = 'text-sm text-gray-500';
      }
    }
    

    
    console.log('Karakter sayısı güncellendi:', count); // Debug log
    
  } catch (error) {
    console.error('Karakter sayacı güncelleme hatası:', error);
  }
}

// Hashtag ve emoji sayısını güncelle
function updateTweetStats(text) {
  try {
    const hashtagCount = text ? (text.match(/#\w+/g) || []).length : 0;
    const emojiCount = text ? (text.match(/[\u{1F600}-\u{1F64F}]|[\u{1F300}-\u{1F5FF}]|[\u{1F680}-\u{1F6FF}]|[\u{1F1E0}-\u{1F1FF}]|[\u{2600}-\u{26FF}]|[\u{2700}-\u{27BF}]/gu) || []).length : 0;
    
    const hashtagElement = document.getElementById('hashtag-count');
    const emojiElement = document.getElementById('emoji-count');
    
    if (hashtagElement) hashtagElement.textContent = hashtagCount;
    if (emojiElement) emojiElement.textContent = emojiCount;
    
  } catch (error) {
    console.error('Tweet istatistik güncelleme hatası:', error);
  }
}

// Tab değiştirme fonksiyonları
function switchTab(activeTab, activeContent) {
  // Tüm tab'ları pasif yap
  document.querySelectorAll('[id^="tab-"]').forEach(tab => {
    tab.classList.add('text-gray-500', 'border-transparent');
    tab.classList.remove('text-blue-700', 'border-blue-500');
  });
  
  // Tüm içerikleri gizle
  document.querySelectorAll('.tab-content').forEach(content => {
    content.classList.add('hidden');
  });
  
  // Aktif tab'ı göster
  activeTab.classList.add('text-blue-700', 'border-blue-500');
  activeTab.classList.remove('text-gray-500', 'border-transparent');
  
  // Aktif içeriği göster
  activeContent.classList.remove('hidden');
}

// Tab event listener'ları
document.getElementById('tab-text').addEventListener('click', function() {
  document.getElementById('tweet_mode').value = 'text';
  switchTab(this, document.getElementById('text-content'));
});

document.getElementById('tab-image').addEventListener('click', function() {
  document.getElementById('tweet_mode').value = 'image';
  switchTab(this, document.getElementById('image-content'));
});

document.getElementById('tab-link').addEventListener('click', function() {
  document.getElementById('tweet_mode').value = 'link';
  switchTab(this, document.getElementById('link-content'));
});

// Resim önizleme
function previewImage(input) {
  if (input.files && input.files[0]) {
    const file = input.files[0];
    
    // Dosya boyutu kontrolü (5MB)
    if (file.size > 5 * 1024 * 1024) {
      showToast('Dosya boyutu 5MB\'dan büyük olamaz!', 'error');
      input.value = '';
      return;
    }
    
    const reader = new FileReader();
    reader.onload = function(e) {
      document.getElementById('preview-img').src = e.target.result;
      document.getElementById('image-preview').classList.remove('hidden');
    };
    reader.readAsDataURL(file);
  }
}

// Resim kaldırma
function removeImage() {
  document.getElementById('tweet_image').value = '';
  document.getElementById('image-preview').classList.add('hidden');
}

// URL doğrulama
function validateUrl(input) {
  const url = input.value.trim();
  const statusElement = document.getElementById('url-status');
  
  if (!url) {
    statusElement.classList.add('hidden');
    return;
  }
  
  try {
    new URL(url);
    statusElement.className = 'mt-2 text-sm text-green-600';
    statusElement.innerHTML = '<i class="fas fa-check-circle"></i> Geçerli URL';
    statusElement.classList.remove('hidden');
    
    // URL önizlemesi için basit bilgi göster
    const domain = new URL(url).hostname;
    document.getElementById('url-domain').textContent = domain;
    document.getElementById('url-title').textContent = 'URL Önizlemesi';
    document.getElementById('url-description').textContent = 'İçerik çekilecek ve AI ile tweet oluşturulacak';
    document.getElementById('url-preview').classList.remove('hidden');
    
  } catch (e) {
    statusElement.className = 'mt-2 text-sm text-red-600';
    statusElement.innerHTML = '<i class="fas fa-exclamation-circle"></i> Geçersiz URL formatı';
    statusElement.classList.remove('hidden');
    document.getElementById('url-preview').classList.add('hidden');
  }
}

// Loading modal göster
function showLoadingModal() {
  document.getElementById('loading-modal').classList.remove('hidden');
  
  // Progress bar animasyonu
  let progress = 0;
  const progressBar = document.getElementById('loading-progress');
  const loadingText = document.getElementById('loading-text');
  
  const messages = [
    'AI ile tweet metni hazırlanıyor...',
    'İçerik analiz ediliyor...',
    'Tema özellikleri uygulanıyor...',
    'Tweet optimize ediliyor...',
    'Son kontroller yapılıyor...'
  ];
  
  let messageIndex = 0;
  
  const interval = setInterval(() => {
    progress += 20;
    progressBar.style.width = `${progress}%`;
    
    if (messageIndex < messages.length) {
      loadingText.textContent = messages[messageIndex];
      messageIndex++;
    }
    
    if (progress >= 100) {
      clearInterval(interval);
    }
  }, 800);
}

// Loading modal gizle
function hideLoadingModal() {
  document.getElementById('loading-modal').classList.add('hidden');
  
  // Submit butonunu tekrar aktif et
  const submitBtn = document.getElementById('submit-btn');
  submitBtn.disabled = false;
  submitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
  isGenerating = false;
}

// Tweet kopyalama
function copyTweet() {
  const tweetElement = document.querySelector('.bg-green-50 .bg-white p');
      if (!tweetElement) {
      showToast('Kopyalanacak tweet bulunamadı!', 'error');
      return;
    }
  
  const tweetText = tweetElement.textContent.trim();
  
  navigator.clipboard.writeText(tweetText).then(function() {
    // Başarı mesajı
    const button = event.target.closest('button');
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-check"></i> Kopyalandı!';
    button.classList.remove('bg-green-600', 'hover:bg-green-700');
    button.classList.add('bg-green-800');
    
    setTimeout(function() {
      button.innerHTML = originalText;
      button.classList.remove('bg-green-800');
      button.classList.add('bg-green-600', 'hover:bg-green-700');
    }, 2000);
  }).catch(function(err) {
    showToast('Kopyalama başarısız: ' + err, 'error');
  });
}

// Tweet düzenleme
function editTweet() {
  const tweetElement = document.querySelector('.bg-green-50 .bg-white p');
  if (!tweetElement) {
    showToast('Düzenlenecek tweet bulunamadı!', 'error');
    return;
  }
  
  const tweetText = tweetElement.textContent.trim();
  
  document.getElementById('tweet_text').value = tweetText;
  document.getElementById('tab-text').click();
  updateCharacterCount(document.getElementById('tweet_text'));
  
  // Sayfayı yukarı kaydır
  document.querySelector('h2').scrollIntoView({ behavior: 'smooth' });
}

// Modern Confirm Dialog Sistemi
function showConfirmDialog(message, onConfirm, onCancel = null, title = 'Onay Gerekli', type = 'warning') {
    // Mevcut dialog varsa kaldır
    const existingDialog = document.getElementById('confirm-dialog');
    if (existingDialog) {
        existingDialog.remove();
    }
    
    const dialog = document.createElement('div');
    dialog.id = 'confirm-dialog';
    dialog.className = 'confirm-dialog-overlay';
    dialog.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        animation: fadeIn 0.2s ease-out;
    `;
    
    const icon = type === 'danger' ? 'exclamation-triangle' : 
                 type === 'success' ? 'check-circle' : 
                 type === 'info' ? 'info-circle' : 'question-circle';
    
    const iconColor = type === 'danger' ? '#dc3545' : 
                      type === 'success' ? '#28a745' : 
                      type === 'info' ? '#17a2b8' : '#ffc107';
    
    dialog.innerHTML = `
        <div class="confirm-dialog" style="
            background: white;
            border-radius: 12px;
            padding: 24px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            animation: slideIn 0.3s ease-out;
        ">
            <div style="text-align: center; margin-bottom: 20px;">
                <i class="fas fa-${icon}" style="font-size: 48px; color: ${iconColor}; margin-bottom: 16px;"></i>
                <h3 style="margin: 0; color: #333; font-size: 18px; font-weight: 600;">${title}</h3>
            </div>
            <div style="
                color: #666;
                line-height: 1.5;
                margin-bottom: 24px;
                text-align: center;
                white-space: pre-line;
            ">${message}</div>
            <div style="
                display: flex;
                gap: 12px;
                justify-content: center;
            ">
                <button id="confirm-cancel" style="
                    padding: 10px 20px;
                    border: 1px solid #ddd;
                    background: white;
                    color: #666;
                    border-radius: 6px;
                    cursor: pointer;
                    font-size: 14px;
                    transition: all 0.2s;
                " onmouseover="this.style.background='#f8f9fa'" onmouseout="this.style.background='white'">
                    İptal
                </button>
                <button id="confirm-ok" style="
                    padding: 10px 20px;
                    border: none;
                    background: ${iconColor};
                    color: white;
                    border-radius: 6px;
                    cursor: pointer;
                    font-size: 14px;
                    font-weight: 500;
                    transition: all 0.2s;
                " onmouseover="this.style.opacity='0.9'" onmouseout="this.style.opacity='1'">
                    Onayla
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(dialog);
    
    // Event listeners
    const cancelBtn = dialog.querySelector('#confirm-cancel');
    const okBtn = dialog.querySelector('#confirm-ok');
    
    const closeDialog = () => {
        dialog.style.animation = 'fadeOut 0.2s ease-in';
        setTimeout(() => dialog.remove(), 200);
    };
    
    cancelBtn.addEventListener('click', () => {
        closeDialog();
        if (onCancel) onCancel();
    });
    
    okBtn.addEventListener('click', () => {
        closeDialog();
        if (onConfirm) onConfirm();
    });
    
    // ESC tuşu ile kapatma
    const handleEsc = (e) => {
        if (e.key === 'Escape') {
            document.removeEventListener('keydown', handleEsc);
            closeDialog();
            if (onCancel) onCancel();
        }
    };
    document.addEventListener('keydown', handleEsc);
    
    // Dışarı tıklayarak kapatma
    dialog.addEventListener('click', (e) => {
        if (e.target === dialog) {
            closeDialog();
            if (onCancel) onCancel();
        }
    });
}

// CSS Animasyonları
const confirmDialogStyle = document.createElement('style');
confirmDialogStyle.textContent = `
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    @keyframes fadeOut {
        from { opacity: 1; }
        to { opacity: 0; }
    }
    @keyframes slideIn {
        from { transform: scale(0.9); opacity: 0; }
        to { transform: scale(1); opacity: 1; }
    }
`;
document.head.appendChild(confirmDialogStyle);

// Farklı varyasyon oluştur
function generateVariation() {
  showConfirmDialog(
    'Aynı içerik için farklı bir tweet varyasyonu oluşturmak istiyor musunuz?',
    () => document.getElementById('tweet-form').submit(),
    null,
    'Varyasyon Oluştur',
    'info'
  );
}

// Sayfa yüklendiğinde loading modal'ı gizle
window.addEventListener('load', function() {
  hideLoadingModal();
});

// ==============================
// MANUEL TWEET YÖNETİM FONKSİYONLARI
// ==============================

// Manuel tweet'i paylaş
function postManualTweet(tweetId) {
  if (!tweetId) {
    showToast('Tweet ID bulunamadı!', 'error');
    return;
  }
  
  showConfirmDialog(
    'Bu tweet\'i API ile paylaşmak istediğinizden emin misiniz?',
    () => {
      // Loading göster
      const button = event.target.closest('button');
      const originalContent = button.innerHTML;
      button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Paylaşılıyor...';
      button.disabled = true;
      
      fetch(`/api/manual_tweets/${tweetId}/post`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          showToast('✅ Tweet başarıyla paylaşıldı!', 'success');
          
          // Sayfayı yenile veya elementi güncelle
          if (data.tweet_url) {
            window.open(data.tweet_url, '_blank');
          }
          
          // Dinamik güncelleme - sayfa yenilemesi yok
          setTimeout(() => {
            // Tweet listesini güncelle
            if (typeof refreshPendingTweets === 'function') {
              refreshPendingTweets();
            }
            // Sayfa ana sayfaya yönlendir
            window.location.href = '/';
          }, 1000);
          
        } else {
          showToast('❌ Hata: ' + data.error, 'error');
          
          // Rate limit durumunda özel mesaj
          if (data.rate_limited) {
            showToast('⏰ Twitter API rate limit\'e takıldı. Lütfen daha sonra tekrar deneyin.', 'warning');
          }
        }
      })
      .catch(error => {
        console.error('Tweet paylaşım hatası:', error);
        showToast('❌ Bir hata oluştu: ' + error.message, 'error');
      })
      .finally(() => {
        // Button'u eski haline getir
        button.innerHTML = originalContent;
        button.disabled = false;
      });
    },
    null,
    'Tweet Paylaşımı',
    'warning'
  );
}

// Manuel tweet'i sil
function deleteManualTweet(tweetId) {
  if (!tweetId) {
    showToast('Tweet ID bulunamadı!', 'error');
    return;
  }
  
  showConfirmDialog(
    'Bu tweet\'i silmek istediğinizden emin misiniz? Bu işlem geri alınamaz.',
    () => {
      // Loading göster
      const button = event.target.closest('button');
      const originalContent = button.innerHTML;
      button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Siliniyor...';
      button.disabled = true;
      
      fetch(`/api/manual_tweets/${tweetId}/delete`, {
        method: 'DELETE',
        headers: {
          'Content-Type': 'application/json',
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          showToast('✅ Tweet başarıyla silindi!', 'success');
          
          // Sayfayı yenile veya elementi kaldır
          setTimeout(() => {
            if (typeof refreshPendingTweets === 'function') {
              refreshPendingTweets();
            } else {
              location.reload();
            }
          }, 1000);
          
        } else {
          showToast('❌ Hata: ' + data.error, 'error');
        }
      })
      .catch(error => {
        console.error('Tweet silme hatası:', error);
        showToast('❌ Bir hata oluştu: ' + error.message, 'error');
      })
      .finally(() => {
        // Button'u eski haline getir
        button.innerHTML = originalContent;
        button.disabled = false;
      });
    },
    null,
    'Tweet Silme',
    'danger'
  );
  return;
  
  // Loading göster
  const button = event.target.closest('button');
  const originalContent = button.innerHTML;
  button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
  button.disabled = true;
  
  fetch(`/api/manual_tweets/${tweetId}/delete`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      showToast('✅ Tweet başarıyla silindi!', 'success');
      
      // Elementi DOM'dan kaldır
      const tweetElement = button.closest('.bg-white');
      if (tweetElement) {
        tweetElement.style.transition = 'all 0.3s ease';
        tweetElement.style.opacity = '0';
        tweetElement.style.transform = 'scale(0.9)';
        
        setTimeout(() => {
          tweetElement.remove();
        }, 300);
      }
      
    } else {
      showToast('❌ Hata: ' + data.error, 'error');
    }
  })
  .catch(error => {
    console.error('Tweet silme hatası:', error);
    showToast('❌ Bir hata oluştu: ' + error.message, 'error');
  })
  .finally(() => {
    // Button'u eski haline getir
    button.innerHTML = originalContent;
    button.disabled = false;
  });
}

// Tweet detaylarını görüntüle
function viewTweetDetails(tweetId) {
  if (!tweetId) {
    showToast('Tweet ID bulunamadı!', 'error');
    return;
  }
  
  fetch(`/api/manual_tweets/${tweetId}`)
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      const tweet = data.tweet;
      
      // Modal oluştur ve göster
      showTweetDetailsModal(tweet);
      
    } else {
      showToast('❌ Tweet detayları alınamadı: ' + data.error, 'error');
    }
  })
  .catch(error => {
    console.error('Tweet detay hatası:', error);
    showToast('❌ Bir hata oluştu: ' + error.message, 'error');
  });
}

// Tweet detay modal'ını göster
function showTweetDetailsModal(tweet) {
  // Modal HTML'i oluştur
  const modalHTML = `
    <div id="tweet-detail-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div class="bg-white rounded-lg p-6 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-xl font-bold text-gray-900">Tweet Detayları</h3>
          <button onclick="closeTweetDetailsModal()" class="text-gray-500 hover:text-gray-700">
            <i class="fas fa-times text-xl"></i>
          </button>
        </div>
        
        <!-- Tweet İçeriği -->
        <div class="mb-6 p-4 bg-gray-50 rounded-lg border border-gray-200">
          <h4 class="font-semibold text-gray-800 mb-2">Tweet İçeriği</h4>
          <p class="text-gray-700 whitespace-pre-wrap">${tweet.content}</p>
          <div class="flex justify-between items-center mt-2 text-sm text-gray-500">
            <span>Karakter: ${tweet.char_count}/280</span>
            <span>Hashtag: ${tweet.hashtag_count} | Emoji: ${tweet.emoji_count}</span>
          </div>
        </div>
        
        <!-- Tweet Bilgileri -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
          <div class="space-y-2">
            <div class="flex justify-between">
              <span class="font-medium text-gray-700">ID:</span>
              <span class="text-gray-600">${tweet.id}</span>
            </div>
            <div class="flex justify-between">
              <span class="font-medium text-gray-700">Durum:</span>
              <span class="px-2 py-1 rounded text-xs font-medium ${
                tweet.status === 'draft' ? 'bg-yellow-100 text-yellow-700' :
                tweet.status === 'ready' ? 'bg-green-100 text-green-700' :
                tweet.status === 'posted' ? 'bg-blue-100 text-blue-700' : 'bg-gray-100 text-gray-700'
              }">
                ${tweet.status === 'draft' ? 'Taslak' : 
                  tweet.status === 'ready' ? 'Hazır' :
                  tweet.status === 'posted' ? 'Paylaşıldı' : tweet.status}
              </span>
            </div>
            <div class="flex justify-between">
              <span class="font-medium text-gray-700">Tema:</span>
              <span class="text-gray-600">${tweet.theme || 'Belirtilmemiş'}</span>
            </div>
            <div class="flex justify-between">
              <span class="font-medium text-gray-700">Oluşturulma:</span>
              <span class="text-gray-600">${new Date(tweet.created_at).toLocaleString('tr-TR')}</span>
            </div>
          </div>
          
          <div class="space-y-2">
            <div class="flex justify-between">
              <span class="font-medium text-gray-700">Kaynak Türü:</span>
              <span class="text-gray-600">${
                tweet.source_data?.type === 'text' ? 'Metin' :
                tweet.source_data?.type === 'url' ? 'URL' :
                tweet.source_data?.type === 'image' ? 'Resim' : 'Bilinmiyor'
              }</span>
            </div>
            ${tweet.is_posted ? `
              <div class="flex justify-between">
                <span class="font-medium text-gray-700">Paylaşım Tarihi:</span>
                <span class="text-gray-600">${new Date(tweet.posted_at).toLocaleString('tr-TR')}</span>
              </div>
              ${tweet.posted_url ? `
                <div class="flex justify-between">
                  <span class="font-medium text-gray-700">Tweet URL:</span>
                  <a href="${tweet.posted_url}" target="_blank" class="text-blue-600 hover:text-blue-800 text-sm">
                    <i class="fas fa-external-link-alt"></i> Görüntüle
                  </a>
                </div>
              ` : ''}
            ` : ''}
          </div>
        </div>
        
        <!-- Kaynak Bilgileri -->
        ${tweet.source_data ? `
          <div class="mb-6 p-4 bg-blue-50 rounded-lg border border-blue-200">
            <h4 class="font-semibold text-blue-800 mb-2">Kaynak Bilgileri</h4>
            ${tweet.source_data.type === 'url' ? `
              <div class="space-y-1 text-sm">
                <div><span class="font-medium">URL:</span> <a href="${tweet.source_data.source_url}" target="_blank" class="text-blue-600 hover:text-blue-800">${tweet.source_data.source_url}</a></div>
                ${tweet.source_data.fetched_title ? `<div><span class="font-medium">Başlık:</span> ${tweet.source_data.fetched_title}</div>` : ''}
              </div>
            ` : tweet.source_data.type === 'image' ? `
              <div class="space-y-1 text-sm">
                <div><span class="font-medium">Dosya:</span> ${tweet.source_data.original_filename}</div>
                ${tweet.source_data.ocr_text ? `<div><span class="font-medium">OCR Metni:</span> ${tweet.source_data.ocr_text.substring(0, 100)}...</div>` : ''}
              </div>
            ` : tweet.source_data.type === 'text' ? `
              <div class="space-y-1 text-sm">
                <div><span class="font-medium">Orijinal Metin:</span> ${tweet.source_data.original_text.substring(0, 100)}...</div>
              </div>
            ` : ''}
          </div>
        ` : ''}
        
        <!-- Aksiyon Butonları -->
        <div class="flex flex-wrap gap-3 justify-end">
          ${!tweet.is_posted ? `
            ${tweet.status === 'ready' ? `
              <button onclick="postManualTweet('${tweet.id}')" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-all duration-200 flex items-center gap-2">
                <i class="fab fa-twitter"></i> Paylaş
              </button>
            ` : ''}
            <button onclick="deleteManualTweet('${tweet.id}')" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-all duration-200 flex items-center gap-2">
              <i class="fas fa-trash"></i> Sil
            </button>
          ` : ''}
          <button onclick="closeTweetDetailsModal()" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-all duration-200">
            Kapat
          </button>
        </div>
      </div>
    </div>
  `;
  
  // Modal'ı DOM'a ekle
  document.body.insertAdjacentHTML('beforeend', modalHTML);
}

// Tweet detay modal'ını kapat
function closeTweetDetailsModal() {
  const modal = document.getElementById('tweet-detail-modal');
  if (modal) {
    modal.remove();
  }
}

// Tüm manuel tweet'leri yükle
function loadAllManualTweets() {
  fetch('/api/manual_tweets')
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      showAllTweetsModal(data.tweets, data.stats);
    } else {
      showToast('❌ Tweetler yüklenemedi: ' + data.error, 'error');
    }
  })
  .catch(error => {
    console.error('Tweet yükleme hatası:', error);
    showToast('❌ Bir hata oluştu: ' + error.message, 'error');
  });
}

// Tüm tweet'ler modal'ını göster
function showAllTweetsModal(tweets, stats) {
  const modalHTML = `
    <div id="all-tweets-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div class="bg-white rounded-lg p-6 max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-xl font-bold text-gray-900">Tüm Manuel Tweet'ler</h3>
          <button onclick="closeAllTweetsModal()" class="text-gray-500 hover:text-gray-700">
            <i class="fas fa-times text-xl"></i>
          </button>
        </div>
        
        <!-- İstatistikler -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
          <div class="bg-blue-50 p-3 rounded-lg text-center">
            <div class="text-2xl font-bold text-blue-600">${stats.total}</div>
            <div class="text-sm text-blue-800">Toplam</div>
          </div>
          <div class="bg-yellow-50 p-3 rounded-lg text-center">
            <div class="text-2xl font-bold text-yellow-600">${stats.drafts}</div>
            <div class="text-sm text-yellow-800">Taslak</div>
          </div>
          <div class="bg-green-50 p-3 rounded-lg text-center">
            <div class="text-2xl font-bold text-green-600">${stats.ready}</div>
            <div class="text-sm text-green-800">Hazır</div>
          </div>
          <div class="bg-purple-50 p-3 rounded-lg text-center">
            <div class="text-2xl font-bold text-purple-600">${stats.posted}</div>
            <div class="text-sm text-purple-800">Paylaşıldı</div>
          </div>
        </div>
        
        <!-- Tweet Listesi -->
        <div class="space-y-3 max-h-96 overflow-y-auto">
          ${tweets.map(tweet => `
            <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
              <div class="flex justify-between items-start">
                <div class="flex-1">
                  <p class="text-gray-700 mb-2">${tweet.content.length > 150 ? tweet.content.substring(0, 150) + '...' : tweet.content}</p>
                  <div class="flex items-center gap-4 text-xs text-gray-500">
                    <span><i class="fas fa-calendar"></i> ${new Date(tweet.created_at).toLocaleDateString('tr-TR')}</span>
                    <span><i class="fas fa-palette"></i> ${tweet.theme || 'Tema Yok'}</span>
                    <span class="px-2 py-1 rounded ${
                      tweet.status === 'draft' ? 'bg-yellow-100 text-yellow-700' :
                      tweet.status === 'ready' ? 'bg-green-100 text-green-700' :
                      tweet.status === 'posted' ? 'bg-blue-100 text-blue-700' : 'bg-gray-100 text-gray-700'
                    }">
                      ${tweet.status === 'draft' ? 'Taslak' : 
                        tweet.status === 'ready' ? 'Hazır' :
                        tweet.status === 'posted' ? 'Paylaşıldı' : tweet.status}
                    </span>
                  </div>
                </div>
                <div class="flex gap-2 ml-4">
                  ${!tweet.is_posted && tweet.status === 'ready' ? `
                    <button onclick="postManualTweet('${tweet.id}')" class="text-blue-600 hover:text-blue-800" title="Paylaş">
                      <i class="fab fa-twitter"></i>
                    </button>
                  ` : ''}
                  <button onclick="viewTweetDetails('${tweet.id}')" class="text-gray-600 hover:text-gray-800" title="Detaylar">
                    <i class="fas fa-eye"></i>
                  </button>
                  ${!tweet.is_posted ? `
                    <button onclick="deleteManualTweet('${tweet.id}')" class="text-red-600 hover:text-red-800" title="Sil">
                      <i class="fas fa-trash"></i>
                    </button>
                  ` : ''}
                </div>
              </div>
            </div>
          `).join('')}
        </div>
        
        <div class="mt-6 text-center">
          <button onclick="closeAllTweetsModal()" class="px-6 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-all duration-200">
            Kapat
          </button>
        </div>
      </div>
    </div>
  `;
  
  document.body.insertAdjacentHTML('beforeend', modalHTML);
}

// Tüm tweet'ler modal'ını kapat
function closeAllTweetsModal() {
  const modal = document.getElementById('all-tweets-modal');
  if (modal) {
    modal.remove();
  }
}

// Manuel paylaşım onayı modal'ını göster
let currentTweetIdToPost = null;

function confirmManualPost(tweetId) {
  currentTweetIdToPost = tweetId;
  
  // Tweet detaylarını al
  fetch(`/api/manual_tweets/${tweetId}`)
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      showManualPostConfirmModal(data.tweet);
    } else {
      showToast('❌ Tweet bilgileri alınamadı: ' + data.error, 'error');
    }
  })
  .catch(error => {
    console.error('Tweet bilgileri alma hatası:', error);
    showToast('❌ Bir hata oluştu: ' + error.message, 'error');
  });
}

function showManualPostConfirmModal(tweet) {
  const modalHTML = `
    <div id="manual-post-confirm-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div class="bg-white rounded-lg p-6 max-w-lg w-full mx-4">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-lg font-bold text-gray-900">Tweet Paylaşım Onayı</h3>
          <button onclick="closeManualPostConfirmModal()" class="text-gray-500 hover:text-gray-700">
            <i class="fas fa-times"></i>
          </button>
        </div>
        
        <div class="mb-6 p-4 bg-gray-50 rounded-lg border border-gray-200">
          <h4 class="font-semibold text-gray-800 mb-2">Paylaşılacak Tweet:</h4>
          <p class="text-gray-700 whitespace-pre-wrap">${tweet.content}</p>
          <div class="flex justify-between items-center mt-2 text-sm text-gray-500">
            <span>Karakter: ${tweet.char_count}/280</span>
            <span>Tema: ${tweet.theme || 'Belirtilmemiş'}</span>
          </div>
        </div>
        
        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6">
          <div class="flex items-start gap-3">
            <i class="fas fa-exclamation-triangle text-yellow-600 mt-1"></i>
            <div>
              <h4 class="font-medium text-yellow-800">Dikkat!</h4>
              <p class="text-yellow-700 text-sm mt-1">
                Bu tweet Twitter'a paylaşılacak. Paylaşım işlemi geri alınamaz.
              </p>
            </div>
          </div>
        </div>
        
        <div class="flex gap-3 justify-end">
          <button onclick="closeManualPostConfirmModal()" 
                  class="px-4 py-2 text-gray-600 border border-gray-300 rounded-lg hover:bg-gray-50">
            İptal
          </button>
          <button onclick="executeManualPost()" 
                  class="px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 font-medium">
            <i class="fab fa-twitter"></i> Paylaş
          </button>
        </div>
      </div>
    </div>
  `;
  
  document.body.insertAdjacentHTML('beforeend', modalHTML);
}

function closeManualPostConfirmModal() {
  const modal = document.getElementById('manual-post-confirm-modal');
  if (modal) {
    modal.remove();
  }
  currentTweetIdToPost = null;
}

function executeManualPost() {
  if (!currentTweetIdToPost) {
    showToast('❌ Tweet ID bulunamadı!', 'error');
    return;
  }
  
  const button = document.querySelector('#manual-post-confirm-modal button[onclick="executeManualPost()"]');
  if (button) {
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Paylaşılıyor...';
    button.disabled = true;
  }
  
  fetch(`/api/manual_tweets/${currentTweetIdToPost}/post`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      showToast('✅ Tweet başarıyla paylaşıldı!', 'success');
      closeManualPostConfirmModal();
      // Sayfayı yenile
      window.location.reload();
    } else {
      showToast('❌ Tweet paylaşılamadı: ' + data.error, 'error');
      if (button) {
        button.innerHTML = '<i class="fab fa-twitter"></i> Paylaş';
        button.disabled = false;
      }
    }
  })
  .catch(error => {
    console.error('Tweet paylaşım hatası:', error);
    showToast('❌ Bir hata oluştu: ' + error.message, 'error');
    if (button) {
      button.innerHTML = '<i class="fab fa-twitter"></i> Paylaş';
      button.disabled = false;
    }
  });
}

// Manuel tweet paylaşımı (X.com'da açma)
function manualPostTweetFromCreate(tweetId) {
  // UI feedback - tweet'i geçici olarak devre dışı bırak
  const tweetElement = document.querySelector(`[data-tweet-id="${tweetId}"]`);
  if (tweetElement) {
    tweetElement.style.opacity = '0.5';
    tweetElement.style.pointerEvents = 'none';
  }
  
  // Tweet detaylarını al
  fetch(`/api/manual_tweets/${tweetId}`)
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      const tweet = data.tweet;
      const tweetText = tweet.content;
      
      // Manuel paylaşım endpoint'ini çağır
      fetch('/manual_post_tweet', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({tweet_id: tweetId})
      })
      .then(response => response.json())
      .then(manualData => {
        if (manualData.success) {
          // X.com'da yeni sekmede aç
          window.open(manualData.x_share_url, '_blank');
          
          // Tweet'i UI'dan kaldır
          if (tweetElement) {
            tweetElement.style.transition = 'all 0.3s ease';
            tweetElement.style.transform = 'translateX(-100%)';
            tweetElement.style.opacity = '0';
            
            setTimeout(() => {
              tweetElement.remove();
            }, 300);
          }
          
          // Kullanıcıya bilgi ver
          setTimeout(() => {
            showToast('✅ Tweet manuel olarak paylaşıldı ve kaydedildi!', 'success');
          }, 500);
          
        } else {
          // Hata durumunda UI'ı geri yükle
          if (tweetElement) {
            tweetElement.style.opacity = '1';
            tweetElement.style.pointerEvents = 'auto';
          }
          showToast('❌ Manuel paylaşım hatası: ' + manualData.error, 'error');
        }
      })
      .catch(error => {
        console.error('Manuel paylaşım hatası:', error);
        // Hata durumunda UI'ı geri yükle
        if (tweetElement) {
          tweetElement.style.opacity = '1';
          tweetElement.style.pointerEvents = 'auto';
        }
        showToast('❌ Manuel paylaşım sırasında bir hata oluştu!', 'error');
      });
      
    } else {
      // Hata durumunda UI'ı geri yükle
      if (tweetElement) {
        tweetElement.style.opacity = '1';
        tweetElement.style.pointerEvents = 'auto';
      }
      showToast('❌ Tweet bilgileri alınamadı: ' + data.error, 'error');
    }
  })
  .catch(error => {
    console.error('Tweet bilgileri alma hatası:', error);
    // Hata durumunda UI'ı geri yükle
    if (tweetElement) {
      tweetElement.style.opacity = '1';
      tweetElement.style.pointerEvents = 'auto';
    }
    showToast('❌ Bir hata oluştu: ' + error.message, 'error');
  });
}

// Toast notification system
function showToast(message, type = 'info') {
    // Create toast container if it doesn't exist
    let toastContainer = document.getElementById('toast-container');
    if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.id = 'toast-container';
        toastContainer.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            max-width: 400px;
        `;
        document.body.appendChild(toastContainer);
    }

    // Create toast element
    const toast = document.createElement('div');
    const icon = getToastIcon(type);
    const title = getToastTitle(type);
    
    toast.className = `toast toast-${type}`;
    toast.style.cssText = `
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 10px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        display: flex;
        align-items: flex-start;
        gap: 12px;
        animation: slideIn 0.3s ease-out;
        max-width: 400px;
    `;
    
    toast.innerHTML = `
        <div style="flex-shrink: 0; font-size: 20px;">${icon}</div>
        <div style="flex: 1;">
            <div style="font-weight: 600; margin-bottom: 4px; color: #374151;">${title}</div>
            <div style="color: #6b7280; font-size: 14px;">${message}</div>
        </div>
        <button onclick="this.parentElement.remove()" style="
            background: none;
            border: none;
            color: #9ca3af;
            cursor: pointer;
            font-size: 18px;
            padding: 0;
            margin-left: 8px;
        ">&times;</button>
    `;
    
    toastContainer.appendChild(toast);
    
    // Auto remove after 5 seconds
    setTimeout(() => {
        if (toast.parentElement) {
            toast.style.animation = 'slideOut 0.3s ease-in';
            setTimeout(() => toast.remove(), 300);
        }
    }, 5000);
}

function getToastIcon(type) {
    const icons = {
        success: '✅',
        error: '❌',
        warning: '⚠️',
        info: 'ℹ️'
    };
    return icons[type] || icons.info;
}

function getToastTitle(type) {
    const titles = {
        success: 'Başarılı',
        error: 'Hata',
        warning: 'Uyarı',
        info: 'Bilgi'
    };
    return titles[type] || titles.info;
}

// Add CSS animations
const style = document.createElement('style');
style.textContent = `
    @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    @keyframes slideOut {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
    }
`;
document.head.appendChild(style);

// ESC tuşu ile modal'ları kapat
document.addEventListener('keydown', function(event) {
  if (event.key === 'Escape') {
    closeTweetDetailsModal();
    closeAllTweetsModal();
    closeManualPostConfirmModal();
  }
});
</script>

<!-- Mevcut Tweet'ler Bölümü (Ana Sayfa Tarzı) -->
{% if draft_tweets or ready_tweets %}
<div class="container mx-auto px-4 py-8">
  <div class="bg-white rounded-lg shadow-lg p-6">
    <h2 class="text-2xl font-bold mb-6 text-gray-800 flex items-center gap-3">
      <i class="fas fa-edit text-blue-500"></i>
      Mevcut Tweet'ler
    </h2>
    
    <!-- Tweet Kartları -->
    <div class="space-y-4">
      {% for tweet in (draft_tweets + ready_tweets) %}
      <div class="bg-gray-50 rounded-lg p-4 border-l-4 
                  {% if tweet.is_draft %}border-yellow-400{% else %}border-green-400{% endif %}"
           data-tweet-id="{{ tweet.id }}">
        <div class="flex justify-between items-start">
          <div class="flex-1">
            <div class="flex items-center gap-2 mb-2">
              <span class="px-2 py-1 rounded-full text-xs font-medium
                          {% if tweet.is_draft %}bg-yellow-100 text-yellow-800{% else %}bg-green-100 text-green-800{% endif %}">
                {% if tweet.is_draft %}📝 Taslak{% else %}✅ Hazır{% endif %}
              </span>
              <span class="text-sm text-gray-500">
                <i class="fas fa-calendar"></i> {{ tweet.created_at[:16] }}
              </span>
              <span class="text-sm text-gray-500">
                <i class="fas fa-palette"></i> {{ tweet.theme|title }}
              </span>
            </div>
            
            <p class="text-gray-700 mb-3 leading-relaxed">{{ tweet.content }}</p>
            
            <div class="flex items-center gap-4 text-sm text-gray-500">
              <span><i class="fas fa-font"></i> {{ tweet.content|length }} karakter</span>
              {% if tweet.hashtag_count %}
              <span><i class="fas fa-hashtag"></i> {{ tweet.hashtag_count }} hashtag</span>
              {% endif %}
              {% if tweet.emoji_count %}
              <span><i class="fas fa-smile"></i> {{ tweet.emoji_count }} emoji</span>
              {% endif %}
            </div>
          </div>
          
          <div class="flex flex-col gap-2 ml-4">
            {% if not tweet.is_draft %}
            <button onclick="confirmManualPost('{{ tweet.id }}')" 
                    class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
              <i class="fas fa-robot"></i> API ile Paylaş
            </button>
            <button onclick="manualPostTweetFromCreate('{{ tweet.id }}')" 
                    class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
              <i class="fab fa-twitter"></i> X'te Manuel Paylaş
            </button>

            {% endif %}
            
            <button onclick="viewTweetDetails('{{ tweet.id }}')" 
                    class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
              <i class="fas fa-eye"></i> Detay
            </button>
            
            {% if tweet.is_draft or not tweet.is_posted %}
            <button onclick="deleteManualTweet('{{ tweet.id }}')" 
                    class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
              <i class="fas fa-trash"></i> Sil
            </button>
            {% endif %}
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
    
    <div class="mt-6 text-center">
      <button onclick="loadAllManualTweets()" 
              class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-lg font-medium transition-colors">
        <i class="fas fa-list"></i> Tüm Tweet'leri Görüntüle
      </button>
    </div>
  </div>
</div>
{% endif %}

{% endblock %} 