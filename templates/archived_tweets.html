{% extends "base.html" %}

{% block title %}Arşivlenen Tweetler{% endblock %}

<!-- Haber kaynağı gösterimi için makro -->
{% macro render_source_badge(source, source_id, url, badge_type='primary') %}
    {% if source %}
        {% set source_class = 'source-badge-' + badge_type %}
        {% if 'techcrunch' in source.lower() %}
            {% set source_class = 'source-techcrunch' %}
        {% elif 'venturebeat' in source.lower() %}
            {% set source_class = 'source-venturebeat' %}
        {% elif 'wired' in source.lower() %}
            {% set source_class = 'source-wired' %}
        {% elif 'reddit' in source.lower() %}
            {% set source_class = 'source-reddit' %}
        {% elif 'economist' in source.lower() %}
            {% set source_class = 'source-economist' %}
        {% elif 'atlantic' in source.lower() %}
            {% set source_class = 'source-atlantic' %}
        {% elif 'guardian' in source.lower() %}
            {% set source_class = 'source-guardian' %}
        {% elif 'apple' in source.lower() %}
            {% set source_class = 'source-apple' %}
        {% elif 'hacker news' in source.lower() %}
            {% set source_class = 'source-hackernews' %}
        {% endif %}
        
        <div class="mb-4">
            <div class="source-badge {{ source_class }}">
                <i class="fas fa-newspaper source-icon"></i>
                <span>Kaynak:</span>
                <span class="source-name">{{ source }}</span>
                {% if source_id %}
                <span class="source-id">{{ source_id }}</span>
                {% endif %}
            </div>
        </div>
    {% elif url %}
        <!-- Fallback: URL'den kaynak adını çıkar -->
        {% set fallback_source = '' %}
        {% set fallback_class = 'source-badge-fallback' %}
        
        {% if 'techcrunch.com' in url %}
            {% set fallback_source = 'TechCrunch' %}
            {% set fallback_class = 'source-techcrunch' %}
        {% elif 'venturebeat.com' in url %}
            {% set fallback_source = 'VentureBeat' %}
            {% set fallback_class = 'source-venturebeat' %}
        {% elif 'wired.com' in url %}
            {% set fallback_source = 'Wired' %}
            {% set fallback_class = 'source-wired' %}
        {% elif 'reddit.com' in url %}
            {% set fallback_source = 'Reddit' %}
            {% set fallback_class = 'source-reddit' %}
        {% elif 'github.com' in url %}
            {% set fallback_source = 'GitHub' %}
            {% set fallback_class = 'source-badge-dark' %}
        {% endif %}
        
        {% if fallback_source %}
        <div class="mb-4">
            <div class="source-badge {{ fallback_class }}">
                <i class="fas fa-link source-icon"></i>
                <span>{{ fallback_source }}</span>
            </div>
        </div>
        {% endif %}
    {% endif %}
{% endmacro %}

{% block content %}
<!-- Archived Tweets Container with Scrollbar -->
<div class="archived-tweets-container">
    <!-- Twitter Feed Style -->
    <div class="twitter-feed">
    <!-- Header -->
    <div class="feed-header">
        <div class="feed-header-content">
            <div class="feed-header-left">
                <h1 class="feed-title">Arşivlenen Tweetler</h1>
                <p class="feed-subtitle">Arşivlenmiş olan tüm tweetleriniz</p>
            </div>
            <div class="feed-header-right">
                <button onclick="location.reload();" class="twitter-btn twitter-btn-secondary">
                    <i class="fas fa-sync-alt"></i>
                    Yenile
                </button>
            </div>
        </div>
    </div>

    <!-- Filtreler ve Arama -->
    <div class="tweet-card filter-section">
        <div class="filter-content">
            <div class="filter-row">
                <!-- Arama -->
                <div class="search-container">
                    <div class="search-input-wrapper">
                        <input type="text" id="searchInput" placeholder="Tweet başlığı veya içeriği ara..." 
                               class="search-input">
                        <i class="fas fa-search search-icon"></i>
                    </div>
                </div>
                
                <!-- Filtreler -->
                <div class="filter-buttons">
                    <select id="sourceFilter" class="filter-select">
                        <option value="">Tüm Kaynaklar</option>
                        <option value="github">GitHub</option>
                        <option value="news">Haber</option>
                        <option value="manual">Manuel</option>
                    </select>
                    
                    <select id="dateFilter" class="filter-select">
                        <option value="">Tüm Tarihler</option>
                        <option value="today">Bugün</option>
                        <option value="week">Bu Hafta</option>
                        <option value="month">Bu Ay</option>
                    </select>
                </div>
                
                <!-- Toplam Sayı -->
                <div class="total-count">
                    <i class="fas fa-archive"></i>
                    <span id="totalCount">{{ archived_articles|length if archived_articles else 0 }}</span> Tweet
                </div>
            </div>
        </div>
    </div>

    <!-- Arşivlenen Tweetler -->
    {% if archived_articles %}
    <div id="tweetsContainer" class="tweets-container">
        {% for article in archived_articles|reverse %}
        <div class="tweet-card archived-tweet {% if article.source_type == 'github' or article.type == 'github_repo' %}github-tweet{% else %}news-tweet{% endif %}"
             data-source="{{ 'github' if (article.source_type == 'github' or article.type == 'github_repo') else 'news' }}"
             data-manual="{{ 'true' if article.manual_post else 'false' }}"
             data-date="{{ article.archived_at[:10] if article.archived_at else '' }}"
             data-title="{{ article.title|lower }}"
             data-content="{{ article.tweet_text|lower if article.tweet_text else article.content|lower }}"
             data-index="{{ loop.index0 }}"
             data-tweet-id="{{ article.hash if article.hash else article.id if article.id else loop.index0 }}">
            
            <!-- Tweet Header -->
            <div class="tweet-header">
                <div class="tweet-avatar">
                    <i class="fas fa-archive"></i>
                </div>
                <div class="tweet-user-info">
                    <div class="tweet-user-name">Tweet Bot</div>
                    <div class="tweet-user-handle">@tweetbot</div>
                </div>
                <div class="tweet-status-badges">
                    <span class="status-badge status-archived">
                        <i class="fas fa-archive"></i>
                        Arşivlendi
                    </span>
                    {% if article.source_type == 'github' or article.type == 'github_repo' %}
                    <span class="status-badge status-github">
                        <i class="fab fa-github"></i>
                        GitHub
                    </span>
                    {% endif %}
                    {% if article.manual_post %}
                    <span class="status-badge status-manual">
                        <i class="fas fa-hand-paper"></i>
                        Manuel
                    </span>
                    {% else %}
                    <span class="status-badge status-api">
                        <i class="fas fa-robot"></i>
                        API
                    </span>
                    {% endif %}
                </div>
            </div>
            
            <!-- Tweet Content -->
            <div class="tweet-content">
                <div class="tweet-title">{{ article.title }}</div>
                <div class="tweet-text">{{ article.tweet_text if article.tweet_text else article.content }}</div>
            </div>
            
            <!-- Tweet Footer -->
            <div class="tweet-footer">
                <!-- Tweet Bilgileri -->
                <div class="tweet-info-grid">
                    <div class="tweet-info-item">
                        <i class="fas fa-calendar-alt"></i>
                        <span>{{ article.post_date[:10] if article.post_date else 'Belirtilmemiş' }}</span>
                    </div>
                    <div class="tweet-info-item">
                        <i class="fas fa-archive"></i>
                        <span>{{ article.archived_at[:10] if article.archived_at else 'Bilinmiyor' }}</span>
                    </div>
                    {% if article.tweet_id %}
                    <div class="tweet-info-item">
                        <i class="fab fa-twitter"></i>
                        <span>ID: {{ article.tweet_id }}</span>
                    </div>
                    {% endif %}
                    {% if article.hash %}
                    <div class="tweet-info-item">
                        <i class="fas fa-fingerprint"></i>
                        <span>{{ article.hash[:8] }}...</span>
                    </div>
                    {% endif %}
                </div>
                
                <!-- Kaynak Bilgisi -->
                <div class="tweet-source">
                    {{ render_source_badge(article.source, None, article.url) }}
                </div>
                
                <!-- Tweet Actions -->
                <div class="tweet-actions">
                    {% if article.tweet_url %}
                    <button class="tweet-action-btn" onclick="window.open('{{ article.tweet_url }}', '_blank')">
                        <i class="fab fa-twitter"></i>
                        <span>Tweet'i Görüntüle</span>
                    </button>
                    {% endif %}
                    <button class="tweet-action-btn" onclick="window.open('{{ article.url if article.url else '#' }}', '_blank')" {{ 'disabled' if not article.url else '' }}>
                        <i class="fas fa-external-link-alt"></i>
                        <span>{% if article.source_type == 'github' or article.type == 'github_repo' %}Repo'yu Görüntüle{% else %}Makaleyi Oku{% endif %}</span>
                    </button>
                    <button class="tweet-action-btn tweet-action-restore" onclick="restoreArchivedTweet('{{ loop.index0 }}')">
                        <i class="fas fa-undo"></i>
                        <span>Geri Yükle</span>
                    </button>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <!-- Empty State -->
    <div class="tweet-card empty-state">
        <div class="empty-state-icon">
            <i class="fas fa-archive"></i>
        </div>
        <h3 class="empty-state-title">Henüz Arşivlenen Tweet Yok</h3>
        <p class="empty-state-description">Arşivlenen tweet'leriniz burada görünecek. Paylaşılan tweet'ler sayfasından tweet'leri arşivleyebilirsiniz.</p>
        <a href="{{ url_for('shared_tweets') }}" class="twitter-btn twitter-btn-primary">
            <i class="fas fa-arrow-left"></i>
            <span>Paylaşılan Tweetler</span>
        </a>
    </div>
    {% endif %}
</div>

<!-- JavaScript -->
<script>
// Toast notification system
function showToast(message, type = 'info') {
    // Create toast container if it doesn't exist
    let toastContainer = document.getElementById('toast-container');
    if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.id = 'toast-container';
        toastContainer.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            max-width: 400px;
        `;
        document.body.appendChild(toastContainer);
    }

    // Create toast element
    const toast = document.createElement('div');
    const icon = getToastIcon(type);
    const title = getToastTitle(type);
    
    toast.className = `toast toast-${type}`;
    toast.style.cssText = `
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 10px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        display: flex;
        align-items: flex-start;
        gap: 12px;
        animation: slideIn 0.3s ease-out;
        max-width: 400px;
    `;
    
    toast.innerHTML = `
        <div style="flex-shrink: 0; font-size: 20px;">${icon}</div>
        <div style="flex: 1;">
            <div style="font-weight: 600; margin-bottom: 4px; color: #374151;">${title}</div>
            <div style="color: #6b7280; font-size: 14px;">${message}</div>
        </div>
        <button onclick="this.parentElement.remove()" style="
            background: none;
            border: none;
            color: #9ca3af;
            cursor: pointer;
            font-size: 18px;
            padding: 0;
            margin-left: 8px;
        ">&times;</button>
    `;
    
    toastContainer.appendChild(toast);
    
    // Auto remove after 5 seconds
    setTimeout(() => {
        if (toast.parentElement) {
            toast.style.animation = 'slideOut 0.3s ease-in';
            setTimeout(() => toast.remove(), 300);
        }
    }, 5000);
}

// Confirm dialog system
function showConfirmDialog(title, message, onConfirm, onCancel = null) {
    // Create modal container
    const modalContainer = document.createElement('div');
    modalContainer.id = 'confirm-dialog';
    modalContainer.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        animation: fadeIn 0.3s ease-out;
    `;
    
    // Create modal content
    const modalContent = document.createElement('div');
    modalContent.style.cssText = `
        background: white;
        border-radius: 16px;
        padding: 32px;
        max-width: 400px;
        width: 90%;
        text-align: center;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        animation: slideIn 0.3s ease-out;
    `;
    
    // Add CSS animations
    const style = document.createElement('style');
    style.textContent = `
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes slideIn {
            from { transform: translateY(-20px) scale(0.95); opacity: 0; }
            to { transform: translateY(0) scale(1); opacity: 1; }
        }
    `;
    document.head.appendChild(style);
    
    modalContent.innerHTML = `
        <div style="margin-bottom: 24px;">
            <div style="width: 64px; height: 64px; margin: 0 auto 16px; background: #dbeafe; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                <i class="fas fa-undo" style="font-size: 28px; color: #3b82f6;"></i>
            </div>
            <h3 style="font-size: 20px; font-weight: 700; color: #111827; margin-bottom: 8px;">${title}</h3>
            <p style="color: #6b7280; font-size: 16px; line-height: 1.5;">${message}</p>
        </div>
        <div style="display: flex; gap: 12px; justify-content: center;">
            <button id="confirm-cancel" style="
                padding: 12px 24px;
                border: 1px solid #d1d5db;
                border-radius: 8px;
                background: white;
                color: #374151;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.2s ease;
            ">İptal</button>
            <button id="confirm-ok" style="
                padding: 12px 24px;
                border: none;
                border-radius: 8px;
                background: #3b82f6;
                color: white;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.2s ease;
            ">Geri Yükle</button>
        </div>
    `;
    
    modalContainer.appendChild(modalContent);
    document.body.appendChild(modalContainer);
    
    // Add event listeners
    const cancelBtn = modalContainer.querySelector('#confirm-cancel');
    const confirmBtn = modalContainer.querySelector('#confirm-ok');
    
    cancelBtn.addEventListener('click', () => {
        modalContainer.remove();
        if (onCancel) onCancel();
    });
    
    confirmBtn.addEventListener('click', () => {
        modalContainer.remove();
        if (onConfirm) onConfirm();
    });
    
    // Close on overlay click
    modalContainer.addEventListener('click', (e) => {
        if (e.target === modalContainer) {
            modalContainer.remove();
            if (onCancel) onCancel();
        }
    });
}

function getToastIcon(type) {
    const icons = {
        success: '✅',
        error: '❌',
        warning: '⚠️',
        info: 'ℹ️'
    };
    return icons[type] || icons.info;
}

function getToastTitle(type) {
    const titles = {
        success: 'Başarılı',
        error: 'Hata',
        warning: 'Uyarı',
        info: 'Bilgi'
    };
    return titles[type] || titles.info;
}

// Add CSS animations
const style = document.createElement('style');
style.textContent = `
    @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    @keyframes slideOut {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
    }
`;
document.head.appendChild(style);

// Arama ve filtreleme
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('searchInput');
    const sourceFilter = document.getElementById('sourceFilter');
    const dateFilter = document.getElementById('dateFilter');
    const tweetsContainer = document.getElementById('tweetsContainer');
    const totalCount = document.getElementById('totalCount');
    
    function filterTweets() {
        const searchTerm = searchInput.value.toLowerCase();
        const sourceType = sourceFilter.value;
        const dateRange = dateFilter.value;
        const tweetItems = tweetsContainer.querySelectorAll('.tweet-card');
        
        let visibleCount = 0;
        const today = new Date();
        
        tweetItems.forEach(item => {
            const title = item.dataset.title || '';
            const content = item.dataset.content || '';
            const source = item.dataset.source || '';
            const isManual = item.dataset.manual === 'true';
            const dateStr = item.dataset.date || '';
            
            // Arama filtresi
            const matchesSearch = !searchTerm || 
                title.includes(searchTerm) || 
                content.includes(searchTerm);
            
            // Kaynak filtresi
            let matchesSource = true;
            if (sourceType === 'github') {
                matchesSource = source === 'github';
            } else if (sourceType === 'news') {
                matchesSource = source === 'news';
            } else if (sourceType === 'manual') {
                matchesSource = isManual;
            }
            
            // Tarih filtresi
            let matchesDate = true;
            if (dateRange && dateStr) {
                const tweetDate = new Date(dateStr);
                const diffTime = Math.abs(today - tweetDate);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                
                if (dateRange === 'today') {
                    matchesDate = diffDays <= 1;
                } else if (dateRange === 'week') {
                    matchesDate = diffDays <= 7;
                } else if (dateRange === 'month') {
                    matchesDate = diffDays <= 30;
                }
            }
            
            if (matchesSearch && matchesSource && matchesDate) {
                item.style.display = '';
                visibleCount++;
            } else {
                item.style.display = 'none';
            }
        });
        
        totalCount.textContent = visibleCount;
    }
    
    // Event listeners
    searchInput.addEventListener('input', filterTweets);
    sourceFilter.addEventListener('change', filterTweets);
    dateFilter.addEventListener('change', filterTweets);
});

// Tweet geri yükleme fonksiyonu
function restoreArchivedTweet(index) {
    showConfirmDialog(
        'Tweet Geri Yükle',
        'Bu tweeti arşivden geri yüklemek istediğinizden emin misiniz? Tweet tekrar paylaşılan tweetler sayfasında görünecek.',
        () => {
            // Geri yükleme işlemi
            restoreTweet(index);
        }
    );
}

// Tweet geri yükleme API çağrısı
function restoreTweet(index) {
    showToast('Tweet geri yükleniyor...', 'info');
    
    // Tweet ID'sini al
    const tweetCard = document.querySelector(`[data-index="${index}"]`);
    if (!tweetCard) {
        showToast('Tweet bulunamadı!', 'error');
        return;
    }
    
    const tweetId = tweetCard.dataset.tweetId || index;
    
    // API çağrısı
    fetch('/api/restore_archived_tweet', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            tweet_id: tweetId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('Tweet başarıyla geri yüklendi!', 'success');
            // Tweet'i gizle
            tweetCard.style.display = 'none';
            // Toplam sayıyı güncelle
            updateTotalCount();
        } else {
            showToast('Geri yükleme hatası: ' + data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Geri yükleme hatası:', error);
        showToast('Bir hata oluştu: ' + error.message, 'error');
    });
}

// Toplam sayıyı güncelle
function updateTotalCount() {
    const visibleTweets = document.querySelectorAll('.tweet-card[style*="display: none"]').length;
    const totalTweets = document.querySelectorAll('.tweet-card').length;
    const visibleCount = totalTweets - visibleTweets;
    
    const totalCountElement = document.getElementById('totalCount');
    if (totalCountElement) {
        totalCountElement.textContent = visibleCount;
    }
}
</script>
    </div>
</div>
{% endblock %}
