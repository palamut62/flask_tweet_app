{% extends "base.html" %}

{% block title %}Reddedilen Makaleler - AI Tweet Bot{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900 mb-2">Reddedilen Makaleler</h1>
        <p class="text-gray-600">Kalite kontrolü tarafından reddedilen makaleler</p>
    </div>

    <!-- İstatistikler -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <div class="bg-red-50 p-6 rounded-lg border border-red-200">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <i class="fas fa-ban text-red-500 text-2xl"></i>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-red-600">Toplam Reddedilen</p>
                    <p class="text-2xl font-semibold text-red-900">{{ stats.total_rejected or 0 }}</p>
                </div>
            </div>
        </div>
        
        <div class="bg-yellow-50 p-6 rounded-lg border border-yellow-200">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <i class="fas fa-clock text-yellow-500 text-2xl"></i>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-yellow-600">Bugün Reddedilen</p>
                    <p class="text-2xl font-semibold text-yellow-900">{{ stats.rejected_today or 0 }}</p>
                </div>
            </div>
        </div>
        
        <div class="bg-orange-50 p-6 rounded-lg border border-orange-200">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <i class="fas fa-calendar-week text-orange-500 text-2xl"></i>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-orange-600">Bu Hafta Reddedilen</p>
                    <p class="text-2xl font-semibold text-orange-900">{{ stats.rejected_this_week or 0 }}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Reddetme Sebepleri -->
    {% if stats.common_reasons %}
    <div class="mb-8">
        <h2 class="text-xl font-semibold text-gray-900 mb-4">Sık Görülen Reddetme Sebepleri</h2>
        <div class="bg-white shadow rounded-lg p-6">
            <div class="space-y-3">
                {% for reason, count in stats.common_reasons.items() %}
                <div class="flex justify-between items-center">
                    <span class="text-sm text-gray-700">{{ reason }}</span>
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                        {{ count }} makale
                    </span>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Toplu İşlemler Paneli -->
    {% if rejected_articles %}
    <div class="bg-gradient-to-r from-red-50 to-orange-50 border border-red-200 rounded-lg p-4 mb-6">
        <div class="flex items-center justify-between">
            <div class="flex items-center space-x-3">
                <input type="checkbox" id="select-all-rejected" onchange="toggleAllRejected()" class="rounded border-gray-300 text-red-600 focus:ring-red-500">
                <label for="select-all-rejected" class="text-sm font-medium text-gray-700">
                    <i class="fas fa-tasks text-red-500"></i> Toplu İşlemler
                </label>
                <span id="selected-rejected-count" class="text-xs text-gray-500">(0 seçili)</span>
            </div>
            <div class="flex items-center space-x-2">
                <button onclick="bulkDeleteRejected()" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-all duration-200 flex items-center gap-2 text-sm disabled:opacity-50" id="bulk-delete-btn" disabled>
                    <i class="fas fa-trash"></i> Toplu Sil
                </button>
                <button onclick="bulkClearRejected()" class="px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition-all duration-200 flex items-center gap-2 text-sm disabled:opacity-50" id="bulk-clear-btn" disabled>
                    <i class="fas fa-broom"></i> Toplu Temizle
                </button>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Reddedilen Makaleler Listesi -->
    <div class="bg-white shadow rounded-lg">
        <div class="px-6 py-4 border-b border-gray-200">
            <h2 class="text-lg font-medium text-gray-900">Reddedilen Makaleler</h2>
        </div>
        
        {% if rejected_articles %}
        <div class="divide-y divide-gray-200">
            {% for article in rejected_articles %}
            <div class="p-6 hover:bg-gray-50" data-article-id="{{ loop.index0 }}">
                <div class="flex items-start justify-between">
                    <!-- Toplu İşlem Checkbox -->
                    <div class="flex items-center mt-1 mr-3">
                        <input type="checkbox" class="rejected-checkbox rounded border-gray-300 text-red-600 focus:ring-red-500" 
                               value="{{ loop.index0 }}" onchange="updateRejectedBulkButtons()">
                    </div>
                    
                    <div class="flex-1 min-w-0">
                        <h3 class="text-lg font-medium text-gray-900 truncate">
                            {{ article.title or 'Başlık yok' }}
                        </h3>
                        
                        <div class="mt-2 flex items-center text-sm text-gray-500">
                            <i class="fas fa-clock mr-1"></i>
                            <span>{{ article.rejected_at_formatted }}</span>
                            <span class="mx-2">•</span>
                            <i class="fas fa-ban mr-1 text-red-500"></i>
                            <span class="text-red-600 font-medium">{{ article.reason }}</span>
                        </div>
                        
                        {% if article.url %}
                        <div class="mt-2">
                            <a href="{{ article.url }}" target="_blank" 
                               class="text-blue-600 hover:text-blue-800 text-sm flex items-center">
                                <i class="fas fa-external-link-alt mr-1"></i>
                                {{ article.url[:80] }}{% if article.url|length > 80 %}...{% endif %}
                            </a>
                        </div>
                        {% endif %}
                        
                        {% if article.content_preview %}
                        <div class="mt-3">
                            <details class="text-sm">
                                <summary class="cursor-pointer text-gray-600 hover:text-gray-800">
                                    İçerik Önizlemesi
                                </summary>
                                <div class="mt-2 p-3 bg-gray-50 rounded border text-gray-700">
                                    {{ article.content_preview }}
                                </div>
                            </details>
                        </div>
                        {% endif %}
                    </div>
                    
                    <div class="ml-4 flex-shrink-0">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                            Reddedildi
                        </span>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="p-12 text-center">
            <div class="w-12 h-12 mx-auto mb-4 text-gray-400">
                <i class="fas fa-check-circle text-4xl"></i>
            </div>
            <h3 class="text-lg font-medium text-gray-900 mb-2">Reddedilen Makale Yok</h3>
            <p class="text-gray-500">Henüz kalite kontrolü tarafından reddedilen makale bulunmuyor.</p>
        </div>
        {% endif %}
    </div>
    
    <!-- Bilgi Notu -->
    <div class="mt-8 bg-blue-50 border border-blue-200 rounded-lg p-4">
        <div class="flex items-start">
            <div class="flex-shrink-0">
                <i class="fas fa-info-circle text-blue-500 mt-0.5"></i>
            </div>
            <div class="ml-3">
                <h3 class="text-sm font-medium text-blue-800">Kalite Kontrol Hakkında</h3>
                <div class="mt-2 text-sm text-blue-700">
                    <p>Makaleler aşağıdaki durumlarda otomatik olarak reddedilir:</p>
                    <ul class="list-disc list-inside mt-1 space-y-1">
                        <li>Başlık veya içerik çok kısa</li>
                        <li>"Major AI development" gibi genel başlıklar</li>
                        <li>"No company" gibi anlamsız içerikler</li>
                        <li>İçeriğe erişim hatası</li>
                        <li>Tekrarlayan/spam içerik</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Toast Notification Container -->
<div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2 max-w-sm w-full"></div>

<script>
// Toast Notification System
function showToast(message, type = 'info', duration = 5000) {
    const container = document.getElementById('toast-container');
    if (!container) return;
    
    const toastTypes = {
        'success': {
            bgColor: 'bg-green-500',
            textColor: 'text-white',
            icon: 'fas fa-check-circle',
            borderColor: 'border-green-600'
        },
        'error': {
            bgColor: 'bg-red-500',
            textColor: 'text-white',
            icon: 'fas fa-exclamation-circle',
            borderColor: 'border-red-600'
        },
        'warning': {
            bgColor: 'bg-yellow-500',
            textColor: 'text-white',
            icon: 'fas fa-exclamation-triangle',
            borderColor: 'border-yellow-600'
        },
        'info': {
            bgColor: 'bg-blue-500',
            textColor: 'text-white',
            icon: 'fas fa-info-circle',
            borderColor: 'border-blue-600'
        }
    };
    
    const toastConfig = toastTypes[type] || toastTypes['info'];
    const toastId = 'toast-' + Date.now();
    
    const toastHtml = `
        <div id="${toastId}" class="transform translate-x-full transition-all duration-300 ease-out opacity-0">
            <div class="${toastConfig.bgColor} ${toastConfig.textColor} ${toastConfig.borderColor} border-l-4 rounded-lg shadow-lg p-4 flex items-center space-x-3 min-w-0">
                <div class="flex-shrink-0">
                    <i class="${toastConfig.icon}"></i>
                </div>
                <div class="flex-1 min-w-0">
                    <p class="text-sm font-medium leading-5 break-words">${message}</p>
                </div>
                <button onclick="removeToast('${toastId}')" class="flex-shrink-0 text-white hover:text-gray-200 transition-colors">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
    `;
    
    container.insertAdjacentHTML('beforeend', toastHtml);
    
    const toastElement = document.getElementById(toastId);
    
    setTimeout(() => {
        toastElement.classList.remove('translate-x-full', 'opacity-0');
        toastElement.classList.add('translate-x-0', 'opacity-100');
    }, 10);
    
    if (duration > 0) {
        setTimeout(() => {
            removeToast(toastId);
        }, duration);
    }
    
    return toastId;
}

function removeToast(toastId) {
    const toast = document.getElementById(toastId);
    if (toast) {
        toast.classList.add('translate-x-full', 'opacity-0');
        setTimeout(() => {
            toast.remove();
        }, 300);
    }
}

// Reddedilen makaleler için toplu işlem fonksiyonları
function toggleAllRejected() {
    const selectAllCheckbox = document.getElementById('select-all-rejected');
    const checkboxes = document.querySelectorAll('.rejected-checkbox');
    
    checkboxes.forEach(checkbox => {
        checkbox.checked = selectAllCheckbox.checked;
    });
    
    updateRejectedBulkButtons();
}

function updateRejectedBulkButtons() {
    const checkboxes = document.querySelectorAll('.rejected-checkbox:checked');
    const selectedCount = checkboxes.length;
    const selectAllCheckbox = document.getElementById('select-all-rejected');
    const allCheckboxes = document.querySelectorAll('.rejected-checkbox');
    
    // Seçili sayısını güncelle
    document.getElementById('selected-rejected-count').textContent = `(${selectedCount} seçili)`;
    
    // Butonları güncelle
    document.getElementById('bulk-delete-btn').disabled = selectedCount === 0;
    document.getElementById('bulk-clear-btn').disabled = selectedCount === 0;
    
    // "Tümünü seç" checkbox'ını güncelle
    if (selectedCount === 0) {
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = false;
    } else if (selectedCount === allCheckboxes.length) {
        selectAllCheckbox.checked = true;
        selectAllCheckbox.indeterminate = false;
    } else {
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = true;
    }
}

function bulkDeleteRejected() {
    const checkboxes = document.querySelectorAll('.rejected-checkbox:checked');
    const selectedIds = Array.from(checkboxes).map(cb => cb.value);
    
    if (selectedIds.length === 0) {
        showToast('Lütfen silinecek makaleleri seçin', 'warning');
        return;
    }
    
    if (!confirm(`${selectedIds.length} reddedilen makaleyi kalıcı olarak silmek istediğinizden emin misiniz?`)) {
        return;
    }
    
    showToast('Makaleler siliniyor...', 'info');
    
    fetch('/bulk_delete_rejected', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            article_ids: selectedIds
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast(`${data.deleted_count} makale başarıyla silindi`, 'success');
            setTimeout(() => {
                location.reload();
            }, 1500);
        } else {
            showToast(`Hata: ${data.error}`, 'error');
        }
    })
    .catch(error => {
        showToast(`İşlem hatası: ${error}`, 'error');
    });
}

function bulkClearRejected() {
    const checkboxes = document.querySelectorAll('.rejected-checkbox:checked');
    const selectedIds = Array.from(checkboxes).map(cb => cb.value);
    
    if (selectedIds.length === 0) {
        showToast('Lütfen temizlenecek makaleleri seçin', 'warning');
        return;
    }
    
    if (!confirm(`${selectedIds.length} reddedilen makaleyi temizlemek istediğinizden emin misiniz?`)) {
        return;
    }
    
    showToast('Makaleler temizleniyor...', 'info');
    
    fetch('/bulk_clear_rejected', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            article_ids: selectedIds
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast(`${data.cleared_count} makale başarıyla temizlendi`, 'success');
            setTimeout(() => {
                location.reload();
            }, 1500);
        } else {
            showToast(`Hata: ${data.error}`, 'error');
        }
    })
    .catch(error => {
        showToast(`İşlem hatası: ${error}`, 'error');
    });
}
</script>
{% endblock %}