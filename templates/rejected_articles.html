{% extends "base.html" %}

{% block title %}Reddedilen Makaleler{% endblock %}

{% block content %}
<!-- Rejected Articles Container with Scrollbar -->
<div class="rejected-articles-container">
    <!-- Twitter Feed Style -->
    <div class="twitter-feed">
    <!-- Header -->
    <div class="feed-header">
        <div class="feed-header-content">
            <div class="feed-header-left">
                <h1 class="feed-title">Reddedilen Makaleler</h1>
                <p class="feed-subtitle">Kalite kontrolü tarafından reddedilen makaleler</p>
            </div>
            <div class="feed-header-right">
                <button onclick="location.reload();" class="twitter-btn twitter-btn-secondary">
                    <i class="fas fa-sync-alt"></i>
                    Yenile
                </button>
            </div>
        </div>
    </div>

    <!-- İstatistikler -->
    <div class="rejected-stats-grid">
        <div class="tweet-card rejected-stat-card rejected-stat-red">
            <div class="rejected-stat-icon">
                <i class="fas fa-ban"></i>
            </div>
            <div class="rejected-stat-content">
                <div class="rejected-stat-number">{{ stats.total_rejected or 0 }}</div>
                <div class="rejected-stat-label">Toplam Reddedilen</div>
            </div>
        </div>
        
        <div class="tweet-card rejected-stat-card rejected-stat-yellow">
            <div class="rejected-stat-icon">
                <i class="fas fa-clock"></i>
            </div>
            <div class="rejected-stat-content">
                <div class="rejected-stat-number">{{ stats.rejected_today or 0 }}</div>
                <div class="rejected-stat-label">Bugün Reddedilen</div>
            </div>
        </div>
        
        <div class="tweet-card rejected-stat-card rejected-stat-orange">
            <div class="rejected-stat-icon">
                <i class="fas fa-calendar-week"></i>
            </div>
            <div class="rejected-stat-content">
                <div class="rejected-stat-number">{{ stats.rejected_this_week or 0 }}</div>
                <div class="rejected-stat-label">Bu Hafta Reddedilen</div>
            </div>
        </div>
    </div>

    <!-- Reddetme Sebepleri -->
    {% if stats.common_reasons %}
    <div class="tweet-card">
        <div class="rejected-reasons-header">
            <div class="rejected-reasons-icon">
                <i class="fas fa-chart-pie"></i>
            </div>
            <h2 class="rejected-reasons-title">Sık Görülen Reddetme Sebepleri</h2>
        </div>
        <div class="rejected-reasons-content">
            {% for reason, count in stats.common_reasons.items() %}
            <div class="rejected-reason-item">
                <div class="rejected-reason-text">{{ reason }}</div>
                <div class="rejected-reason-count">{{ count }} makale</div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Toplu İşlemler Paneli -->
    {% if rejected_articles %}
    <div class="tweet-card bulk-actions-card">
        <div class="bulk-actions-content">
            <div class="bulk-actions-left">
                <div class="bulk-checkbox-wrapper">
                    <input type="checkbox" id="select-all-rejected" onchange="toggleAllRejected()" class="bulk-checkbox">
                    <label for="select-all-rejected" class="bulk-checkbox-label">
                        <i class="fas fa-tasks"></i>
                        Toplu İşlemler
                    </label>
                </div>
                <div class="bulk-count" id="selected-rejected-count">(0 seçili)</div>
            </div>
            <div class="bulk-actions-right">
                <button onclick="bulkDeleteRejected()" class="twitter-btn twitter-btn-danger" id="bulk-delete-btn" disabled>
                    <i class="fas fa-trash"></i>
                    <span>Toplu Sil</span>
                </button>
                <button onclick="bulkClearRejected()" class="twitter-btn twitter-btn-warning" id="bulk-clear-btn" disabled>
                    <i class="fas fa-broom"></i>
                    <span>Toplu Temizle</span>
                </button>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Reddedilen Makaleler Listesi -->
    <div class="tweet-card">
        <div class="rejected-articles-header">
            <h2 class="rejected-articles-title">Reddedilen Makaleler</h2>
        </div>
        
        {% if rejected_articles %}
        <div class="rejected-articles-container">
            {% for article in rejected_articles %}
            <div class="rejected-article-item" data-article-id="{{ loop.index0 }}">
                <!-- Toplu İşlem Checkbox -->
                <div class="rejected-checkbox-wrapper">
                    <input type="checkbox" class="rejected-checkbox" 
                           value="{{ loop.index0 }}" onchange="updateRejectedBulkButtons()">
                </div>
                
                <div class="rejected-article-content">
                    <div class="rejected-article-header">
                        <h3 class="rejected-article-title">{{ article.title or 'Başlık yok' }}</h3>
                        <div class="rejected-article-meta">
                            <div class="rejected-article-date">
                                <i class="fas fa-clock"></i>
                                <span>{{ article.rejected_at_formatted }}</span>
                            </div>
                            <div class="rejected-article-reason">
                                <i class="fas fa-ban"></i>
                                <span>{{ article.reason }}</span>
                            </div>
                        </div>
                    </div>
                    
                    {% if article.url %}
                    <div class="rejected-article-url">
                        <a href="{{ article.url }}" target="_blank" class="rejected-article-link">
                            <i class="fas fa-external-link-alt"></i>
                            <span>{{ article.url[:80] }}{% if article.url|length > 80 %}...{% endif %}</span>
                        </a>
                    </div>
                    {% endif %}
                    
                    {% if article.content_preview %}
                    <div class="rejected-article-preview">
                        <details class="rejected-preview-details">
                            <summary class="rejected-preview-summary">
                                İçerik Önizlemesi
                            </summary>
                            <div class="rejected-preview-content">
                                {{ article.content_preview }}
                            </div>
                        </details>
                    </div>
                    {% endif %}
                </div>
                
                <div class="rejected-article-status">
                    <span class="status-badge status-rejected">
                        Reddedildi
                    </span>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="empty-state">
            <div class="empty-state-icon">
                <i class="fas fa-check-circle"></i>
            </div>
            <h3 class="empty-state-title">Reddedilen Makale Yok</h3>
            <p class="empty-state-description">Henüz kalite kontrolü tarafından reddedilen makale bulunmuyor.</p>
        </div>
        {% endif %}
    </div>
    
    <!-- Bilgi Notu -->
    <div class="tweet-card info-card">
        <div class="info-card-header">
            <div class="info-card-icon">
                <i class="fas fa-info-circle"></i>
            </div>
            <h3 class="info-card-title">Kalite Kontrol Hakkında</h3>
        </div>
        <div class="info-card-content">
            <p class="info-card-text">Makaleler aşağıdaki durumlarda otomatik olarak reddedilir:</p>
            <ul class="info-card-list">
                <li>Başlık veya içerik çok kısa</li>
                <li>"Major AI development" gibi genel başlıklar</li>
                <li>"No company" gibi anlamsız içerikler</li>
                <li>İçeriğe erişim hatası</li>
                <li>Tekrarlayan/spam içerik</li>
            </ul>
        </div>
    </div>
</div>

<script>
// Toast notification system
function showToast(message, type = 'info') {
    // Create toast container if it doesn't exist
    let toastContainer = document.getElementById('toast-container');
    if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.id = 'toast-container';
        toastContainer.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            max-width: 400px;
        `;
        document.body.appendChild(toastContainer);
    }

    // Create toast element
    const toast = document.createElement('div');
    const icon = getToastIcon(type);
    const title = getToastTitle(type);
    
    toast.className = `toast toast-${type}`;
    toast.style.cssText = `
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 10px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        display: flex;
        align-items: flex-start;
        gap: 12px;
        animation: slideIn 0.3s ease-out;
        max-width: 400px;
    `;
    
    toast.innerHTML = `
        <div style="flex-shrink: 0; font-size: 20px;">${icon}</div>
        <div style="flex: 1;">
            <div style="font-weight: 600; margin-bottom: 4px; color: #374151;">${title}</div>
            <div style="color: #6b7280; font-size: 14px;">${message}</div>
        </div>
        <button onclick="this.parentElement.remove()" style="
            background: none;
            border: none;
            color: #9ca3af;
            cursor: pointer;
            font-size: 18px;
            padding: 0;
            margin-left: 8px;
        ">&times;</button>
    `;
    
    toastContainer.appendChild(toast);
    
    // Auto remove after 5 seconds
    setTimeout(() => {
        if (toast.parentElement) {
            toast.style.animation = 'slideOut 0.3s ease-in';
            setTimeout(() => toast.remove(), 300);
        }
    }, 5000);
}

function getToastIcon(type) {
    const icons = {
        success: '✅',
        error: '❌',
        warning: '⚠️',
        info: 'ℹ️'
    };
    return icons[type] || icons.info;
}

function getToastTitle(type) {
    const titles = {
        success: 'Başarılı',
        error: 'Hata',
        warning: 'Uyarı',
        info: 'Bilgi'
    };
    return titles[type] || titles.info;
}

// Add CSS animations
const style = document.createElement('style');
style.textContent = `
    @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    @keyframes slideOut {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
    }
`;
document.head.appendChild(style);

// Reddedilen makaleler için toplu işlem fonksiyonları
function toggleAllRejected() {
    const selectAllCheckbox = document.getElementById('select-all-rejected');
    const checkboxes = document.querySelectorAll('.rejected-checkbox');
    
    checkboxes.forEach(checkbox => {
        checkbox.checked = selectAllCheckbox.checked;
    });
    
    updateRejectedBulkButtons();
}

function updateRejectedBulkButtons() {
    const checkboxes = document.querySelectorAll('.rejected-checkbox:checked');
    const selectedCount = checkboxes.length;
    const selectAllCheckbox = document.getElementById('select-all-rejected');
    const allCheckboxes = document.querySelectorAll('.rejected-checkbox');
    
    // Seçili sayısını güncelle
    document.getElementById('selected-rejected-count').textContent = `(${selectedCount} seçili)`;
    
    // Butonları güncelle
    document.getElementById('bulk-delete-btn').disabled = selectedCount === 0;
    document.getElementById('bulk-clear-btn').disabled = selectedCount === 0;
    
    // "Tümünü seç" checkbox'ını güncelle
    if (selectedCount === 0) {
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = false;
    } else if (selectedCount === allCheckboxes.length) {
        selectAllCheckbox.checked = true;
        selectAllCheckbox.indeterminate = false;
    } else {
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = true;
    }
}

function bulkDeleteRejected() {
    const checkboxes = document.querySelectorAll('.rejected-checkbox:checked');
    const selectedIds = Array.from(checkboxes).map(cb => cb.value);
    
    if (selectedIds.length === 0) {
        showToast('Lütfen silinecek makaleleri seçin', 'warning');
        return;
    }
    
    if (!confirm(`${selectedIds.length} reddedilen makaleyi kalıcı olarak silmek istediğinizden emin misiniz?`)) {
        return;
    }
    
    showToast('Makaleler siliniyor...', 'info');
    
    fetch('/bulk_delete_rejected', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            article_ids: selectedIds
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast(`${data.deleted_count} makale başarıyla silindi`, 'success');
            setTimeout(() => {
                location.reload();
            }, 1500);
        } else {
            showToast(`Hata: ${data.error}`, 'error');
        }
    })
    .catch(error => {
        showToast(`İşlem hatası: ${error}`, 'error');
    });
}

function bulkClearRejected() {
    const checkboxes = document.querySelectorAll('.rejected-checkbox:checked');
    const selectedIds = Array.from(checkboxes).map(cb => cb.value);
    
    if (selectedIds.length === 0) {
        showToast('Lütfen temizlenecek makaleleri seçin', 'warning');
        return;
    }
    
    if (!confirm(`${selectedIds.length} reddedilen makaleyi temizlemek istediğinizden emin misiniz?`)) {
        return;
    }
    
    showToast('Makaleler temizleniyor...', 'info');
    
    fetch('/bulk_clear_rejected', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            article_ids: selectedIds
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast(`${data.cleared_count} makale başarıyla temizlendi`, 'success');
            setTimeout(() => {
                location.reload();
            }, 1500);
        } else {
            showToast(`Hata: ${data.error}`, 'error');
        }
    })
    .catch(error => {
        showToast(`İşlem hatası: ${error}`, 'error');
    });
}
</script>
    </div>
</div>
{% endblock %}