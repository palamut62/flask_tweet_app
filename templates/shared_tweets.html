{% extends "base.html" %}

{% block title %}Paylaşılan Tweetler{% endblock %}

<!-- Haber kaynağı gösterimi için makro -->
{% macro render_source_badge(source, source_id, url, badge_type='primary') %}
    {% if source %}
        {% set source_class = 'source-badge-' + badge_type %}
        {% if 'techcrunch' in source.lower() %}
            {% set source_class = 'source-techcrunch' %}
        {% elif 'venturebeat' in source.lower() %}
            {% set source_class = 'source-venturebeat' %}
        {% elif 'wired' in source.lower() %}
            {% set source_class = 'source-wired' %}
        {% elif 'reddit' in source.lower() %}
            {% set source_class = 'source-reddit' %}
        {% elif 'economist' in source.lower() %}
            {% set source_class = 'source-economist' %}
        {% elif 'atlantic' in source.lower() %}
            {% set source_class = 'source-atlantic' %}
        {% elif 'guardian' in source.lower() %}
            {% set source_class = 'source-guardian' %}
        {% elif 'apple' in source.lower() %}
            {% set source_class = 'source-apple' %}
        {% elif 'hacker news' in source.lower() %}
            {% set source_class = 'source-hackernews' %}
        {% endif %}
        
        <div class="mb-4">
            <div class="source-badge {{ source_class }}">
                <i class="fas fa-newspaper source-icon"></i>
                <span>Kaynak:</span>
                <span class="source-name">{{ source }}</span>
                {% if source_id %}
                <span class="source-id">{{ source_id }}</span>
                {% endif %}
            </div>
        </div>
    {% elif url %}
        <!-- Fallback: URL'den kaynak adını çıkar -->
        {% set fallback_source = '' %}
        {% set fallback_class = 'source-badge-fallback' %}
        
        {% if 'techcrunch.com' in url %}
            {% set fallback_source = 'TechCrunch' %}
            {% set fallback_class = 'source-techcrunch' %}
        {% elif 'venturebeat.com' in url %}
            {% set fallback_source = 'VentureBeat' %}
            {% set fallback_class = 'source-venturebeat' %}
        {% elif 'wired.com' in url %}
            {% set fallback_source = 'Wired' %}
            {% set fallback_class = 'source-wired' %}
        {% elif 'reddit.com' in url %}
            {% set fallback_source = 'Reddit' %}
            {% set fallback_class = 'source-reddit' %}
        {% elif 'github.com' in url %}
            {% set fallback_source = 'GitHub' %}
            {% set fallback_class = 'source-badge-dark' %}
        {% endif %}
        
        {% if fallback_source %}
        <div class="mb-4">
            <div class="source-badge {{ fallback_class }}">
                <i class="fas fa-link source-icon"></i>
                <span>{{ fallback_source }}</span>
            </div>
        </div>
        {% endif %}
    {% endif %}
{% endmacro %}

{% block content %}
<!-- Twitter Feed Style -->
<div class="twitter-feed">
    <!-- Header -->
    <div class="feed-header">
        <div class="feed-header-content">
            <div class="feed-header-left">
                <h1 class="feed-title">Paylaşılan Tweetler</h1>
                <p class="feed-subtitle">Başarıyla paylaşılmış olan tüm tweetleriniz</p>
            </div>
            <div class="feed-header-right">
                <button onclick="bulkArchiveAll()" class="twitter-btn twitter-btn-danger" id="bulkArchiveAllBtn" style="display: none;">
                    <i class="fas fa-archive"></i>
                    Tümünü Arşivle
                </button>
                <button onclick="location.reload();" class="twitter-btn twitter-btn-secondary">
                    <i class="fas fa-sync-alt"></i>
                    Yenile
                </button>
            </div>
        </div>
    </div>

    <!-- Filtreler ve Arama -->
    <div class="tweet-card filter-section">
        <div class="filter-content">
            <div class="filter-row">
                <!-- Arama -->
                <div class="search-container">
                    <div class="search-input-wrapper">
                        <input type="text" id="searchInput" placeholder="Tweet başlığı veya içeriği ara..." 
                               class="search-input">
                        <i class="fas fa-search search-icon"></i>
                    </div>
                </div>
                
                <!-- Filtreler -->
                <div class="filter-buttons">
                    <select id="sourceFilter" class="filter-select">
                        <option value="">Tüm Kaynaklar</option>
                        <option value="github">GitHub</option>
                        <option value="news">Haber</option>
                        <option value="manual">Manuel</option>
                    </select>
                    
                    <select id="dateFilter" class="filter-select">
                        <option value="">Tüm Tarihler</option>
                        <option value="today">Bugün</option>
                        <option value="week">Bu Hafta</option>
                        <option value="month">Bu Ay</option>
                    </select>
                </div>
                
                <!-- Toplam Sayı -->
                <div class="total-count">
                    <i class="fas fa-chart-bar"></i>
                    <span id="totalCount">{{ articles|length if articles else 0 }}</span> Tweet
                </div>
            </div>
        </div>
    </div>

    <!-- Paylaşılan Tweetler -->
    {% if articles %}
    <!-- Toplu İşlemler -->
    {% if articles|length > 1 %}
    <div class="tweet-card bulk-actions-section">
        <div class="bulk-actions-content">
            <div class="bulk-actions-left">
                <label class="bulk-checkbox-wrapper">
                    <input type="checkbox" id="selectAllCheckbox" class="bulk-checkbox" onchange="toggleSelectAll()">
                    <span class="bulk-checkbox-label">Tümünü Seç</span>
                </label>
            </div>
            <div class="bulk-actions-right">
                <span class="bulk-count" id="bulkCount" style="display: none;">
                    <span id="selectedCount">0</span> tweet seçildi
                </span>
            </div>
        </div>
    </div>
    {% endif %}
    
    <div id="tweetsContainer" class="tweets-container">
        {% for article in articles|reverse %}
        {% if not article.deleted and not article.archived %}
        <div class="tweet-card {% if article.source_type == 'github' or article.type == 'github_repo' %}github-tweet{% else %}news-tweet{% endif %}"
             data-source="{{ 'github' if (article.source_type == 'github' or article.type == 'github_repo') else 'news' }}"
             data-manual="{{ 'true' if article.manual_post else 'false' }}"
             data-date="{{ article.post_date[:10] if article.post_date else '' }}"
             data-title="{{ article.title|lower }}"
             data-content="{{ article.tweet_text|lower if article.tweet_text else article.content|lower }}"
             data-index="{{ loop.index0 }}"
             data-tweet-id="{{ article.hash if article.hash else article.id if article.id else loop.index0 }}"
             data-article-id="{{ loop.index0 }}">
            
            <!-- Tweet Header -->
            <div class="tweet-header">
                <div class="tweet-checkbox-wrapper">
                    <input type="checkbox" class="tweet-select-checkbox" onchange="updateBulkButtons()">
                </div>
                <div class="tweet-avatar">
                    <i class="fas fa-robot"></i>
                </div>
                <div class="tweet-user-info">
                    <div class="tweet-user-name">Tweet Bot</div>
                    <div class="tweet-user-handle">@tweetbot</div>
                </div>
                <div class="tweet-status-badges">
                    <span class="status-badge status-success">
                        <i class="fas fa-check-circle"></i>
                        Paylaşıldı
                    </span>
                    {% if article.source_type == 'github' or article.type == 'github_repo' %}
                    <span class="status-badge status-github">
                        <i class="fab fa-github"></i>
                        GitHub
                    </span>
                    {% endif %}
                    {% if article.manual_post %}
                    <span class="status-badge status-manual">
                        <i class="fas fa-hand-paper"></i>
                        Manuel
                    </span>
                    {% else %}
                    <span class="status-badge status-api">
                        <i class="fas fa-robot"></i>
                        API
                    </span>
                    {% endif %}
                </div>
            </div>
            
            <!-- Tweet Content -->
            <div class="tweet-content">
                <div class="tweet-title">{{ article.title }}</div>
                <div class="tweet-text">{{ article.tweet_text if article.tweet_text else article.content }}</div>
            </div>
            
            <!-- Tweet Footer -->
            <div class="tweet-footer">
                <!-- Tweet Bilgileri -->
                <div class="tweet-info-grid">
                    <div class="tweet-info-item">
                        <i class="fas fa-calendar-alt"></i>
                        <span>{{ article.post_date[:10] if article.post_date else 'Belirtilmemiş' }}</span>
                    </div>
                    <div class="tweet-info-item">
                        <i class="fas fa-clock"></i>
                        <span>{{ article.post_date[11:19] if article.post_date and article.post_date|length > 19 else 'N/A' }}</span>
                    </div>
                    {% if article.tweet_id %}
                    <div class="tweet-info-item">
                        <i class="fab fa-twitter"></i>
                        <span>ID: {{ article.tweet_id }}</span>
                    </div>
                    {% endif %}
                    {% if article.hash %}
                    <div class="tweet-info-item">
                        <i class="fas fa-fingerprint"></i>
                        <span>{{ article.hash[:8] }}...</span>
                    </div>
                    {% endif %}
                </div>
                
                <!-- Kaynak Bilgisi -->
                <div class="tweet-source">
                    {{ render_source_badge(article.source, None, article.url) }}
                </div>
                
                <!-- Tweet Actions -->
                <div class="tweet-actions">
                    {% if article.tweet_url %}
                    <button class="tweet-action-btn" onclick="window.open('{{ article.tweet_url }}', '_blank')">
                        <i class="fab fa-twitter"></i>
                        <span>Tweet'i Görüntüle</span>
                    </button>
                    {% endif %}
                    <button class="tweet-action-btn" onclick="window.open('{{ article.url if article.url else '#' }}', '_blank')" {{ 'disabled' if not article.url else '' }}>
                        <i class="fas fa-external-link-alt"></i>
                        <span>{% if article.source_type == 'github' or article.type == 'github_repo' %}Repo'yu Görüntüle{% else %}Makaleyi Oku{% endif %}</span>
                    </button>
                    <button class="tweet-action-btn tweet-action-archive" onclick="restoreDeletedTweet('{{ loop.index0 }}')">
                        <i class="fas fa-archive"></i>
                        <span>Arşivle</span>
                    </button>
                </div>
            </div>
        </div>
        {% endif %}
        {% endfor %}
    </div>
    
    <!-- Sayfalama -->
    <div class="pagination-container">
        <nav class="pagination">
            <button class="pagination-btn pagination-prev">
                <i class="fas fa-chevron-left"></i>
                Önceki
            </button>
            <button class="pagination-btn pagination-active">1</button>
            <button class="pagination-btn">2</button>
            <button class="pagination-btn pagination-next">
                Sonraki
                <i class="fas fa-chevron-right"></i>
            </button>
        </nav>
    </div>
    {% else %}
    <!-- Empty State -->
    <div class="tweet-card empty-state">
        <div class="empty-state-icon">
            <i class="fab fa-twitter"></i>
        </div>
        <h3 class="empty-state-title">Henüz Paylaşılan Tweet Yok</h3>
        <p class="empty-state-description">İlk tweetinizi paylaştığınızda burada görünecek. Tweet paylaşmaya başlamak için ana sayfaya gidin.</p>
        <a href="{{ url_for('index') }}" class="twitter-btn twitter-btn-primary">
            <i class="fas fa-plus"></i>
            <span>Tweet Paylaş</span>
        </a>
    </div>
    {% endif %}
</div>

<!-- JavaScript -->
<script>
// Toast notification system
function showToast(message, type = 'info') {
    // Create toast container if it doesn't exist
    let toastContainer = document.getElementById('toast-container');
    if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.id = 'toast-container';
        toastContainer.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            max-width: 400px;
        `;
        document.body.appendChild(toastContainer);
    }

    // Create toast element
    const toast = document.createElement('div');
    const icon = getToastIcon(type);
    const title = getToastTitle(type);
    
    toast.className = `toast toast-${type}`;
    toast.style.cssText = `
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 10px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        display: flex;
        align-items: flex-start;
        gap: 12px;
        animation: slideIn 0.3s ease-out;
        max-width: 400px;
    `;
    
    toast.innerHTML = `
        <div style="flex-shrink: 0; font-size: 20px;">${icon}</div>
        <div style="flex: 1;">
            <div style="font-weight: 600; margin-bottom: 4px; color: #374151;">${title}</div>
            <div style="color: #6b7280; font-size: 14px;">${message}</div>
        </div>
        <button onclick="this.parentElement.remove()" style="
            background: none;
            border: none;
            color: #9ca3af;
            cursor: pointer;
            font-size: 18px;
            padding: 0;
            margin-left: 8px;
        ">&times;</button>
    `;
    
    toastContainer.appendChild(toast);
    
    // Auto remove after 5 seconds
    setTimeout(() => {
        if (toast.parentElement) {
            toast.style.animation = 'slideOut 0.3s ease-in';
            setTimeout(() => toast.remove(), 300);
        }
    }, 5000);
}

// Confirm dialog system
function showConfirmDialog(title, message, onConfirm, onCancel = null) {
    // Create modal container
    const modalContainer = document.createElement('div');
    modalContainer.id = 'confirm-dialog';
    modalContainer.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        animation: fadeIn 0.3s ease-out;
    `;
    
    // Create modal content
    const modalContent = document.createElement('div');
    modalContent.style.cssText = `
        background: white;
        border-radius: 16px;
        padding: 32px;
        max-width: 400px;
        width: 90%;
        text-align: center;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        animation: slideIn 0.3s ease-out;
    `;
    
    // Add CSS animations
    const style = document.createElement('style');
    style.textContent = `
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes slideIn {
            from { transform: translateY(-20px) scale(0.95); opacity: 0; }
            to { transform: translateY(0) scale(1); opacity: 1; }
        }
    `;
    document.head.appendChild(style);
    
    modalContent.innerHTML = `
        <div style="margin-bottom: 24px;">
            <div style="width: 64px; height: 64px; margin: 0 auto 16px; background: #fef3c7; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                <i class="fas fa-exclamation-triangle" style="font-size: 28px; color: #f59e0b;"></i>
            </div>
            <h3 style="font-size: 20px; font-weight: 700; color: #111827; margin-bottom: 8px;">${title}</h3>
            <p style="color: #6b7280; font-size: 16px; line-height: 1.5;">${message}</p>
        </div>
        <div style="display: flex; gap: 12px; justify-content: center;">
            <button id="confirm-cancel" style="
                padding: 12px 24px;
                border: 1px solid #d1d5db;
                border-radius: 8px;
                background: white;
                color: #374151;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.2s ease;
            ">İptal</button>
            <button id="confirm-ok" style="
                padding: 12px 24px;
                border: none;
                border-radius: 8px;
                background: #e0245e;
                color: white;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.2s ease;
            ">Arşivle</button>
        </div>
    `;
    
    modalContainer.appendChild(modalContent);
    document.body.appendChild(modalContainer);
    
    // Add event listeners
    const cancelBtn = modalContainer.querySelector('#confirm-cancel');
    const confirmBtn = modalContainer.querySelector('#confirm-ok');
    
    cancelBtn.addEventListener('click', () => {
        modalContainer.remove();
        if (onCancel) onCancel();
    });
    
    confirmBtn.addEventListener('click', () => {
        modalContainer.remove();
        if (onConfirm) onConfirm();
    });
    
    // Close on overlay click
    modalContainer.addEventListener('click', (e) => {
        if (e.target === modalContainer) {
            modalContainer.remove();
            if (onCancel) onCancel();
        }
    });
}

function getToastIcon(type) {
    const icons = {
        success: '✅',
        error: '❌',
        warning: '⚠️',
        info: 'ℹ️'
    };
    return icons[type] || icons.info;
}

function getToastTitle(type) {
    const titles = {
        success: 'Başarılı',
        error: 'Hata',
        warning: 'Uyarı',
        info: 'Bilgi'
    };
    return titles[type] || titles.info;
}

// Add CSS animations
const style = document.createElement('style');
style.textContent = `
    @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    @keyframes slideOut {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
    }
`;
document.head.appendChild(style);

// Arama ve filtreleme
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('searchInput');
    const sourceFilter = document.getElementById('sourceFilter');
    const dateFilter = document.getElementById('dateFilter');
    const tweetsContainer = document.getElementById('tweetsContainer');
    const totalCount = document.getElementById('totalCount');
    
    function filterTweets() {
        const searchTerm = searchInput.value.toLowerCase();
        const sourceType = sourceFilter.value;
        const dateRange = dateFilter.value;
        const tweetItems = tweetsContainer.querySelectorAll('.tweet-card');
        
        let visibleCount = 0;
        const today = new Date();
        
        tweetItems.forEach(item => {
            const title = item.dataset.title || '';
            const content = item.dataset.content || '';
            const source = item.dataset.source || '';
            const isManual = item.dataset.manual === 'true';
            const dateStr = item.dataset.date || '';
            
            // Arama filtresi
            const matchesSearch = !searchTerm || 
                title.includes(searchTerm) || 
                content.includes(searchTerm);
            
            // Kaynak filtresi
            let matchesSource = true;
            if (sourceType === 'github') {
                matchesSource = source === 'github';
            } else if (sourceType === 'news') {
                matchesSource = source === 'news';
            } else if (sourceType === 'manual') {
                matchesSource = isManual;
            }
            
            // Tarih filtresi
            let matchesDate = true;
            if (dateRange && dateStr) {
                const tweetDate = new Date(dateStr);
                const diffTime = Math.abs(today - tweetDate);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                
                if (dateRange === 'today') {
                    matchesDate = diffDays <= 1;
                } else if (dateRange === 'week') {
                    matchesDate = diffDays <= 7;
                } else if (dateRange === 'month') {
                    matchesDate = diffDays <= 30;
                }
            }
            
            if (matchesSearch && matchesSource && matchesDate) {
                item.style.display = '';
                visibleCount++;
            } else {
                item.style.display = 'none';
            }
        });
        
        totalCount.textContent = visibleCount;
    }
    
    // Event listeners
    searchInput.addEventListener('input', filterTweets);
    sourceFilter.addEventListener('change', filterTweets);
    dateFilter.addEventListener('change', filterTweets);
    
    // Debug: Tweet sayısını kontrol et
    console.log('Toplam tweet sayısı:', tweetItems.length);
    console.log('Tweet ID\'leri:', Array.from(tweetItems).map(item => item.dataset.tweetId));
});

// Tweet arşivleme fonksiyonu
function restoreDeletedTweet(index) {
    showConfirmDialog(
        'Tweet Arşivle',
        'Bu tweeti arşivlemek istediğinizden emin misiniz? Arşivlenen tweetler silinmez, sadece bu sayfadan gizlenir.',
        () => {
            // Arşivleme işlemi
            archiveTweet(index);
        }
    );
}

// Tweet arşivleme API çağrısı
function archiveTweet(index) {
    showToast('Tweet arşivleniyor...', 'info');
    
    // Tweet ID'sini al
    const tweetCard = document.querySelector(`[data-index="${index}"]`);
    if (!tweetCard) {
        showToast('Tweet bulunamadı!', 'error');
        return;
    }
    
    const tweetId = tweetCard.dataset.tweetId || index;
    
    // API çağrısı
    fetch('/api/archive_tweet', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            tweet_id: tweetId,
            archive_reason: 'manual'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('Tweet başarıyla arşivlendi!', 'success');
            // Tweet'i gizle
            tweetCard.style.display = 'none';
            // Toplam sayıyı güncelle
            updateTotalCount();
        } else {
            showToast('Arşivleme hatası: ' + data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Arşivleme hatası:', error);
        showToast('Bir hata oluştu: ' + error.message, 'error');
    });
}

// Toplam sayıyı güncelle
function updateTotalCount() {
    const visibleTweets = document.querySelectorAll('.tweet-card[style*="display: none"]').length;
    const totalTweets = document.querySelectorAll('.tweet-card').length;
    const visibleCount = totalTweets - visibleTweets;
    
    const totalCountElement = document.getElementById('totalCount');
    if (totalCountElement) {
        totalCountElement.textContent = visibleCount;
    }
}

// Toplu işlem fonksiyonları
function toggleSelectAll() {
    const selectAllCheckbox = document.getElementById('selectAllCheckbox');
    const tweetCheckboxes = document.querySelectorAll('.tweet-select-checkbox');
    
    if (!selectAllCheckbox || !tweetCheckboxes.length) return;
    
    const isChecked = selectAllCheckbox.checked;
    tweetCheckboxes.forEach(checkbox => {
        checkbox.checked = isChecked;
    });
    
    updateBulkButtons();
}

function updateBulkButtons() {
    const tweetCheckboxes = document.querySelectorAll('.tweet-select-checkbox');
    const selectedCheckboxes = document.querySelectorAll('.tweet-select-checkbox:checked');
    const bulkArchiveAllBtn = document.getElementById('bulkArchiveAllBtn');
    const bulkCount = document.getElementById('bulkCount');
    const selectedCount = document.getElementById('selectedCount');
    const selectAllCheckbox = document.getElementById('selectAllCheckbox');
    
    const selectedCountValue = selectedCheckboxes.length;
    
    // Tümünü seç checkbox'ını güncelle
    if (selectAllCheckbox) {
        selectAllCheckbox.checked = selectedCountValue === tweetCheckboxes.length && tweetCheckboxes.length > 0;
        selectAllCheckbox.indeterminate = selectedCountValue > 0 && selectedCountValue < tweetCheckboxes.length;
    }
    
    // Toplu arşivle butonunu göster/gizle
    if (bulkArchiveAllBtn) {
        if (selectedCountValue > 0) {
            bulkArchiveAllBtn.style.display = 'inline-flex';
            bulkArchiveAllBtn.innerHTML = `<i class="fas fa-archive"></i> ${selectedCountValue} Tweet Arşivle`;
        } else {
            bulkArchiveAllBtn.style.display = 'none';
        }
    }
    
    // Seçim sayısını göster/gizle
    if (bulkCount && selectedCount) {
        if (selectedCountValue > 0) {
            bulkCount.style.display = 'inline';
            selectedCount.textContent = selectedCountValue;
        } else {
            bulkCount.style.display = 'none';
        }
    }
}

function bulkArchiveAll() {
    const selectedCheckboxes = document.querySelectorAll('.tweet-select-checkbox:checked');
    const selectedCount = selectedCheckboxes.length;
    
    if (selectedCount === 0) {
        showToast('Lütfen arşivlenecek tweet\'leri seçin!', 'warning');
        return;
    }
    
    showConfirmDialog(
        'Toplu Arşivleme',
        `${selectedCount} tweet'i arşivlemek istediğinizden emin misiniz? Bu işlem geri alınabilir.`,
        () => {
            // Seçili tweet'leri arşivle
            const selectedTweets = [];
            selectedCheckboxes.forEach(checkbox => {
                const tweetCard = checkbox.closest('.tweet-card');
                if (tweetCard) {
                    const tweetId = tweetCard.dataset.tweetId;
                    if (tweetId) {
                        selectedTweets.push(tweetId);
                    }
                }
            });
            
            if (selectedTweets.length === 0) {
                showToast('Arşivlenecek tweet bulunamadı!', 'error');
                return;
            }
            
            // Toplu arşivleme API çağrısı
            bulkArchiveTweetsOptimized(selectedTweets);
        }
    );
}

function bulkArchiveTweets(tweetIds) {
    showToast(`${tweetIds.length} tweet arşivleniyor...`, 'info');
    
    // Batch işleme için ayarlar
    const BATCH_SIZE = 10; // Her seferde 10 tweet işle
    const DELAY_BETWEEN_BATCHES = 500; // 500ms bekle
    
    let completedCount = 0;
    let errorCount = 0;
    let currentBatch = 0;
    
    function processBatch() {
        const startIndex = currentBatch * BATCH_SIZE;
        const endIndex = Math.min(startIndex + BATCH_SIZE, tweetIds.length);
        const currentBatchIds = tweetIds.slice(startIndex, endIndex);
        
        if (currentBatchIds.length === 0) {
            // Tüm batch'ler tamamlandı
            if (errorCount === 0) {
                showToast(`${completedCount} tweet başarıyla arşivlendi!`, 'success');
            } else {
                showToast(`${completedCount} tweet arşivlendi, ${errorCount} tweet arşivlenemedi!`, 'warning');
            }
            
            // Toplam sayıyı güncelle
            updateTotalCount();
            // Toplu işlem butonlarını sıfırla
            updateBulkButtons();
            return;
        }
        
        // Progress güncelle
        const progress = Math.round(((completedCount + errorCount) / tweetIds.length) * 100);
        showToast(`${tweetIds.length} tweet arşivleniyor... ${progress}% tamamlandı`, 'info');
        
        // Bu batch'teki tweet'leri işle
        let batchCompleted = 0;
        let batchErrors = 0;
        
        currentBatchIds.forEach((tweetId, batchIndex) => {
            fetch('/api/archive_tweet', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    tweet_id: tweetId,
                    archive_reason: 'bulk_archive'
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    completedCount++;
                    // Tweet'i gizle
                    const tweetCard = document.querySelector(`[data-tweet-id="${tweetId}"]`);
                    if (tweetCard) {
                        tweetCard.style.display = 'none';
                    }
                } else {
                    errorCount++;
                    batchErrors++;
                }
                
                batchCompleted++;
                
                // Bu batch tamamlandı mı?
                if (batchCompleted === currentBatchIds.length) {
                    // Sonraki batch'e geç
                    currentBatch++;
                    setTimeout(processBatch, DELAY_BETWEEN_BATCHES);
                }
            })
            .catch(error => {
                errorCount++;
                batchErrors++;
                console.error('Arşivleme hatası:', error);
                
                batchCompleted++;
                
                // Bu batch tamamlandı mı?
                if (batchCompleted === currentBatchIds.length) {
                    // Sonraki batch'e geç
                    currentBatch++;
                    setTimeout(processBatch, DELAY_BETWEEN_BATCHES);
                }
            });
        });
    }
    
    // İlk batch'i başlat
    processBatch();
}

// Optimize edilmiş toplu arşivleme fonksiyonu
function bulkArchiveTweetsOptimized(tweetIds) {
    showToast(`${tweetIds.length} tweet arşivleniyor...`, 'info');
    
    // Tek seferde tüm tweet'leri arşivle
    fetch('/api/bulk_archive_tweets', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            tweet_ids: tweetIds,
            archive_reason: 'bulk_archive'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast(`${data.archived_count} tweet başarıyla arşivlendi!`, 'success');
            
            // Arşivlenen tweet'leri gizle
            tweetIds.forEach(tweetId => {
                const tweetCard = document.querySelector(`[data-tweet-id="${tweetId}"]`);
                if (tweetCard) {
                    tweetCard.style.display = 'none';
                }
            });
            
            // Toplam sayıyı güncelle
            updateTotalCount();
            // Toplu işlem butonlarını sıfırla
            updateBulkButtons();
        } else {
            showToast('Arşivleme hatası: ' + data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Toplu arşivleme hatası:', error);
        showToast('Bir hata oluştu: ' + error.message, 'error');
    });
}
</script>
{% endblock %}